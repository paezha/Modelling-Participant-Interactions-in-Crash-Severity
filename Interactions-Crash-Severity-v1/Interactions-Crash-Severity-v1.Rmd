---
title: An assessment of strategies to model opponent effects in crash severity analysis
author:
  - name: Author 1
    email: a1@example.com
    affiliation: Some University
    footnote: Corresponding Author
  - name: Author 2
    email: a2@example.com
    affiliation: Some Institute of Technology
address:
  - code: Some University
    address: Department, Street, City, State, Zip
  - code: Some Institute of Technology
    address: Department, Street, City, State, Zip
abstract: |
  Road accidents impose an important burden on health and the economy. Numerous efforts to understand the factors that affect road collisions have been undertaken. One stream of research focus on modelling the severity of crashes. Crash severity research is useful to clarify the way different factors can influence the outcome of the event. The objective of this paper is to assess different strategies to model the interactions between participants in a crash, in the context of crashes involving two parties. Towards this objective, a series of models are estimated using data from Canada's National Collision Database. Three levels of crash severity (no injury/injury/fatality) are analyzed using ordered logit models and covariates for the participants in the crash and the conditions of the crash. Modelling strategies include different ways of introducing the covariates (e.g., in a single-level or multi-level form), as well as by subsetting the dataset. The models are assessed using predicted shares and outcomes, and the results highlight the importance of considering opponent effects in crash severity analysis. On the other hand, the study suggests that hierarchical (i.e., multi-level) specifications and subsetting do not perform necessarily better than a relatively simple single-level model with opponent effects.

journal: "Some Journal"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
#linenumbers: true
numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article

header-includes:
   - \usepackage[margin=1in]{geometry}
---

<!-- 
_Text based on elsarticle sample manuscript, see [http://www.elsevier.com/author-schemas/latex-instructions#elsarticle](http://www.elsevier.com/author-schemas/latex-instructions#elsarticle)_

This paper is an R markdown document that includes self-contained, reproducible analysis. To reproduce the paper the following files are needed:

1. Interactions-Crash-Severity-v1.Rmd (this R markdown document)

2. `paired_collisions_2017.RData`. For reference: this data file was created using R notebook `00-Data-Preprocessing-2017.Rmd`. Initial model estimation was done in R notebook `01-Data-Analysis.Rmd. Neither of these two notebooks are needed for this document. 

3. `paired_collisions_2016.RData`. For reference: this data file was created using R notebook `00-Data-Preprocessing-2016.Rmd`. Initial model assessment was done in R notebook `02-Model-Assessment.Rmd. Neither of these two notebooks are needed for this document. 

3. For compiling into a pdf in the style of an Elsevier document: elsarticle.cls, elsevier-harvard.csl, elsevier-harvard-without-titles.csl, elsevier-vancouver.csl, elsevier-without-titles.cls, elsevier-with-titles.csl, elsevier-with-titles-alphabetical.csl, mybibfile.bib
-->

```{r load-packages, include=FALSE}
# Load the packages used in this notebook:
library(kableExtra)
library(latex2exp)
library(MASS)
library(readxl)
library(tidyverse)
library(verification)
```

```{r source-code-for-ordinal-model, include=FALSE}

# Fixed version of polr that provides better starting values; see here: https://r.789695.n4.nabble.com/bugs-and-misfeatures-in-polr-MASS-fixed-td3024677.html#a3030405

# file MASS/R/polr.R
# copyright (C) 1994-2008 W. N. Venables and B. D. Ripley
# Use of transformed intercepts contributed by David Firth
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 or 3 of the License
#  (at your option).
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  A copy of the GNU General Public License is available at
#  http://www.r-project.org/Licenses/
#
polr <- function(formula, data, weights, start, ..., subset,
                 na.action, contrasts = NULL, Hess = FALSE,
                 model = TRUE,
                 method = c("logistic", "probit", "cloglog", "cauchit"))
{
    logit <- function(p) log(p/(1 - p))

    fmin <- function(beta) {
        theta <- beta[pc + 1L:q]
        gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
        eta <- offset
        if (pc > 0)
            eta <- eta + drop(x %*% beta[1L:pc])
        pr <- pfun(gamm[y + 1] - eta) - pfun(gamm[y] - eta)
        if (all(pr > 0))
            -sum(wt * log(pr))
        else Inf
    }

    gmin <- function(beta)
    {
        jacobian <- function(theta) { ## dgamma by dtheta matrix
            k <- length(theta)
            etheta <- exp(theta)
            mat <- matrix(0 , k, k)
            mat[, 1] <- rep(1, k)
            for (i in 2:k) mat[i:k, i] <- etheta[i]
            mat
        }
        theta <- beta[pc + 1L:q]
        gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
        eta <- offset
        if(pc > 0) eta <- eta + drop(x %*% beta[1L:pc])
        pr <- pfun(gamm[y+1] - eta) - pfun(gamm[y] - eta)
        p1 <- dfun(gamm[y+1] - eta)
        p2 <- dfun(gamm[y] - eta)
        g1 <- if(pc > 0) t(x) %*% (wt*(p1 - p2)/pr) else numeric(0)
        xx <- .polrY1*p1 - .polrY2*p2
        g2 <- - t(xx) %*% (wt/pr)
        g2 <- t(g2) %*% jacobian(theta)
        if(all(pr > 0)) c(g1, g2) else rep(NA, pc+q)
    }

    m <- match.call(expand.dots = FALSE)
    method <- match.arg(method)
    pfun <- switch(method, logistic = plogis, probit = pnorm,
                   cloglog = pgumbel, cauchit = pcauchy)
    dfun <- switch(method, logistic = dlogis, probit = dnorm,
                   cloglog = dgumbel, cauchit = dcauchy)
    if(is.matrix(eval.parent(m$data)))
        m$data <- as.data.frame(data)
    m$start <- m$Hess <- m$method <- m$model <- m$... <- NULL
    m[[1L]] <- as.name("model.frame")
    m <- eval.parent(m)
    Terms <- attr(m, "terms")
    x <- model.matrix(Terms, m, contrasts)
    xint <- match("(Intercept)", colnames(x), nomatch=0L)
    n <- nrow(x)
    pc <- ncol(x)
    cons <- attr(x, "contrasts") # will get dropped by subsetting
    if(xint > 0) {
        x <- x[, -xint, drop=FALSE]
        pc <- pc - 1
    } else warning("an intercept is needed and assumed")
    wt <- model.weights(m)
    if(!length(wt)) wt <- rep(1, n)
    offset <- model.offset(m)
    if(length(offset) <= 1) offset <- rep(0, n)
    y <- model.response(m)
    if(!is.factor(y)) stop("response must be a factor")
    lev <- levels(y)
    if(length(lev) <= 2) stop("response must have 3 or more levels")
    y <- unclass(y)
    q <- length(lev) - 1
    Y <- matrix(0, n, q)
    .polrY1 <- col(Y) == y
    .polrY2 <- col(Y) == y - 1
    if(missing(start)) {
      # try something that should always work -tjb
      u <- as.integer(table(y))
      u <- (cumsum(u)/sum(u))[1:q]
      zetas <-
         switch(method,
                "logistic"= qlogis(u),
                "probit"=   qnorm(u),
                "cauchit"=  qcauchy(u),
                "cloglog"=  -log(-log(u)) )
      s0 <- c(rep(0,pc),zetas[1],log(diff(zetas)))

##         # try logistic/probit regression on 'middle' cut
##         q1 <- length(lev) %/% 2
##         y1 <- (y > q1)
##         X <- cbind(Intercept = rep(1, n), x)
##         fit <-
##             switch(method,
##                    "logistic"= glm.fit(X, y1, wt, family = binomial(), offset = offset),
##                    "probit" = glm.fit(X, y1, wt, family = binomial("probit"), offset = offset),
##                    ## this is deliberate, a better starting point
##                    "cloglog" = glm.fit(X, y1, wt, family = binomial("probit"), offset = offset),
##                    "cauchit" = glm.fit(X, y1, wt, family = binomial("cauchit"), offset = offset))
##         if(!fit$converged)
##             stop("attempt to find suitable starting values failed")
##         coefs <- fit$coefficients
##         if(any(is.na(coefs))) {
##             warning("design appears to be rank-deficient, so dropping some coefs")
##             keep <- names(coefs)[!is.na(coefs)]
##             coefs <- coefs[keep]
##             x <- x[, keep[-1L], drop = FALSE]
##             pc <- ncol(x)
##           }
##         spacing <- logit((1L:q)/(q+1)) # just a guess
##         if(method != "logistic") spacing <- spacing/1.7
##         gammas <- -coefs[1L] + spacing - spacing[q1]
##         thetas <- c(gammas[1L], log(diff(gammas)))
##         s0 <- c(coefs[-1L], thetas)
    } else if(length(start) != pc + q)
	stop("'start' is not of the correct length")
    else {
        s0 <- if(pc > 0) c(start[seq_len(pc+1)], log(diff(start[-seq_len(pc)])))
        else c(start[1L], log(diff(start)))
      }
    res <- optim(s0, fmin, gmin, method="BFGS", hessian = Hess, ...)
    beta <- res$par[seq_len(pc)]
    theta <- res$par[pc + 1L:q]
    zeta <- cumsum(c(theta[1L],exp(theta[-1L])))
    deviance <- 2 * res$value
    niter <- c(f.evals=res$counts[1L], g.evals=res$counts[2L])
    names(zeta) <- paste(lev[-length(lev)], lev[-1L], sep="|")
    if(pc > 0) {
        names(beta) <- colnames(x)
        eta <- offset + drop(x %*% beta)
    } else eta <- offset + rep(0, n)

    cumpr <- matrix(pfun(matrix(zeta, n, q, byrow=TRUE) - eta), , q)
    fitted <- t(apply(cumpr, 1L, function(x) diff(c(0, x, 1))))
    dimnames(fitted) <- list(row.names(m), lev)
    fit <- list(coefficients = beta, zeta = zeta, deviance = deviance,
                fitted.values = fitted, lev = lev, terms = Terms,
                df.residual = sum(wt) - pc - q, edf = pc + q, n = sum(wt),
                nobs = sum(wt),
                call = match.call(), method = method,
		convergence = res$convergence, niter = niter, lp = eta)
    if(Hess) {
        dn <- c(names(beta), names(zeta))
        H <- res$hessian
        dimnames(H) <- list(dn, dn)
        fit$Hessian <- H
    }
    if(model) fit$model <- m
    fit$na.action <- attr(m, "na.action")
    fit$contrasts <- cons
    fit$xlevels <- .getXlevels(Terms, m)
    class(fit) <- "polr"
    fit
}

print.polr <- function(x, ...)
{
    if(!is.null(cl <- x$call)) {
        cat("Call:\n")
        dput(cl, control=NULL)
    }
    if(length(coef(x))) {
        cat("\nCoefficients:\n")
        print(coef(x), ...)
    } else {
        cat("\nNo coefficients\n")
    }
    cat("\nIntercepts:\n")
    print(x$zeta, ...)
    cat("\nResidual Deviance:", format(x$deviance, nsmall=2), "\n")
    cat("AIC:", format(x$deviance + 2*x$edf, nsmall=2), "\n")
    if(nzchar(mess <- naprint(x$na.action))) cat("(", mess, ")\n", sep="")
    if(x$convergence > 0)
        cat("Warning: did not converge as iteration limit reached\n")
    invisible(x)
}

vcov.polr <- function(object, ...)
{
    jacobian <- function(theta) { ## dgamma by dtheta matrix
        k <- length(theta)
        etheta <- exp(theta)
        mat <- matrix(0 , k, k)
        mat[, 1] <- rep(1, k)
        for (i in 2:k) mat[i:k, i] <- etheta[i]
        mat
    }

    if(is.null(object$Hessian)) {
        message("\nRe-fitting to get Hessian\n")
	utils::flush.console()
        object <- update(object, Hess=TRUE,
                         start=c(object$coefficients, object$zeta))
    }
    vc <- ginv(object$Hessian)
    pc <- length(coef(object))
    gamma <- object$zeta
    z.ind <- pc + seq_along(gamma)
    theta <- c(gamma[1L], log(diff(gamma)))
    J <- jacobian(theta)
    A <- diag(pc + length(gamma))
    A[z.ind, z.ind] <- J
    V <- A %*% vc %*% t(A)
    structure(V,  dimnames = dimnames(object$Hessian))
}

summary.polr <- function(object, digits = max(3, .Options$digits - 3),
                         correlation = FALSE, ...)
{
    cc <- c(coef(object), object$zeta)
    pc <- length(coef(object))
    q <- length(object$zeta)
    coef <- matrix(0, pc+q, 3, dimnames=list(names(cc),
                               c("Value", "Std. Error", "t value")))
    coef[, 1] <- cc
    vc <- vcov(object)
    coef[, 2] <- sd <- sqrt(diag(vc))
    coef[, 3] <- coef[, 1]/coef[, 2]
    object$coefficients <- coef
    object$pc <- pc
    object$digits <- digits
    if(correlation)
        object$correlation <- (vc/sd)/rep(sd, rep(pc+q, pc+q))
    class(object) <- "summary.polr"
    object
}

print.summary.polr <- function(x, digits = x$digits, ...)
{
    if(!is.null(cl <- x$call)) {
        cat("Call:\n")
        dput(cl, control=NULL)
    }
    coef <- format(round(x$coefficients, digits=digits))
    pc <- x$pc
    if(pc > 0) {
        cat("\nCoefficients:\n")
        print(x$coefficients[seq_len(pc), , drop=FALSE], quote = FALSE,
              digits = digits, ...)
    } else {
        cat("\nNo coefficients\n")
    }
    cat("\nIntercepts:\n")
    print(coef[(pc+1):nrow(coef), , drop=FALSE], quote = FALSE,
          digits = digits, ...)
    cat("\nResidual Deviance:", format(x$deviance, nsmall=2), "\n")
    cat("AIC:", format(x$deviance + 2*x$edf, nsmall=2), "\n")
    if(nzchar(mess <- naprint(x$na.action))) cat("(", mess, ")\n", sep="")
    if(!is.null(correl <- x$correlation)) {
        cat("\nCorrelation of Coefficients:\n")
        ll <- lower.tri(correl)
        correl[ll] <- format(round(correl[ll], digits))
        correl[!ll] <- ""
        print(correl[-1, -ncol(correl)], quote = FALSE, ...)
    }
    invisible(x)
}

predict.polr <- function(object, newdata, type=c("class","probs"), ...)
{
    if(!inherits(object, "polr")) stop("not a \"polr\" object")
    type <- match.arg(type)
    if(missing(newdata)) Y <- object$fitted
    else {
        newdata <- as.data.frame(newdata)
        Terms <- delete.response(object$terms)
        m <- model.frame(Terms, newdata, na.action = function(x) x,
                         xlev = object$xlevels)
        if (!is.null(cl <- attr(Terms, "dataClasses")))
            .checkMFClasses(cl, m)
        X <- model.matrix(Terms, m, contrasts = object$contrasts)
        xint <- match("(Intercept)", colnames(X), nomatch=0L)
        if(xint > 0) X <- X[, -xint, drop=FALSE]
        n <- nrow(X)
        q <- length(object$zeta)
        eta <- drop(X %*% object$coefficients)
        pfun <- switch(object$method, logistic = plogis, probit = pnorm,
                       cloglog = pgumbel, cauchit = pcauchy)
        cumpr <- matrix(pfun(matrix(object$zeta, n, q, byrow=TRUE) - eta), , q)
        Y <- t(apply(cumpr, 1L, function(x) diff(c(0, x, 1))))
        dimnames(Y) <- list(rownames(X), object$lev)
    }
    if(missing(newdata) && !is.null(object$na.action))
        Y <- napredict(object$na.action, Y)
    switch(type, class = {
        Y <- factor(max.col(Y), levels=seq_along(object$lev),
                    labels=object$lev)
    }, probs = {})
    drop(Y)
}

extractAIC.polr <- function(fit, scale = 0, k = 2, ...)
{
    edf <- fit$edf
    c(edf, deviance(fit) + k * edf)
}

model.frame.polr <- function(formula, ...)
{
    dots <- list(...)
    nargs <- dots[match(c("data", "na.action", "subset"), names(dots), 0)]
    if(length(nargs) || is.null(formula$model)) {
        m <- formula$call
        m$start <- m$Hess <- m$... <- NULL
        m[[1L]] <- as.name("model.frame")
        m[names(nargs)] <- nargs
        if (is.null(env <- environment(formula$terms))) env <- parent.frame()
        data <- eval(m, env)
        if(!is.null(mw <- m$weights)) {
            nm <- names(data)
            nm[match("(weights)", nm)] <- as.character(mw)
            names(data) <- nm
        }
        data
    } else formula$model
}

pgumbel <- function(q, loc = 0, scale = 1, lower.tail = TRUE)
{
    q <- (q - loc)/scale
    p <- exp(-exp(-q))
    if (!lower.tail) 1 - p else p
}

dgumbel <- function (x, loc = 0, scale = 1, log = FALSE)
{
    x <- (x - loc)/scale
    d <- log(1/scale) - x - exp(-x)
    d[is.nan(d)] <- -Inf                # -tjb
    if (!log) exp(d) else d
}

anova.polr <- function (object, ..., test = c("Chisq", "none"))
{
    test <- match.arg(test)
    dots <- list(...)
    if (length(dots) == 0L)
        stop('anova is not implemented for a single "polr" object')
    mlist <- list(object, ...)
    nt <- length(mlist)
    dflis <- sapply(mlist, function(x) x$df.residual)
    s <- order(dflis, decreasing = TRUE)
    mlist <- mlist[s]
    if (any(!sapply(mlist, inherits, "polr")))
        stop('not all objects are of class "polr"')
    ns <- sapply(mlist, function(x) length(x$fitted.values))
    if(any(ns != ns[1L]))
        stop("models were not all fitted to the same size of dataset")
    rsp <- unique(sapply(mlist, function(x) paste(formula(x)[2L])))
    mds <- sapply(mlist, function(x) paste(formula(x)[3L]))
    dfs <- dflis[s]
    lls <- sapply(mlist, function(x) deviance(x))
    tss <- c("", paste(1L:(nt - 1), 2:nt, sep = " vs "))
    df <- c(NA, -diff(dfs))
    x2 <- c(NA, -diff(lls))
    pr <- c(NA, 1 - pchisq(x2[-1L], df[-1L]))
    out <- data.frame(Model = mds, Resid.df = dfs, Deviance = lls,
                      Test = tss, Df = df, LRtest = x2, Prob = pr)
    names(out) <- c("Model", "Resid. df", "Resid. Dev", "Test",
                    "   Df", "LR stat.", "Pr(Chi)")
    if (test == "none") out <- out[, 1L:6]
    class(out) <- c("Anova", "data.frame")
    attr(out, "heading") <-
        c("Likelihood ratio tests of ordinal regression models\n",
          paste("Response:", rsp))
    out
}

polr.fit <- function(x, y, wt, start, offset, method)
{
    logit <- function(p) log(p/(1 - p))

    fmin <- function(beta) {
        theta <- beta[pc + 1L:q]
        gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
        eta <- offset
        if (pc > 0)
            eta <- eta + drop(x %*% beta[1L:pc])
        pr <- pfun(gamm[y + 1] - eta) - pfun(gamm[y] - eta)
        if (all(pr > 0))
            -sum(wt * log(pr))
        else Inf
    }

    gmin <- function(beta)
    {
        jacobian <- function(theta) { ## dgamma by dtheta matrix
            k <- length(theta)
            etheta <- exp(theta)
            mat <- matrix(0 , k, k)
            mat[, 1] <- rep(1, k)
            for (i in 2:k) mat[i:k, i] <- etheta[i]
            mat
        }
        theta <- beta[pc + 1L:q]
        gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
        eta <- offset
        if(pc > 0) eta <- eta + drop(x %*% beta[1L:pc])
        pr <- pfun(gamm[y+1] - eta) - pfun(gamm[y] - eta)
        p1 <- dfun(gamm[y+1] - eta)
        p2 <- dfun(gamm[y] - eta)
        g1 <- if(pc > 0) t(x) %*% (wt*(p1 - p2)/pr) else numeric(0)
        xx <- .polrY1*p1 - .polrY2*p2
        g2 <- - t(xx) %*% (wt/pr)
        g2 <- t(g2) %*% jacobian(theta)
        if(all(pr > 0)) c(g1, g2) else rep(NA, pc+q)
    }

    pfun <- switch(method, logistic = plogis, probit = pnorm,
                   cloglog = pgumbel, cauchit = pcauchy)
    dfun <- switch(method, logistic = dlogis, probit = dnorm,
                   cloglog = dgumbel, cauchit = dcauchy)
    n <- nrow(x)
    pc <- ncol(x)
    lev <- levels(y)
    if(length(lev) <= 2L) stop("response must have 3 or more levels")
    y <- unclass(y)
    q <- length(lev) - 1L
    Y <- matrix(0, n, q)
    .polrY1 <- col(Y) == y
    .polrY2 <- col(Y) == y - 1L
    # pc could be 0.
    s0 <- if(pc > 0) c(start[seq_len(pc+1)], diff(start[-seq_len(pc)]))
    else c(start[1L], diff(start))
    res <- optim(s0, fmin, gmin, method="BFGS")
    beta <- res$par[seq_len(pc)]
    theta <- res$par[pc + 1L:q]
    zeta <- cumsum(c(theta[1L],exp(theta[-1L])))
    deviance <- 2 * res$value
    names(zeta) <- paste(lev[-length(lev)], lev[-1L], sep="|")
    if(pc > 0) {
        names(beta) <- colnames(x)
        eta <- drop(x %*% beta)
    } else {
        eta <- rep(0, n)
    }
    list(coefficients = beta, zeta = zeta, deviance = deviance)
}

profile.polr <- function(fitted, which = 1L:p, alpha = 0.01,
                         maxsteps = 10, del = zmax/5, trace = FALSE, ...)
{
    Pnames <- names(B0 <- coefficients(fitted))
    pv0 <- t(as.matrix(B0))
    p <- length(Pnames)
    if(is.character(which)) which <- match(which, Pnames)
    summ <- summary(fitted)
    std.err <- summ$coefficients[, "Std. Error"]
    mf <- model.frame(fitted)
    n <- length(Y <- model.response(mf))
    O <- model.offset(mf)
    if(!length(O)) O <- rep(0, n)
    W <- model.weights(mf)
    if(length(W) == 0L) W <- rep(1, n)
    OriginalDeviance <- deviance(fitted)
    X <- model.matrix(fitted)[, -1L, drop=FALSE] # drop intercept
    zmax <- sqrt(qchisq(1 - alpha, 1))
    profName <- "z"
    prof <- vector("list", length=length(which))
    names(prof) <- Pnames[which]
    start <- c(fitted$coefficients, fitted$zeta)
    for(i in which) {
        zi <- 0
        pvi <- pv0
        Xi <- X[,  - i, drop = FALSE]
        pi <- Pnames[i]
        for(sgn in c(-1, 1)) {
            if(trace) {
                message("\nParameter:", pi, c("down", "up")[(sgn + 1)/2 + 1])
                utils::flush.console()
            }
            step <- 0
            z <- 0
            ## LP is the linear predictor including offset.
            ## LP <- X %*% fitted$coef + O
            while((step <- step + 1) < maxsteps && abs(z) < zmax) {
                bi <- B0[i] + sgn * step * del * std.err[i]
                o <- O + X[, i] * bi
                fm <- polr.fit(x = Xi, y = Y, wt = W, start = start[-i],
                               offset = o, method = fitted$method)
                ri <- pv0
                ri[, names(coef(fm))] <- coef(fm)
                ri[, pi] <- bi
                pvi <- rbind(pvi, ri)
                zz <- fm$deviance - OriginalDeviance
                if(zz > - 1e-3) zz <- max(zz, 0)
                else stop("profiling has found a better solution, so original fit had not converged")
                z <- sgn * sqrt(zz)
                zi <- c(zi, z)
            }
        }
        si <- order(zi)
        prof[[pi]] <- structure(data.frame(zi[si]), names = profName)
        prof[[pi]]$par.vals <- pvi[si, ]
    }
    val <- structure(prof, original.fit = fitted, summary = summ)
    class(val) <- c("profile.polr", "profile")
    val
}

confint.polr <- function(object, parm, level = 0.95, trace = FALSE, ...)
{
    pnames <- names(coef(object))
    if(missing(parm)) parm <- seq_along(pnames)
    else if(is.character(parm))  parm <- match(parm, pnames, nomatch = 0L)
    message("Waiting for profiling to be done...")
    utils::flush.console()
    object <- profile(object, which = parm, alpha = (1. - level)/4.,
                      trace = trace)
    confint(object, parm=parm, level=level, trace=trace, ...)
}

confint.profile.polr <-
  function(object, parm = seq_along(pnames), level = 0.95, ...)
{
    of <- attr(object, "original.fit")
    pnames <- names(coef(of))
    if(is.character(parm))  parm <- match(parm, pnames, nomatch = 0L)
    a <- (1-level)/2
    a <- c(a, 1-a)
    pct <- paste(round(100*a, 1), "%")
    ci <- array(NA, dim = c(length(parm), 2L),
                dimnames = list(pnames[parm], pct))
    cutoff <- qnorm(a)
    for(pm in parm) {
        pro <- object[[ pnames[pm] ]]
        if(length(pnames) > 1L)
            sp <- spline(x = pro[, "par.vals"][, pm], y = pro[, 1])
        else sp <- spline(x = pro[, "par.vals"], y = pro[, 1])
        ci[pnames[pm], ] <- approx(sp$y, sp$x, xout = cutoff)$y
    }
    drop(ci)
}

logLik.polr <- function(object, ...)
    structure(-0.5 * object$deviance, df = object$edf, class = "logLik")

simulate.polr <- function(object, nsim = 1, seed = NULL, ...)
{
    if(!is.null(object$model) && any(model.weights(object$model) != 1))
        stop("weighted fits are not supported")

    rgumbel <- function(n, loc = 0, scale = 1) loc - scale*log(rexp(n))

    ## start the same way as simulate.lm
    if(!exists(".Random.seed", envir = .GlobalEnv, inherits = FALSE))
        runif(1)                     # initialize the RNG if necessary
    if(is.null(seed))
        RNGstate <- get(".Random.seed", envir = .GlobalEnv)
    else {
        R.seed <- get(".Random.seed", envir = .GlobalEnv)
	set.seed(seed)
        RNGstate <- structure(seed, kind = as.list(RNGkind()))
        on.exit(assign(".Random.seed", R.seed, envir = .GlobalEnv))
    }
    rfun <- switch(object$method, logistic = rlogis, probit = rnorm,
                   cloglog = rgumbel, cauchit = rcauchy)
    eta <- object$lp
    n <- length(eta)
    res <- cut(rfun(n*nsim, eta),
               c(-Inf, object$zeta, Inf),
               labels = colnames(fitted(object)),
               ordered_result = TRUE)
    val <- split(res, rep(seq_len(nsim), each=n))
    names(val) <- paste("sim", seq_len(nsim), sep="_")
    val <- as.data.frame(val)
    if (!is.null(nm <- rownames(fitted(object)))) row.names(val) <- nm
    attr(val, "seed") <- RNGstate
    val
}
```

```{r read-data-files, include=FALSE}
load("ncdb_2017_paired_records.RData")
load("ncdb_2016_paired_records.RData")
```

```{r data-preparation-1, include=FALSE}
# Change age to decades and calculate the square:
ncdb_2016_paired_records <- ncdb_2016_paired_records %>%
  mutate(P1_AGE = P1_AGE / 10, P1_AGE2 = P1_AGE ^2,
         P2_AGE = P2_AGE / 10, P2_AGE2 = P2_AGE ^2)

ncdb_2017_paired_records <- ncdb_2017_paired_records %>%
  mutate(P1_AGE = P1_AGE / 10, P1_AGE2 = P1_AGE ^2,
         P2_AGE = P2_AGE / 10, P2_AGE2 = P2_AGE ^2)
```

```{r data-preparation-2, include=FALSE}
# Create new factors to describe the user (P_USER) and vehicle type (V_TYPE). 

# For 2017:
ncdb_2017_paired_records <- ncdb_2017_paired_records %>%
  mutate(P1_TYPE = case_when(P1_USER == "Driver" & V1_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P1_USER == "Driver" & V1_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P1_USER == "Driver" & V1_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P1_USER == "Passenger" & V1_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P1_USER == "Pedestrian" ~ "Pedestrian",
                             P1_USER == "Bicyclist" ~ "Bicyclist",
                             P1_USER == "Motorcyclist" ~ "Motorcyclist"),
         P1_TYPE = factor(P1_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")),
         P2_TYPE = case_when(P2_USER == "Driver" & V2_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P2_USER == "Driver" & V2_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P2_USER == "Driver" & V2_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P2_USER == "Passenger" & V2_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P2_USER == "Pedestrian" ~ "Pedestrian",
                             P2_USER == "Bicyclist" ~ "Bicyclist",
                             P2_USER == "Motorcyclist" ~ "Motorcyclist"),
         P2_TYPE = factor(P2_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")))

# For 2016:
ncdb_2016_paired_records <- ncdb_2016_paired_records %>%
  mutate(P1_TYPE = case_when(P1_USER == "Driver" & V1_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P1_USER == "Driver" & V1_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P1_USER == "Driver" & V1_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P1_USER == "Passenger" & V1_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P1_USER == "Pedestrian" ~ "Pedestrian",
                             P1_USER == "Bicyclist" ~ "Bicyclist",
                             P1_USER == "Motorcyclist" ~ "Motorcyclist"),
         P1_TYPE = factor(P1_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")),
         P2_TYPE = case_when(P2_USER == "Driver" & V2_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P2_USER == "Driver" & V2_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P2_USER == "Driver" & V2_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P2_USER == "Passenger" & V2_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P2_USER == "Pedestrian" ~ "Pedestrian",
                             P2_USER == "Bicyclist" ~ "Bicyclist",
                             P2_USER == "Motorcyclist" ~ "Motorcyclist"),
         P2_TYPE = factor(P2_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")))
```

```{r data-preparation-3, include=FALSE}

# Prepare data for estimation (also used for in-sample predictions, i.e., nowcasting)
nowcast_data.df <- ncdb_2017_paired_records %>% 
  transmute(P1_USER,
            P_ISEV,
            # INDIVIDUAL-LEVEL VARIABLES
            P1_SEX,
            P1_SAFE,
            P1_AGE,
            P1_AGE2 = P1_AGE^2,
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            DRIVER1 = 1 * (P1_USER == "Driver"),
            PASSENGER1 = 1 * (P1_USER == "Passenger"),
            PEDESTRIAN1 = 1 * (P1_USER == "Pedestrian"),
            BICYCLIST1 = 1 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1 = 1 * (P1_USER == "Motorcyclist"),
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            LD = 1 * (V1_TYPE == "Light Duty Vehicles"),
            LT = 1 * (V1_TYPE == "Vans and Light Trucks"),
            HV = 1 * (V1_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
            P1_AGExP2_AGExF = P1_AGE * P2_AGE * (P2_SEX == "Female"),
            P1_AGExP2_AGE2xM = P1_AGE * P2_AGE^2 * (P2_SEX == "Male"), 
            P1_AGExP2_AGE2xF = P1_AGE * P2_AGE^2 * (P2_SEX == "Female"),
            P1_AGE2xP2_AGExM = P1_AGE^2 * P2_AGE * (P2_SEX == "Male"),
            P1_AGE2xP2_AGExF = P1_AGE^2 * P2_AGE^2 * (P2_SEX == "Female"),
            LD_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LD_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LT_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            LT_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            HV_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            HV_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            LD_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LD_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LT_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            LT_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            HV_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            HV_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            PEDESTRIAN1_AGE = P1_AGE * (P1_USER == "Pedestrian"),
            PEDESTRIAN1_AGE2 = P1_AGE2 * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE = P1_AGE * (P1_USER == "Bicyclist"),
            BICYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE = P1_AGE * (P1_USER == "Motorcyclist"),
            MOTORCYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Motorcyclist"),
            
            # OPPONENT VARIABLES
            P2_SEX,
            P2_AGE,
            P2_AGE2 = P2_AGE^2,
            xLD = 1 * (V2_TYPE == "Light Duty Vehicles"),
            xLT = 1 * (V2_TYPE == "Vans and Light Trucks"),
            xHV = 1 * (V2_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL OPPONENT VARIABLES
            P1_AGExP2_AGE = P1_AGE * P2_AGE,
            P1_AGExP2_AGE2 = P1_AGE * P2_AGE^2,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE^2,
            LDxLD = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            LDxLT = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            LDxHV = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            LTxLD = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Light Duty Vehicles"),
            LTxLT = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Vans and Light Trucks"),
            LTxHV = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Heavy Vehicles"),
            HVxLD = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            HVxLT = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            HVxHV = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            PEDESTRIANxLD = (P1_USER == "Pedestrian") * (V2_TYPE == "Light Duty Vehicles"),
            PEDESTRIANxLT = (P1_USER == "Pedestrian") * (V2_TYPE == "Vans and Light Trucks"),
            PEDESTRIANxHV = (P1_USER == "Pedestrian") * (V2_TYPE == "Heavy Vehicles"),
            BICYCLISTxLD = (P1_USER == "Bicyclist") * (V2_TYPE == "Light Duty Vehicles"),
            BICYCLISTxLT = (P1_USER == "Bicyclist") * (V2_TYPE == "Vans and Light Trucks"),
            BICYCLISTxHV =  (P1_USER == "Bicylist") * (V2_TYPE == "Heavy Vehicles"),
            MOTORCYCLISTxLD = (P1_USER == "Motorcyclist") * (V2_TYPE == "Light Duty Vehicles"),
            MOTORCYCLISTxLT = (P1_USER == "Motorcyclist") * (V2_TYPE == "Vans and Light Trucks"),
            MOTORCYCLISTxHV =  (P1_USER == "Motorcyclist") * (V2_TYPE == "Heavy Vehicles"),
            
            # CASE-LEVEL VARIABLES
            C_CONF,
            C_RCFG,
            C_WTHR,
            C_RSUR,
            C_RALN,
            C_TRAF,
            C_MNTH)

# Prepare data for out-of-sample predictions, i.e., backcasting)
backcast_data.df <- ncdb_2016_paired_records %>% 
  transmute(P1_USER,
            P_ISEV,
            # INDIVIDUAL-LEVEL VARIABLES
            P1_SEX,
            P1_SAFE,
            P1_AGE,
            P1_AGE2 = P1_AGE^2,
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            DRIVER1 = 1 * (P1_USER == "Driver"),
            PASSENGER1 = 1 * (P1_USER == "Passenger"),
            PEDESTRIAN1 = 1 * (P1_USER == "Pedestrian"),
            BICYCLIST1 = 1 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1 = 1 * (P1_USER == "Motorcyclist"),
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            LD = 1 * (V1_TYPE == "Light Duty Vehicles"),
            LT = 1 * (V1_TYPE == "Vans and Light Trucks"),
            HV = 1 * (V1_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
            LD_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LD_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LT_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            LT_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            HV_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            HV_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            LD_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LD_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LT_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            LT_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            HV_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            HV_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            PEDESTRIAN1_AGE = P1_AGE * (P1_USER == "Pedestrian"),
            PEDESTRIAN1_AGE2 = P1_AGE2 * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE = P1_AGE * (P1_USER == "Bicyclist"),
            BICYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE = P1_AGE * (P1_USER == "Motorcyclist"),
            MOTORCYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Motorcyclist"),
            
            # OPPONENT VARIABLES
            P2_SEX,
            P2_AGE,
            P2_AGE2 = P2_AGE^2,
            xLD = 1 * (V2_TYPE == "Light Duty Vehicles"),
            xLT = 1 * (V2_TYPE == "Vans and Light Trucks"),
            xHV = 1 * (V2_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL OPPONENT VARIABLES
            P1_AGExP2_AGE = P1_AGE * P2_AGE,
            P1_AGExP2_AGE2 = P1_AGE * P2_AGE^2,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE^2,
            P1_AGExP2_AGExF = P1_AGE * P2_AGE * (P2_SEX == "Female"),
            P1_AGExP2_AGE2xM = P1_AGE * P2_AGE^2 * (P2_SEX == "Male"), 
            P1_AGExP2_AGE2xF = P1_AGE * P2_AGE^2 * (P2_SEX == "Female"),
            P1_AGE2xP2_AGExM = P1_AGE^2 * P2_AGE * (P2_SEX == "Male"),
            P1_AGE2xP2_AGExF = P1_AGE^2 * P2_AGE^2 * (P2_SEX == "Female"),
            LDxLD = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            LDxLT = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            LDxHV = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            LTxLD = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Light Duty Vehicles"),
            LTxLT = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Vans and Light Trucks"),
            LTxHV = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Heavy Vehicles"),
            HVxLD = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            HVxLT = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            HVxHV = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            PEDESTRIANxLD = (P1_USER == "Pedestrian") * (V2_TYPE == "Light Duty Vehicles"),
            PEDESTRIANxLT = (P1_USER == "Pedestrian") * (V2_TYPE == "Vans and Light Trucks"),
            PEDESTRIANxHV = (P1_USER == "Pedestrian") * (V2_TYPE == "Heavy Vehicles"),
            BICYCLISTxLD = (P1_USER == "Bicyclist") * (V2_TYPE == "Light Duty Vehicles"),
            BICYCLISTxLT = (P1_USER == "Bicyclist") * (V2_TYPE == "Vans and Light Trucks"),
            BICYCLISTxHV =  (P1_USER == "Bicylist") * (V2_TYPE == "Heavy Vehicles"),
            MOTORCYCLISTxLD = (P1_USER == "Motorcyclist") * (V2_TYPE == "Light Duty Vehicles"),
            MOTORCYCLISTxLT = (P1_USER == "Motorcyclist") * (V2_TYPE == "Vans and Light Trucks"),
            MOTORCYCLISTxHV =  (P1_USER == "Motorcyclist") * (V2_TYPE == "Heavy Vehicles"),
            
            # CASE-LEVEL VARIABLES
            C_CONF,
            C_RCFG,
            C_WTHR,
            C_RSUR,
            C_RALN,
            C_TRAF,
            C_MNTH)
```

Introduction
==========================

Road safety continues to be a concern world-wide. According to a recent report from the World Health Organization [-@WHO2019global], road accidents are the 8th leading cause of death for all ages, and the number one cause of death for children and young people between the ages of 5 to 29. Of all leading causes of death, road accidents are the only cause of death unrelated to disease, disorder, or infection. Road accidents impose a heavy burden on individuals and society as a whole. Gobally, the rate of road collision-related deaths per 100,000 population and 100,000 vehicles have both fallen, even as the number of vehicles has grown [@WHO2019global, Figs. 1 and 2]. These gains, although they are to be celebrated, cannot distract from the crushing economic cost of premature death [e.g., @Symons2019reduced; @Wijnen2019analysis], not to mention the long-term consequences for survivors, measured in sometimes crippling emotional and physical pain [e.g., @Merlin2007stress; @Devlin2019road; @Pelissier2019medical]. 

Evidence from across the world suggests that the burden of road accidents is not borne evenly. There are important disparities at the international level, where the odds of death due to road crashes are three times higher in low-income countries compared to high-income countries; in fact, no reductions in road accident-related fatalities were appreciated in low-income countries between 2013 and 2016 [@WHO2019global]. In the case of high-income countries, where substantial gains in road safety have been observed for years, said gains have also been unevenly distributed; thus, while fatal crashes involving older adults in the United States and Great Britain declined between 1997 and 2010 (despite the graying of the population), the trend remained stable or increased slightly in Australia in roughly the same period [@Thompson2018trends]. There are also systematic differences in the impact of road accidents. For example, in a study in the United States, Obeng [-@Obeng2011gender] reported that the impact of covariates of crash severity varied substantially in magnitude by gender. More recently, Regev et al. [-@Regev2018crash] used adjusted crash risk to find that the risk of crashes in Great Britain peaked for people 21 to 29 years of age; on the other hand, the risk of fatal injuries for older drivers was constant, irrespective of the seriousness of the crash - which highlights the perils of accidents at older ages. Other studies have concentrated on the consequences of road accidents for the young [e.g., @Peek-Asa2010teenage], the old [e.g., @Rakotonirainy2012older], as well as pedestrians and cyclists [e.g., @Hanson2013severity; @McArthur2014spatial].   

Given the relevance and cost of this matter, as well as the important variations of the impacts among different population segments, numerous efforts efforts have been conducted to better understand the factors that affect road safety - including the probable consequences of crashes. Consequently, a stream of research in the analysis of road accidents is concerned with the severity of crashes. In particular, multivariate analysis of crash severity is a useful way to clarify the way various factors can affect the outcome of an incident, to discriminate between various levels of injury, from no injury (i.e., property damage only), to different degrees of injury up to and including fatality. This is an active area of research [e.g., @Savolainen2011statistical], and one where methodological developments have aimed at improving the reliability, accuracy, and precision of models. 

This paper aspires to contribute to the literature on crash severity by assessing different modelling strategies useful to incorporate opponent effects in crash analysis, in the context of incidents involving two parties. The importance of these interactions has been recognized in the existing literature [e.g., @Chiou2013modeling; @Lee2014analysis; @Tarrao2014modeling; @Li2017interplay], and a number of different modelling strategies have been proposed. In this paper we present a systematic assessment of several relevant modelling strategies, ranging from the way variables are defined in single-level models, in multi-level models (i.e., hierarchical models), as well as using data subsetting approaches. For the assessment we use data from Canada's National Collision Database, a database that collects all police-reported collisions in the country. Using the most recent version of the dataset (2017), three levels of crash severity (no injury/injury/fatality) are analyzed using ordered logit models and covariates for the participants in the crash and the conditions of the crash. For model assessment, we conduct an in-sample prediction exercise using the estimation sample (i.e., _nowcasting_), and also an out-of-sample prediction exercise using the dataset corresponding to 2016 (i.e., _backcasting_). The models are assessed using predicted shares and predicted individual outcomes using an extensive array of verification statistics. The results highlight the importance of considering opponent effects in crash severity analysis to improve the goodness-of-fit and predictive performance o. On the other hand, the study suggests that hierarchical variable specifications and subsetting do not perform necessarily better than a relatively simple single-level model with opponent effects.

The rest of this paper is structured as follows. In Section \ref{sec:review-of-methods} we present a concise review of the methods used to analyze crash severity, with a particular focus on techniques that consider the interactions between participants in a crash. Section \ref{sec:methods} describes the data requirements, data preprocessing, and the modelling strategy. Model estimation is presented in \ref{sec:application} and the assessment of models is in Section \ref{sec:assessment}. We then present some additional thoughts about the applicability of this approach in Section \ref{sec:further-considerations} before offering some concluding remarks in Section \ref{sec:concluding-remarks}.

Methodological approaches in crash severity analysis {#sec:review-of-methods}
============

Modelling the outcomes of crashes in terms of the severity of injuries to participants has been a preoccupation of transportation researchers, planners, auto insurance companies, governments and the public for decades. One of the earliests studies to investigate the severity of injuries conditional on an accident having occurred was by White and Clayton [-@White1972effects]. Kim et al. [-@Kim1995personal] later stated that the "linkages between severity of injury and driver characteristics and behaviors have not been thoroughly investigated" (p. 470). Nowadays, there is a burgeoning literature on this subject, including methodological developments, case studies, and more niche research with a focus on particular situations [e.g., crashes at intersections, @Mussone2017analysis; crashes in rural roads, @Gong2017modeling] or special populations [e.g., crashes involving motorcyclists or active travelers; see @Shaheed2013mixed; @Salon2018determinants].

Crash severity is often modelled using models for discrete outcomes, including classification techniques from machine learning [e.g., @Iranitalab2017comparison; @Khan2015exploring; @Chang2006analysis; @Effati2015geospatial], Poisson models for counts [e.g., @Ma2008multivariate], unordered logit/probit models [], as well as ordered logit/probit models [e.g., @Rifaat2007accident], with numerous variants, such as random parameters/mixed logit [e.g., @Aziz2013exploring; @Haleem2013effect], partial proportional odds models [e.g., @Mooradian2013analysis; @Sasidharan2014partial], and the use of copulas [e.g., @Wang2015copula]. Recent reviews of methods include Savolainen et al. [-@Savolainen2011statistical] and Shamsunnahar and Eluru [-@Shamsunnahar2013evaluating]. Shamsunnahar and Eluru [-@Shamsunnahar2013evaluating] in particular conducted an extensive comparison of models for discrete outcomes and found that while the difference between the performance of unordered models and ordered models was so small as to make not difference, ordered models are usually more parsimonious since only one latent functions needs to be estimated for all outcomes, as opposed to one for each outcome in unordered modelling mechanisms.

Irrespective of the modelling framework employed, models of crash severity often include variables in several categories, as shown with examples in Table \ref{tab:table-variable-categories} [also see @Montella2013crash]. Many crash databases (but not by any means all) also account for the multievent nature of many crashes. In this way, there are crashes that involve a single traffic unit [e.g., @Kim2013driver; @Gong2017modeling], others that involve two traffic units [e.g., @Tarrao2014modeling; @Wang2015copula], and more rarely there are multi-traffic unit crashes [e.g., @Wu2014mixed; @Bogue2017modified]. Likewise, each traffic unit can possibly involve more than one person (e.g., driver and passengers). Thus, depending on the incident, each record in a crash database may include unique identifier for the crash, as well as identifiers for the traffic units (or identifiers for dummy objects such as a light pole that was hit by a vehicle), and the people involved in the crash.

```{r table-variable-categories, echo=FALSE}

data.frame(Category = c("Person-related",
                                              "Traffic unit-related",
                                              "Crash-related",
                                              "Road-related"),
                                 Examples = c("Attributes of participants in the crash, e.g., injury status, age, gender, licensing status, professional driver status",
                                              "Attributes of the traffic unit, e.g., type of traffic unit (car, motorcycle, etc.), maneouver, etc.",
                                              "Attributes of the crash, e.g., location, weather conditions, light conditions, number of parties, etc.",
                                              "Attributes of the road, e.g., surface condition, grade, geometry, etc.")) %>%
  kable(booktabs = T,
        caption = "\\label{tab:table-variable-categories}Categories of variables used in the analysis of crash severity with examples") %>% 
  column_spec(2, width = "22em")


```

Interplay between participants:

@Chiou2013modeling

@Lee2014analysis consider effect on crash severity of interactions between different types of vehicles. This they do by subsetting the dataset and estimating independent models for each subset of data. Since they consider three types of vehicles, namely cars (C), light trucks (L), and heavy trucks (H), they work with nine datasets, for each type of interactions (i.e., C-C, C-L, C-H, and so on). 
@Tarrao2014modeling

@Mannering2016unobserved

@Li2017interplay

@Salon2018determinants

@Chen2019investigation

@Wu2014mixed two-vehicle crashes do not really consider the interactions.



Many models use a latent-variable approach, whereby the severity of the crash (observed) is linked to an underlying latent variable that is a function of the variables:
$$
y_{ik}^*=\sum_{l=1}\beta_lp_{ikl} + \sum_{m=1}\gamma_mc_{km} + \epsilon_{ik}
$$

The left-hand side of the expression above ($y_{ik}^*$) is a latent (unobservable) variable that is associated with the severity of crash $k$ ($k=1,\cdots,K$) for participant $i$ ($i = 1,\cdots,n$). The right-hand side of the expression is split in three parts. The first part collects $l=1,\cdots,L$ individual attributes $p$ for participant $i$ in crash $k$; these could relate to the person (e.g., age and gender) or be individual attributes of the traffic unit (e.g., maneuver or vehicle type). The second part collects $m=1,\cdots,M$ attributes $c$ related to the crash $k$, including crash-related and road-related data. The last part is a random term specific to participant $i$ in crash $k$.

The latent variable is not observed directly, but it is possible to posit a probabilistic relationship with the outcome $y_{ik}$ (the severity of crash $k$ for participant $i$). Depending on the characteristics of the data and the assumptions made about the random component of the latent function different models can be obtained. For example, if crash severity is coded as a binary variable (e.g., non-fatal/fatal), we can relate the latent variable to the outcome as follows:
$$
y_{ik} = 
\begin{cases}
\text{fatal} & \text{if } y_{ik}^*>0\\
\text{non-fatal} & \text{if } y_{ik}^*\leq0
\end{cases}
$$

Due to the stochastic nature of the latent function, the outcome of the crash is not fully determined. However, we can make the following probability statement:
$$
P(y_i = \text{fatal}) = P(y_i^* > 0)
$$
In other words, the probability of a fatal accident equals the probability that the latent variable is greater than zero. This implies [see @Maddala1986limited, p. 22]:
$$
\begin{array}{rl}\
P(y_i = \text{fatal}) &= P(\sum_{l=1}\beta_lp_{ikl} + \sum_{m=1}\gamma_mc_{km} + \epsilon_{ik} > 0)\\ 
&=P(\epsilon_{ik} > -\sum_{l=1}\beta_lp_{ikl} - \sum_{m=1}\gamma_mc_{km})
\end{array}
$$

It the random terms $\epsilon_i$ are assumed to follow the logistic distribution, the the binary logit model is obtained; if they are assumed to follow the normal distribution, the binary probit model is obtained.

More often, though, the outcome is recorded using more categories, for example property damage only (PDO)/injury/fatality. A similar approach can be adopted, with a latent variable that relates to the outcome as follows:
$$
y_i = 
\begin{cases}
\text{fatality} & \text{if } y_i^*> k_2\\
\text{injury} & \text{if } k_1< y_i^*<k_2\\
\text{PDO} & \text{if } y_i^*<k_1
\end{cases}
$$
where $k_1$ and $k_2$ are estimable thresholds. In this case, the associated probability statements are as follows:
$$
\begin{array}{rcl}\
P(y_{ik} = \text{PDO}) &=& 1 - P(y_{ik} = \text{injury}) - P(y_{ik} = \text{fatality})\\ 
P(y_{ik} = \text{injury}) &=& P(k_1 - \sum_{l=1}\beta_lp_{ikl} - \sum_{m=1}\gamma_mc_{km} < \epsilon_{ik} < k_2 - \sum_{l=1}\beta_lp_{ikl} - \sum_{m=1}\gamma_mc_{km} )\\
P(y_{ik} = \text{fatality}) &=& P(\epsilon_{ik} < k_1 - \sum_{l=1}\beta_lp_{ikl} - \sum_{m=1}\gamma_mc_{km} )
\end{array}
$$

If the random terms are assumed to follow the logistic distribution, the ordered logit model is obtained; if the normal distribution, then the ordered probit model. Estimation methods for these models are very well-established [e.g., @Maddala1986limited; @Train2009discrete]

There are numerous variations of the basic modelling framework above, including hierarchical models, bivariate models, multinomial models, and Bayesian models, among others [see @Savolainen2011statistical for a review of methods].



Methods {#sec:methods}
===================

## Data considerations

Words go here

@Montella2013crash


## Model specification

More words go here

Application {#sec:application}
============

>**Note:** that this paper presents reproducible research. The source file is an R Markdown document. All code and data necessary to reproduce the analysis are available from the following anonymous Drive folder:

>https://drive.google.com/open?id=12aJtVBaQ4Zj0xa7mtfqxh0E48hKCb_XV

>The source files, code, and data will be publicly available in a GitHub repository upon acceptance of the paper for publication

## Data for the application

To assess the performance of the modelling strategies discussed in Section \ref{sec:methods}, we use data from Canada's National Collision Database (NCDB). This is database contains all motor vehicle collisions on public roads in Canada as reported by a police service. Data are collected by provinces and territories, and shared with the federal government, where data are combined, tracked, and analyzed for reporting of deaths, injuries, and collisions in Canada at the national level. The NCDB is provided by Transport Canada, the agency of the federal government of Canada in charge of transportation policies and programs, under the Open Government License - Canada version 2.0 [https://open.canada.ca/en/open-government-licence-canada]. 


The NCDB is available from 1999. For the purpose of this paper, we use the most recent year available as of this writing (2017). Furthermore, for assessment we also use the data corresponding to 2016. Similar to databases in other jurisdictions [see @], the NCDB contains information pertaining to the collision, the traffic unit, and the person(s) involved. 

```{r ncdb-descriptives, echo=FALSE}
data.frame(Variable = c("Age"),
           Details = c("Details")) %>%
  kable(booktabs = TRUE) %>%
  footnote(general = "NCDB available from https://open.canada.ca/data/en/dataset/1eb9eba7-71d1-4b30-9fb1-30cbdab7e63a")
```

## Model estimation

Words go here

Model specification. See Table:
```{r model-specification-summary, echo=FALSE}
data.frame(Variable = c(# INDIVIDUAL-LEVEL VARIABLES
  "Age",
  "Age Squared",
  "Sex",
  "Use of Safety Devices",
  
  # TRAFFIC UNIT-LEVEL VARIABLES
  
  "Passenger",
  "Pedestrian",
  "Bicyclist",
  "Motorcyclist",
  "Light Truck",
  "Heavy Vehicle",
  
  # OPPONENT VARIABLES
  
  "Age of Opponent",
  "Age of Opponent Squared",
  "Sex of Opponent",
  "Opponent: Light Duty Vehicle",
  "Opponent: Light Truck",
  "Opponent: Heavy Vehicle",
  
  # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
  
  "Age:Light Truck Driver",
  "Age Squared:Light Truck Driver",
  "Age:Heavy Vehicle Driver",
  "Age Squared:Heavy Vehicle Driver",
  "Age:Light Truck Passenger",
  "Age Squared:Light Truck Passenger",
  "Age:Heavy Vehicle Passenger",
  "Age Squared:Heavy Vehicle Passenger",
  "Age:Pedestrian",
  "Age Squared:Pedestrian",
  "Age:Bicyclist",
  "Age Squared:Bicyclist",
  "Age:Motorcyclist",
  "Age Squared:Motorcyclist",
  
  # HIERARCHICAL OPPONENT VARIABLES
  
  "Age:Age of Opponent",
  "Age:Age of Female Opponent",
  "Age:Age of Male Opponent Squared",
  "Age:Age of Female Opponent Squared",
  "Age Squared:Age of Male Opponent",
  "Age Squared:Age of Female Opponent",
  
  # CASE-LEVEL VARIABLES
  
  "Crash Configuration",
  "Road Configuration",
  "Weather",
  "Surface",
  "Road Alignment",
  "Traffic Controls",
  "Month"),
  Notes = c("In decades",
            " ",
            "Reference: Female",
            "7 levels; Reference: No Safety Device",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Light Duty Vehicle",
            "Reference: Light Duty Vehicle",
            "In decades",
            " ",
            "Reference: Female",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            "19 levels; Reference: Hit a Moving Object",
            "12 levels; Reference: Non-Intersection",
            "9 levels; Reference: Clear and Sunny",
            "11 levels; Reference: Dry",
            "8 levels; Reference: Straight and Level",
            "19 levels; Reference: Operational Traffic Signals",
            "12 levels; Reference: January"),
  Model1 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model2 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model3 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model4 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$")) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        col.names = c("Variable",
                      "Notes",
                      "Model 1",
                      "Model 2",
                      "Model 3",
                      "Model 4")) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  pack_rows("Individual-level variables", 1, 4) %>% 
  pack_rows("Traffic unit-level variables", 5, 10) %>% 
  pack_rows("Opponent variables)", 11, 16) %>%
  pack_rows("Hierarchical traffic unit variables)", 17, 30) %>%
  pack_rows("Hierarchical opponent variables)", 31, 36) %>%
  pack_rows("Case-level variables)", 37, 43)
```

```{r model-1, include = FALSE, cache = TRUE}

# Initial model with individual-level attributes and case-level attributes: flat model

## Full data set: This is the model with a "flat" structure, including only individual-, vehicle-, and case-level variables. Estimate the model and save to named object:

mod1 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_AGE + 
               P1_AGE2 + 
               P1_SEX + 
               P1_SAFE +
               # TRAFFIC UNIT-LEVEL VARIABLES
               PASSENGER1 + 
               PEDESTRIAN1 +
               BICYCLIST1 +
               MOTORCYCLIST1 +
               LT +
               HV +
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r cases-for-subsetting, include=FALSE}
# Tabulate the number of cases by user-opponent type:

nowcast_data.df %>% dplyr::select(ends_with("xLD") , ends_with("xLT") , ends_with("xHV")) %>% colSums()
```

Notice how there are zero cases of user: BYCICLIST - opponent: Heavy Vehicle. 

Re-estimate model after subsetting by USER Type of person 1. LDxLD:
```{r model-1-ensemble, include = FALSE, cache = TRUE}

# Same model specification but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs light duty vehicle
mod1_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs light truck vehicle
mod1_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod1_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light duty vehicle
mod1_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light truck
mod1_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod1_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light duty vehicle
mod1_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light truck
mod1_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vs heavy vehicle
mod1_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs light duty vehicle
mod1_PEDESTRIANxLD <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs light truck
mod1_PEDESTRIANxLT <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs heavy vehicle
mod1_PEDESTRIANxHV <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1),
                           Hess = TRUE,
                           method = "logistic")

# Bicyclist vs light duty vehicle
mod1_BICYCLISTxLD <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #DRIVER1 +
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLD == 1),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs light truck
mod1_BICYCLISTxLT <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #DRIVER1 +
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLT == 1),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod1_BICYCLISTxHV <- polr(P_ISEV ~
#                      # INDIVIDUAL-LEVEL VARIABLES
#                      P1_AGE + 
#                      P1_AGE2 + 
#                      P1_SEX + 
#                      P1_SAFE +
#                      # TRAFFIC UNIT-LEVEL VARIABLES
#                      #DRIVER1 +
#                      #PASSENGER1 + 
#                      #PEDESTRIAN1 +
#                      #BICYCLIST1 +
#                      #MOTORCYCLIST1 +
#                      #LT +
#                      #HV +
#                      # CASE-LEVEL VARIABLES
#                      C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#              data = nowcast_data.df %>% filter(BICYCLISTxHV == 1),
#              Hess = TRUE,
#              method = "logistic")

# Motorcyclist vs light duty vehicle
mod1_MOTORCYCLISTxLD <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs light truck
mod1_MOTORCYCLISTxLT <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs heavy vehicle
mod1_MOTORCYCLISTxHV <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1),
                             Hess = TRUE,
                             method = "logistic")
```

```{r model-2, include=FALSE, cache = TRUE}

# Second model with individual-level attributes, case-level attributes, and opponent attributes: flat model

## Full data set: This is the model with a "flat" structure, including individual-, vehicle-, and case-level variables, and additionally opponent attributes. Estimate the model and save to named object:
mod2 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_AGE + 
               P1_AGE2 + 
               P1_SEX + 
               P1_SAFE +
               # TRAFFIC UNIT-LEVEL VARIABLES
               PASSENGER1 + 
               PEDESTRIAN1 +
               BICYCLIST1 +
               MOTORCYCLIST1 +
               LT +
               HV +
               # OPPONENT ATTRIBUTES
               P2_AGE + 
               P2_AGE2 +
               P2_SEX +
               xLD +
               xLT +
               xHV +
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r model-2-ensemble, include = FALSE, cache = TRUE}

# Same specification as Model 2 but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs ligth duty vehicle
mod2_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs ligth truck
mod2_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod2_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth duty vehicle
mod2_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth truck
mod2_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod2_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth duty vehicle
mod2_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth truck
mod2_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs heavy vehicle
mod2_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs ligth duty vehicle
mod2_PEDESTRIANxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs light ruck
mod2_PEDESTRIANxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs heavy vehicle
mod2_PEDESTRIANxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1),
                   Hess = TRUE,
                   method = "logistic")

# Bicyclist vs ligth duty vehicle
mod2_BICYCLISTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(BICYCLISTxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Bicyclist vs ligth truck
mod2_BICYCLISTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(BICYCLISTxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod2_BICYCLISTxHV <- polr(P_ISEV ~
#                      # INDIVIDUAL-LEVEL VARIABLES
#                      P1_AGE + 
#                      P1_AGE2 + 
#                      P1_SEX + 
#                      P1_SAFE +
#                      # TRAFFIC UNIT-LEVEL VARIABLES
#                      PASSENGER1 + 
#                      #PEDESTRIAN1 +
#                      #BICYCLIST1 +
#                      #MOTORCYCLIST1 +
#                      #LT +
#                      #HV +
#                      # OPPONENT ATTRIBUTES
#                      P2_AGE + 
#                      P2_AGE2 +
#                      P2_SEX +
#                      #xLD +
#                      #xLT +
#                      #xHV +
#                      # CASE-LEVEL VARIABLES
#                      C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#                    data = nowcast_data.df %>% filter(BICYCLISTxHV == 1),
#                    Hess = TRUE,
#                    method = "logistic")

# Motorcyclist vs light duty vehicle
mod2_MOTORCYCLISTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1),
                   Hess = TRUE,
                   method = "logistic")

# Motorcyclist vs light truck
mod2_MOTORCYCLISTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1),
                   Hess = TRUE,
                   method = "logistic")

# Motorcyclist vs heavy vehicle
mod2_MOTORCYCLISTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1),
                   Hess = TRUE,
                   method = "logistic")
```

```{r model-3, include=FALSE, cache=TRUE}

## Third model with hierarchical traffic unit-level attributes, case-level attributes, and opponents

mod3 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
               
               # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
               #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + # Omitted to avoid perfect colinearity
               LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
               HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
               LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
               LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
               HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
               PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
               BICYCLIST1_AGE + BICYCLIST1_AGE2 +
               MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
               
               # OPPONENT VARIABLES
               P2_AGE +
               P2_AGE2 +
               P2_SEX +
               xLD +
               xLT +
               xHV +
               
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r model-4, include = FALSE, cache=TRUE}

# Fourth model with hierarchical opponent-attributes, traffic unit-level attributes, and case-level attributes

mod4 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
               
               # TRAFFIC UNIT-LEVEL VARIABLES
               # P1_DRIVER +
               PASSENGER1  +
               PEDESTRIAN1  +
               BICYCLIST1  +
               MOTORCYCLIST1 +
               LT +
               HV +
               
               # HIERARCHICAL OPPONENT VARIABLES
               P1_AGExP2_AGE+
               P1_AGExP2_AGExF +
               P1_AGExP2_AGE2xM +
               P1_AGExP2_AGE2xF +
               P1_AGE2xP2_AGExM +
               P1_AGE2xP2_AGExF +
               
               # OPPONENT VARIABLES
               xLT +
               xHV +
               xLD +
               
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

Summary of models. See Table \ref{tab:model-summary}.
```{r model-summary, echo=FALSE}
data.frame(Model = c("Model 1", 
                     "Model 2",
                     "Model 3",
                     "Model 4",
                     "Light duty vehicle vs light duty vehicle",
                     "Light duty vehicle vs light truck",
                     "Light duty vehicle vs heavy vehicle",
                     "Light truck vs light duty vehicle",
                     "Light truck vs light truck",
                     "Light truck vs heavy vehicle",
                     "Heavy vehicle vs light duty vehicle",
                     "Heavy vehicle vs light truck",
                     "Heavy vehicle vs heavy vehicle",
                     "Pedestrian vs light duty vehicle",
                     "Pedestrian vs light truck",
                     "Pedestrian vs heavy vehicle",
                     "Bicyclist vs light duty vehicle",
                     "Bicyclist vs light truck",
                     "Bicyclist vs heavy vehicle",
                     "Motorcyclist vs light duty vehicle",
                     "Motorcyclist vs light truck",
                     "Motorcyclist vs heavy vehicle",
                     "Light duty vehicle vs light duty vehicle",
                     "Light duty vehicle vs light truck",
                     "Light duty vehicle vs heavy vehicle",
                     "Light truck vs light duty vehicle",
                     "Light truck vs light truck",
                     "Light truck vs heavy vehicle",
                     "Heavy vehicle vs light duty vehicle",
                     "Heavy vehicle vs light truck",
                     "Heavy vehicle vs heavy vehicle",
                     "Pedestrian vs light duty vehicle",
                     "Pedestrian vs light truck",
                     "Pedestrian vs heavy vehicle",
                     "Bicyclist vs light duty vehicle",
                     "Bicyclist vs light truck",
                     "Bicyclist vs heavy vehicle",
                     "Motorcyclist vs light duty vehicle",
                     "Motorcyclist vs light truck",
                     "Motorcyclist vs heavy vehicle"),
           n = c(mod1$nobs,
                 mod2$nobs,
                 mod3$nobs,
                 mod4$nobs,
                 mod1_LDxLD$nobs,
                 mod1_LDxLT$nobs,
                 mod1_LDxHV$nobs,
                 mod1_LTxLD$nobs,
                 mod1_LTxLT$nobs,
                 mod1_LTxHV$nobs,
                 mod1_HVxLD$nobs,
                 mod1_HVxLT$nobs,
                 mod1_HVxHV$nobs,
                 mod1_PEDESTRIANxLD$nobs,
                 mod1_PEDESTRIANxLT$nobs,
                 mod1_PEDESTRIANxHV$nobs,
                 mod1_BICYCLISTxLD$nobs,
                 mod1_BICYCLISTxLT$nobs,
                 NA, 
                 mod1_MOTORCYCLISTxLD$nobs,
                 mod1_MOTORCYCLISTxLT$nobs,
                 mod1_MOTORCYCLISTxHV$nobs,
                 mod2_LDxLD$nobs,
                 mod2_LDxLT$nobs,
                 mod2_LDxHV$nobs,
                 mod2_LTxLD$nobs,
                 mod2_LTxLT$nobs,
                 mod2_LTxHV$nobs,
                 mod2_HVxLD$nobs,
                 mod2_HVxLT$nobs,
                 mod2_HVxHV$nobs,
                 mod2_PEDESTRIANxLD$nobs,
                 mod2_PEDESTRIANxLT$nobs,
                 mod2_PEDESTRIANxHV$nobs,
                 mod2_BICYCLISTxLD$nobs,
                 mod2_BICYCLISTxLT$nobs,
                 NA, 
                 mod2_MOTORCYCLISTxLD$nobs,
                 mod2_MOTORCYCLISTxLT$nobs,
                 mod2_MOTORCYCLISTxHV$nobs),
           k = c(length(mod1$coefficients),
                 length(mod2$coefficients),
                 length(mod3$coefficients),
                 length(mod4$coefficients),
                 length(mod1_LDxLD$coefficients),
                 length(mod1_LDxLT$coefficients),
                 length(mod1_LDxHV$coefficients),
                 length(mod1_LTxLD$coefficients),
                 length(mod1_LTxLT$coefficients),
                 length(mod1_LTxHV$coefficients),
                 length(mod1_HVxLD$coefficients),
                 length(mod1_HVxLT$coefficients),
                 length(mod1_HVxHV$coefficients),
                 length(mod1_PEDESTRIANxLD$coefficients),
                 length(mod1_PEDESTRIANxLT$coefficients),
                 length(mod1_PEDESTRIANxHV$coefficients),
                 length(mod1_BICYCLISTxLD$coefficients),
                 length(mod1_BICYCLISTxLT$coefficients),
                 NA, 
                 length(mod1_MOTORCYCLISTxLD$coefficients),
                 length(mod1_MOTORCYCLISTxLT$coefficients),
                 length(mod1_MOTORCYCLISTxHV$coefficients),
                 length(mod2_LDxLD$coefficients),
                 length(mod2_LDxLT$coefficients),
                 length(mod2_LDxHV$coefficients),
                 length(mod2_LTxLD$coefficients),
                 length(mod2_LTxLT$coefficients),
                 length(mod2_LTxHV$coefficients),
                 length(mod2_HVxLD$coefficients),
                 length(mod2_HVxLT$coefficients),
                 length(mod2_HVxHV$coefficients),
                 length(mod2_PEDESTRIANxLD$coefficients),
                 length(mod2_PEDESTRIANxLT$coefficients),
                 length(mod2_PEDESTRIANxHV$coefficients),
                 length(mod2_BICYCLISTxLD$coefficients),
                 length(mod2_BICYCLISTxLT$coefficients),
                 NA, 
                 length(mod2_MOTORCYCLISTxLD$coefficients),
                 length(mod2_MOTORCYCLISTxLT$coefficients),
                 length(mod2_MOTORCYCLISTxHV$coefficients)),
           AIC = c(AIC(mod1),
                   AIC(mod2),
                   AIC(mod3),
                   AIC(mod4),
                   AIC(mod1_LDxLD),
                   AIC(mod1_LDxLT),
                   AIC(mod1_LDxHV),
                   AIC(mod1_LTxLD),
                   AIC(mod1_LTxLT),
                   AIC(mod1_LTxHV),
                   AIC(mod1_HVxLD),
                   AIC(mod1_HVxLT),
                   AIC(mod1_HVxHV),
                   AIC(mod1_PEDESTRIANxLD),
                   AIC(mod1_PEDESTRIANxLT),
                   AIC(mod1_PEDESTRIANxHV),
                   AIC(mod1_BICYCLISTxLD),
                   AIC(mod1_BICYCLISTxLT),
                   NA, 
                   AIC(mod1_MOTORCYCLISTxLD),
                   AIC(mod1_MOTORCYCLISTxLT),
                   AIC(mod1_MOTORCYCLISTxHV),
                   AIC(mod2_LDxLD),
                   AIC(mod2_LDxLT),
                   AIC(mod2_LDxHV),
                   AIC(mod2_LTxLD),
                   AIC(mod2_LTxLT),
                   AIC(mod2_LTxHV),
                   AIC(mod2_HVxLD),
                   AIC(mod2_HVxLT),
                   AIC(mod2_HVxHV),
                   AIC(mod2_PEDESTRIANxLD),
                   AIC(mod2_PEDESTRIANxLT),
                   AIC(mod2_PEDESTRIANxHV),
                   AIC(mod2_BICYCLISTxLD),
                   AIC(mod2_BICYCLISTxLT),
                   NA, 
                   AIC(mod2_MOTORCYCLISTxLD),
                   AIC(mod2_MOTORCYCLISTxLT),
                   AIC(mod2_MOTORCYCLISTxHV))) %>%
  mutate(n = format(n, digits = 2, big.mark = ","),
         AIC = format(AIC, digits = 2, big.mark = ",")) %>%
  kable(digits = 2,
        booktabs = TRUE,
        escape = FALSE,
        align = c("l", "c", "c", "c"),
        col.names = linebreak(c("Model", "Number of\nobservations", "Number of\ncoefficients", "AIC")),
        caption = "\\label{tab:model-summary}Summary of model estimation results") %>%
  kable_styling(latex_options = c("striped")) %>%
  pack_rows("Full sample models", 1, 4) %>% 
  pack_rows("Model 1 Ensemble (sample subsets by user type vs opponent)", 5, 22) %>% 
  pack_rows("Model 2 Ensemble (sample subsets by user type vs opponent)", 23, 40) %>%
  footnote(general = "There are zero cases of BICYCLIST vs HV in the sample")
```

Model assessment {#sec:assessment}
============

## Outcome shares based on probabilities

Words go here.

```{r nowcast-probabilities-model-1, include=FALSE}

# Nowcast of probabilities and shares

P_ISEV_mod1 = predict(mod1, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 1")
```

```{r nowcast-probabilities-model-1-ensemble, include=FALSE}
P_ISEV_mod1_ensemble <- rbind(predict(mod1_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "probs"),
                              predict(mod1_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "probs"),
                              predict(mod1_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "probs"),
                              predict(mod1_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "probs"),
                              predict(mod1_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "probs"),
                              predict(mod1_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "probs"),
                              predict(mod1_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1), type = "probs"),
                              predict(mod1_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1), type = "probs"),
                              predict(mod1_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "probs"),
                              predict(mod1_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "probs"),
                              predict(mod1_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1), type = "probs"),
                              #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 1 Ensemble")
```

```{r nowcast-probabilities-model-2, include=FALSE}
P_ISEV_mod2 = predict(mod2, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 2")
```

```{r nowcast-probabilities-model-2-ensemble, include=FALSE}
P_ISEV_mod2_ensemble <- rbind(predict(mod2_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "probs"),
                              predict(mod2_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "probs"),
                              predict(mod2_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "probs"),
                              predict(mod2_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "probs"),
                              predict(mod2_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "probs"),
                              predict(mod2_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "probs"),
                              predict(mod2_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1), type = "probs"),
                              predict(mod2_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1), type = "probs"),
                              predict(mod2_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "probs"),
                              predict(mod2_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "probs"),
                              predict(mod2_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1), type = "probs"),
                              #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 2 Ensemble")
```

```{r nowcast-probabilities-model-3, include=FALSE}
P_ISEV_mod3 = predict(mod3, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 3")
```

```{r nowcast-probabilities-model-4, include=FALSE}
P_ISEV_mod4 = predict(mod4, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 4")
```

```{r nowcast-probabilities-collect-results, include=FALSE}

# Collect the results of the nowcasting exercise

nowcast.probs <- rbind(P_ISEV_mod1,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3,
                       P_ISEV_mod4)
```

```{r nowcast-probabilities-summary, include=FALSE}

# Summarize the results of nowcasting the probabilities by calculating the shares of each outcome as the sum of the predicted probabilities; based on the predicted shares, calculate the Average Prediction Error (APE) and the Weighted Average Prediction Error (WAPE). See Bogue, Paleti, and Balan (2017) for an example of these measures

nowcast_ape <- nowcast.probs %>% 
        #filter(P_ISEV == "No Injury") %>% 
        dplyr::select(P_ISEV, No.Injury, Injury, Fatality, Model) %>%
        group_by(Model) %>%
        summarize(No.Injury.2017 = sum(P_ISEV == "No Injury"), 
                  No.Injury = sum(No.Injury),
                  Injury.2017 = sum(P_ISEV == "Injury"), 
                  Injury = sum(Injury),
                  Fatality.2017 = sum(P_ISEV == "Fatality"), 
                  Fatality = sum(Fatality)) %>%
  transmute(Model, 
            No.Injury.2017, 
            No.Injury, 
            APE.No.Injury = abs(No.Injury - No.Injury.2017)/No.Injury.2017 * 100,
            Injury.2017, 
            Injury, 
            APE.Injury = abs(Injury - Injury.2017)/Injury.2017 * 100,
            Fatality.2017, 
            Fatality, 
            APE.Fatality = abs(Fatality - Fatality.2017)/Fatality.2017 * 100,
            WAPE = (APE.No.Injury * No.Injury.2017 + APE.Injury * Injury.2017 + APE.Fatality * Fatality.2017)/(No.Injury.2017 + Injury.2017 + Fatality.2017))
```

```{r backcast-probabilities-model-1, include=FALSE}

# The 2016 dataset is used to Backcast of probabilities and shares of the outcomes.

P_ISEV_mod1 = predict(mod1, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 1")
```

```{r backcast-probabilities-model-1-ensemble, include=FALSE}
P_ISEV_mod1_ensemble <- rbind(predict(mod1_LDxLD, newdata = backcast_data.df %>% filter(LDxLD == 1), type = "probs"),
                              predict(mod1_LDxLT, newdata = backcast_data.df %>% filter(LDxLT == 1), type = "probs"),
                              predict(mod1_LDxHV, newdata = backcast_data.df %>% filter(LDxHV == 1), type = "probs"),
                              predict(mod1_LTxLD, newdata = backcast_data.df %>% filter(LTxLD == 1), type = "probs"),
                              predict(mod1_LTxLT, newdata = backcast_data.df %>% filter(LTxLT == 1), type = "probs"),
                              predict(mod1_LTxHV, newdata = backcast_data.df %>% filter(LTxHV == 1), type = "probs"),
                              predict(mod1_HVxLD, newdata = backcast_data.df %>% filter(HVxLD == 1), type = "probs"),
                              predict(mod1_HVxLT, newdata = backcast_data.df %>% filter(HVxLT == 1), type = "probs"),
                              predict(mod1_HVxHV, newdata = backcast_data.df %>% filter(HVxHV == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxLD, newdata = backcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxLT, newdata = backcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "probs"),
                              predict(mod1_PEDESTRIANxHV, newdata = backcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "probs"),
                              predict(mod1_BICYCLISTxLD, newdata = backcast_data.df %>% filter(BICYCLISTxLD == 1), type = "probs"),
                              predict(mod1_BICYCLISTxLT, newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1), type = "probs"),
                              #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxLD, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxLT, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "probs"),
                              predict(mod1_MOTORCYCLISTxHV, newdata = backcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "probs")) %>%
  data.frame(rbind(backcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 1 Ensemble")
```

```{r backcast-probabilities-model-2, include=FALSE}
P_ISEV_mod2 = predict(mod2, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = backcast_data.df$P_ISEV,
             P1_USER = backcast_data.df$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 2")
```

```{r  backcast-probabilities-model-2-ensemble, include=FALSE}
P_ISEV_mod2_ensemble <- rbind(predict(mod2_LDxLD, newdata = backcast_data.df %>% filter(LDxLD == 1), type = "probs"),
                              predict(mod2_LDxLT, newdata = backcast_data.df %>% filter(LDxLT == 1), type = "probs"),
                              predict(mod2_LDxHV, newdata = backcast_data.df %>% filter(LDxHV == 1), type = "probs"),
                              predict(mod2_LTxLD, newdata = backcast_data.df %>% filter(LTxLD == 1), type = "probs"),
                              predict(mod2_LTxLT, newdata = backcast_data.df %>% filter(LTxLT == 1), type = "probs"),
                              predict(mod2_LTxHV, newdata = backcast_data.df %>% filter(LTxHV == 1), type = "probs"),
                              predict(mod2_HVxLD, newdata = backcast_data.df %>% filter(HVxLD == 1), type = "probs"),
                              predict(mod2_HVxLT, newdata = backcast_data.df %>% filter(HVxLT == 1), type = "probs"),
                              predict(mod2_HVxHV, newdata = backcast_data.df %>% filter(HVxHV == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxLD, newdata = backcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxLT, newdata = backcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "probs"),
                              predict(mod2_PEDESTRIANxHV, newdata = backcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "probs"),
                              predict(mod2_BICYCLISTxLD, newdata = backcast_data.df %>% filter(BICYCLISTxLD == 1), type = "probs"),
                              predict(mod2_BICYCLISTxLT, newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1), type = "probs"),
                              #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxLD, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxLT, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "probs"),
                              predict(mod2_MOTORCYCLISTxHV, newdata = backcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "probs")) %>%
  data.frame(rbind(backcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 2 Ensemble")
```

```{r backcast-probabilities-model-3, include=FALSE}
P_ISEV_mod3 = predict(mod3, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 3")
```

```{r  backcast-probabilities-model-4, include=FALSE}
P_ISEV_mod4 = predict(mod4, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 4")
```

The datasets are used to predict the probabilities of the outcomes:
```{r backcast-probabilities-collect-results, include=FALSE}
backcast.probs <- rbind(P_ISEV_mod1,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3,
                       P_ISEV_mod4)
```

```{r backcast-probabilities-summary, include=FALSE}

# Summarize the results of backcasting the probabilities by calculating the shares of each outcome as the sum of the predicted probabilities; based on the predicted shares, calculate the Average Prediction Error (APE) and the Weighted Average Prediction Error (WAPE). See Bogue, Paleti, and Balan (2017) for an example of these measures

backcast_ape <- backcast.probs %>% 
        #filter(P_ISEV == "No Injury") %>% 
        dplyr::select(P_ISEV, No.Injury, Injury, Fatality, Model) %>%
        group_by(Model) %>%
        summarize(No.Injury.2016 = sum(P_ISEV == "No Injury"), 
                  No.Injury = sum(No.Injury),
                  Injury.2016 = sum(P_ISEV == "Injury"), 
                  Injury = sum(Injury),
                  Fatality.2016 = sum(P_ISEV == "Fatality"), 
                  Fatality = sum(Fatality)) %>%
  transmute(Model, 
            No.Injury.2016, 
            No.Injury, 
            APE.No.Injury = abs(No.Injury - No.Injury.2016)/No.Injury.2016 * 100,
            Injury.2016, 
            Injury, 
            APE.Injury = abs(Injury - Injury.2016)/Injury.2016 * 100,
            Fatality.2016, 
            Fatality, 
            APE.Fatality = abs(Fatality - Fatality.2016)/Fatality.2016 * 100,
            WAPE = (APE.No.Injury * No.Injury.2016 + APE.Injury * Injury.2016 + APE.Fatality * Fatality.2016)/(No.Injury.2016 + Injury.2016 + Fatality.2016))
```

The results of calculating the Average Prediction Error appear in Table \ref{tab:ape-results}.

```{r table-ape-results, echo=FALSE}
rbind(nowcast_ape %>% rename(No.Injury.obs = No.Injury.2017, Injury.obs = Injury.2017, Fatality.obs = Fatality.2017), 
      backcast_ape %>% rename(No.Injury.obs = No.Injury.2016, Injury.obs = Injury.2016, Fatality.obs = Fatality.2016)) %>%
  kable(digits = 2,
        booktabs = TRUE,
        col.names = c("Model", 
                      "Observed", "Predicted", "APE", 
                      "Observed", "Predicted", "APE",
                      "Observed", "Predicted", "APE",
                      "WAPE"),
        caption = "\\label{tab:ape-results}Predicted shares and average prediction errors (APE) by model (percentages)") %>%
  add_header_above(c("", "No Injury" = 3, "Injury" = 3, "Fatality" = 3, "")) %>% 
  kable_styling() %>% 
  pack_rows("In-sample (nowcasting using 2017 dataset, i.e., estimation dataset)", 1, 6) %>% 
  pack_rows("Out-of-sample (backcasting using 2016 dataset)", 7, 12) %>%
  row_spec(c(0, 1, 3, 5, 6, 7, 9, 11), extra_latex_after = "\\rowcolor{gray!15}") %>%
  landscape()
```

## Predicted outcomes

Words go here.

Verification statistics used are summarized in Table \ref{tab:verification-statistics}.
```{r table-verification-statistics, echo=FALSE}
data.frame(Statistic = c("Percent Correct ($PC$)",
                         "Percent Correct by Class ($PC_c$)",
                         "Bias ($B$)",
                         "Critical Success Index ($CSI$)",
                         "Probability of False Detection ($F$)",
                         "Probability of Detection ($POD$)",
                         "False Alarm Ratio ($FAR$)",
                         "Heidke Skill Score ($HSS$)",
                         "Peirce Skill Score ($PSS$)",
                         "Gerrity Score ($GS$)"),
           Description = c("Total hits and correct rejections divided by number of cases",
                           "Same as Percent Correct but by category",
                           "Total predicted by category, divided by total observed by category",
                           "Total hits divided by total hits + false alarms + misses",
                           "Proportion of no events forecast as yes; sensitive to false alarms but ignores misses",
                           "Total hits divided by total observed by class",
                           "Total false alarms divided by total forecast yes by class; measures fraction of predicted yes that did not occur",
                           "Fraction of correct predictions after removing predictions attributable to chance; measures fractional improvement over random; tends to reward conservative forecasts",
                           "Combines $POD$ and $F$; measures ability to separate yes events from no events; tends to reward conservative forecasts",
                           "Measures accuracy of predicting the correct category, relative to random; tends to reward correct forecasts of less likely category"),
           Notes = c("Strongly influenced by most common category",
                     "Strongly influenced by most common category",
                     "$B>1$: class is overpredicted; $B<1$: class is underpredicted",
                     "$CSI = 1$: perfect score; $CSI = 0$: no skill",
                     "$F = 0$: perfect score",
                     "$POD = 1$: perfect score",
                     "$FAR = 0$: perfect score",
                     "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better",
                     "$PSS = 1$: perfect score; $PSS = 0$: no skill",
                     "$GS = 1$: perfect score; $GS = 0$: no skill")) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        caption = "\\label{tab:verification-statistics}Verification statistics") %>% 
  kable_styling(latex_options =  c("striped", "scale_down")) %>%
  column_spec(2:3, width = "30em") %>%
  landscape()
```


```{r nowcast-classes-model-1, include=FALSE}

# Nowcast the outcomes

P_ISEV_mod1 <- data.frame(P_ISEV_mod = predict(mod1, newdata = nowcast_data.df, type = "class"),
                         P_ISEV = nowcast_data.df$P_ISEV,
                         P1_USER = nowcast_data.df$P1_USER,
                         xLD = nowcast_data.df$xLD,
                         xLT = nowcast_data.df$xLT,
                         xHV = nowcast_data.df$xHV,
                         Model = "Model 1") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-1-ensemble, include=FALSE}
P_ISEV_mod1_ensemble <- data.frame(P_ISEV_mod = c(predict(mod1_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "class"),
                                                  predict(mod1_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "class"),
                                                  predict(mod1_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "class"),
                                                  predict(mod1_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "class"),
                                                  predict(mod1_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "class"),
                                                  predict(mod1_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "class"),
                                                  predict(mod1_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1), type = "class"),
                                                  predict(mod1_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1), type = "class"),
                                                  predict(mod1_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                                                  predict(mod1_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                                                  predict(mod1_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1), type = "class"),
                                                  #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "class")),
                                   rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 1 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-2, include=FALSE}
P_ISEV_mod2 = data.frame(P_ISEV_mod = predict(mod2, newdata = nowcast_data.df, type = "class"),
                         P_ISEV = nowcast_data.df$P_ISEV,
                         P1_USER = nowcast_data.df$P1_USER,
                         xLD = nowcast_data.df$xLD,
                         xLT = nowcast_data.df$xLT,
                         xHV = nowcast_data.df$xHV,
                         Model = "Model 2") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-2-ensemble, include=FALSE}
P_ISEV_mod2_ensemble <- data.frame(P_ISEV_mod = c(predict(mod2_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "class"),
                                                  predict(mod2_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "class"),
                                                  predict(mod2_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "class"),
                                                  predict(mod2_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "class"),
                                                  predict(mod2_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "class"),
                                                  predict(mod2_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "class"),
                                                  predict(mod2_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1), type = "class"),
                                                  predict(mod2_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1), type = "class"),
                                                  predict(mod2_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                                                  predict(mod2_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                                                  predict(mod2_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1), type = "class"),
                                                  #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "class")),
                                   rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 2 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-3, include=FALSE}
P_ISEV_mod3 <- data.frame(P_ISEV_mod = predict(mod3, newdata = nowcast_data.df, type = "class"),
                         P_ISEV = nowcast_data.df$P_ISEV,
                         P1_USER = nowcast_data.df$P1_USER,
                         xLD = nowcast_data.df$xLD,
                         xLT = nowcast_data.df$xLT,
                         xHV = nowcast_data.df$xHV,
                         Model = "Model 3") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-4, include=FALSE}
P_ISEV_mod4 <- data.frame(P_ISEV_mod = predict(mod4, newdata = nowcast_data.df, type = "class"),
                         P_ISEV = nowcast_data.df$P_ISEV,
                         P1_USER = nowcast_data.df$P1_USER,
                         xLD = nowcast_data.df$xLD,
                         xLT = nowcast_data.df$xLT,
                         xHV = nowcast_data.df$xHV,
                         Model = "Model 4") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-collect-results, include=FALSE}
nowcast.preds <- rbind(P_ISEV_mod1,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3,
                       P_ISEV_mod4) %>%
  mutate(Model = factor(Model,
                        levels = c("Model 1", "Model 1 Ensemble", "Model 2", "Model 2 Ensemble", "Model 3", "Model 4"),
                        labels = c("Model 1", "Model 1 Ensemble", "Model 2", "Model 2 Ensemble", "Model 3", "Model 4")))
```

```{r backcast-classes-model-1, include=FALSE}

# Backcast the outcomes

P_ISEV_mod1 <- data.frame(P_ISEV_mod = predict(mod1, newdata = backcast_data.df, type = "class"),
                         P_ISEV = backcast_data.df$P_ISEV,
                         P1_USER = backcast_data.df$P1_USER,
                         xLD = backcast_data.df$xLD,
                         xLT = backcast_data.df$xLT,
                         xHV = backcast_data.df$xHV,
                         Model = "Model 1") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-1-ensemble, include=FALSE}
P_ISEV_mod1_ensemble <- data.frame(P_ISEV_mod = c(predict(mod1_LDxLD, newdata = backcast_data.df %>% filter(LDxLD == 1), type = "class"),
                                                  predict(mod1_LDxLT, newdata = backcast_data.df %>% filter(LDxLT == 1), type = "class"),
                                                  predict(mod1_LDxHV, newdata = backcast_data.df %>% filter(LDxHV == 1), type = "class"),
                                                  predict(mod1_LTxLD, newdata = backcast_data.df %>% filter(LTxLD == 1), type = "class"),
                                                  predict(mod1_LTxLT, newdata = backcast_data.df %>% filter(LTxLT == 1), type = "class"),
                                                  predict(mod1_LTxHV, newdata = backcast_data.df %>% filter(LTxHV == 1), type = "class"),
                                                  predict(mod1_HVxLD, newdata = backcast_data.df %>% filter(HVxLD == 1), type = "class"),
                                                  predict(mod1_HVxLT, newdata = backcast_data.df %>% filter(HVxLT == 1), type = "class"),
                                                  predict(mod1_HVxHV, newdata = backcast_data.df %>% filter(HVxHV == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxLD, newdata = backcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxLT, newdata = backcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                                                  predict(mod1_PEDESTRIANxHV, newdata = backcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                                                  predict(mod1_BICYCLISTxLD, newdata = backcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                                                  predict(mod1_BICYCLISTxLT, newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1), type = "class"),
                                                  #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxLD, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxLT, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                                                  predict(mod1_MOTORCYCLISTxHV, newdata = backcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "class")),
                                   rbind(backcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 1 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-2, include=FALSE}
P_ISEV_mod2 = data.frame(P_ISEV_mod = predict(mod2, newdata = backcast_data.df, type = "class"),
                         P_ISEV = backcast_data.df$P_ISEV,
                         P1_USER = backcast_data.df$P1_USER,
                         xLD = backcast_data.df$xLD,
                         xLT = backcast_data.df$xLT,
                         xHV = backcast_data.df$xHV,
                         Model = "Model 2") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-2-ensemble, include=FALSE}
P_ISEV_mod2_ensemble <- data.frame(P_ISEV_mod = c(predict(mod2_LDxLD, newdata = backcast_data.df %>% filter(LDxLD == 1), type = "class"),
                                                  predict(mod2_LDxLT, newdata = backcast_data.df %>% filter(LDxLT == 1), type = "class"),
                                                  predict(mod2_LDxHV, newdata = backcast_data.df %>% filter(LDxHV == 1), type = "class"),
                                                  predict(mod2_LTxLD, newdata = backcast_data.df %>% filter(LTxLD == 1), type = "class"),
                                                  predict(mod2_LTxLT, newdata = backcast_data.df %>% filter(LTxLT == 1), type = "class"),
                                                  predict(mod2_LTxHV, newdata = backcast_data.df %>% filter(LTxHV == 1), type = "class"),
                                                  predict(mod2_HVxLD, newdata = backcast_data.df %>% filter(HVxLD == 1), type = "class"),
                                                  predict(mod2_HVxLT, newdata = backcast_data.df %>% filter(HVxLT == 1), type = "class"),
                                                  predict(mod2_HVxHV, newdata = backcast_data.df %>% filter(HVxHV == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxLD, newdata = backcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxLT, newdata = backcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                                                  predict(mod2_PEDESTRIANxHV, newdata = backcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                                                  predict(mod2_BICYCLISTxLD, newdata = backcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                                                  predict(mod2_BICYCLISTxLT, newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1), type = "class"),
                                                  #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxLD, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxLT, newdata = backcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                                                  predict(mod2_MOTORCYCLISTxHV, newdata = backcast_data.df %>% filter(MOTORCYCLISTxHV == 1), type = "class")),
                                   rbind(backcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(BICYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         backcast_data.df %>% filter(MOTORCYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 2 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-3, include=FALSE}
P_ISEV_mod3 <- data.frame(P_ISEV_mod = predict(mod3, newdata = backcast_data.df, type = "class"),
                         P_ISEV = backcast_data.df$P_ISEV,
                         P1_USER = backcast_data.df$P1_USER,
                         xLD = backcast_data.df$xLD,
                         xLT = backcast_data.df$xLT,
                         xHV = backcast_data.df$xHV,
                         Model = "Model 3") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-4, include=FALSE}
P_ISEV_mod4 <- data.frame(P_ISEV_mod = predict(mod4, newdata = backcast_data.df, type = "class"),
                         P_ISEV = backcast_data.df$P_ISEV,
                         P1_USER = backcast_data.df$P1_USER,
                         xLD = backcast_data.df$xLD,
                         xLT = backcast_data.df$xLT,
                         xHV = backcast_data.df$xHV,
                         Model = "Model 4") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-collect-results, include=FALSE}
backcast.preds <- rbind(P_ISEV_mod1,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3,
                       P_ISEV_mod4) %>%
  mutate(Model = factor(Model,
                        levels = c("Model 1", "Model 1 Ensemble", "Model 2", "Model 2 Ensemble", "Model 3", "Model 4"),
                        labels = c("Model 1", "Model 1 Ensemble", "Model 2", "Model 2 Ensemble", "Model 3", "Model 4")))
```

We next evaluate the outcomes of the nowcast using an array of verification statistics. See Table \ref{tab:nowcast-outcomes-assessment}.
```{r nowcast-outcomes-assessment, echo=FALSE}
rbind(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4"))) %>%
  data.frame(pc = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pc * 100, 3)),
             pc2 = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pc2 * 100),
             bias = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$bias),
             ts = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$ts),
             f = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$f),
             h = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$h),
             FAR = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$false.alarm.ratio),
             hss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$hss, 3)),
             pss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pss, 3)),
             gs = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$gs, 3))) %>%
  rownames_to_column() %>%
  remove_rownames() %>%
  rename(Outcome = rowname) %>%
  mutate(Outcome = rep(c("No Injury", "Injury", "Fatality"), 6)) %>%
  kable(digits = 3,
        booktabs = TRUE,
        escape = FALSE,
        col.names = linebreak(c("Outcome",
                                "No Injury",
                                "Injury",
                                "Fatality",
                                "Percent\nCorrect",
                                "Percent\nCorrect\nby Class",
                                "Bias$^1$",
                                "Critical\nSuccess\nIndex$^2$",
                                "Probability of\nFalse\nDetection$^3$",
                                "Probability\nof\nDetection$^4$",
                                "False\nAlarm\nRatio$^5$",
                                "Heidke\nSkill\nScore$^6$",
                                "Peirce\nSkill\nScore$^7$",
                                "Gerrity\nScore$^8$")),
        caption = "\\label{tab:nowcast-outcomes-assessment}Assessment of in-sample outcomes (nowcasting using 2017 dataset, i.e., estimation dataset)") %>%
  add_header_above(c("Observed" = 1, "Predicted Outcome" = 3, "Verification Statistics" = 10)) %>%
  collapse_rows(columns = c(5, 12:14), latex_hline = "major", valign = "middle") %>%
  pack_rows("Model 1", 1, 3) %>% 
  pack_rows("Model 1 Ensemble", 4, 6) %>%
  pack_rows("Model 2", 7, 9) %>%
  pack_rows("Model 2 Ensemble", 10, 12) %>%
  pack_rows("Model 3", 13, 15) %>%
  pack_rows("Model 4", 16, 18) %>% 
  kable_styling(latex_options = c("scale_down")) %>%
  footnote(number = c("$B>1$: class is overpredicted; $B<1$: class is underpredicted; ",
                      "$CSI = 1$: perfect score; $CSI = 0$: no skill; ",
                      "$F = 0$: perfect score; ",
                      "$POD = 1$: perfect score; ",
                      "$FAR = 0$: perfect score; ",
                      "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better; ",
                      "$PSS = 1$: perfect score; $PSS = 0$: no skill; ",
                      "$GS = 1$: perfect score; $GS = 0$: no skill."), 
           number_title = "Notes: ",
           escape = FALSE)
```

We next evaluate the outcomes of the nowcast using an array of verification statistics. See Table \ref{tab:backcast-outcomes-assessment}.
```{r backcast-outcomes-assessment, echo=FALSE}
rbind(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4"))) %>%
  data.frame(pc = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pc * 100, 3)),
             pc2 = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pc2 * 100),
             bias = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$bias),
             ts = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$ts),
             f = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$f),
             h = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$h),
             FAR = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$false.alarm.ratio),
             hss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$hss, 3)),
             pss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pss, 3)),
             gs = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$gs, 3))) %>%
  rownames_to_column() %>%
  remove_rownames() %>%
  rename(Outcome = rowname) %>%
  mutate(Outcome = rep(c("No Injury", "Injury", "Fatality"), 6)) %>%
  kable(digits = 3,
        booktabs = TRUE,
        escape = FALSE,
        col.names = linebreak(c("Outcome",
                                "No Injury",
                                "Injury",
                                "Fatality",
                                "Percent\nCorrect",
                                "Percent\nCorrect\nby Class",
                                "Bias$^1$",
                                "Critical\nSuccess\nIndex$^2$",
                                "Probability of\nFalse\nDetection$^3$",
                                "Probability\nof\nDetection$^4$",
                                "False\nAlarm\nRatio$^5$",
                                "Heidke\nSkill\nScore$^6$",
                                "Peirce\nSkill\nScore$^7$",
                                "Gerrity\nScore$^8$")),
        caption = "\\label{tab:nowcast-outcomes-assessment}Assessment of in-sample outcomes (nowcasting using 2017 dataset, i.e., estimation dataset)") %>%
  add_header_above(c("Observed" = 1, "Predicted Outcome" = 3, "Verification Statistics" = 10)) %>%
  collapse_rows(columns = c(5, 12:14), latex_hline = "major", valign = "middle") %>%
  pack_rows("Model 1", 1, 3) %>% 
  pack_rows("Model 1 Ensemble", 4, 6) %>%
  pack_rows("Model 2", 7, 9) %>%
  pack_rows("Model 2 Ensemble", 10, 12) %>%
  pack_rows("Model 3", 13, 15) %>%
  pack_rows("Model 4", 16, 18) %>% 
  kable_styling(latex_options = c("scale_down")) %>%
  footnote(number = c("$B>1$: class is overpredicted; $B<1$: class is underpredicted; ",
                      "$CSI = 1$: perfect score; $CSI = 0$: no skill; ",
                      "$F = 0$: perfect score; ",
                      "$POD = 1$: perfect score; ",
                      "$FAR = 0$: perfect score; ",
                      "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better; ",
                      "$PSS = 1$: perfect score; $PSS = 0$: no skill; ",
                      "$GS = 1$: perfect score; $GS = 0$: no skill."), 
           number_title = "Notes: ",
           escape = FALSE)
```

Further considerations {#sec:further-considerations}
============

Here I plan to discuss the applicability of the modelling strategy to advanced modelling techniques (partial proportional odds, heterogeneity, hierarchical models, etc.)

Concluding remarks {#sec:concluding-remarks}
============

Words go here.

References {#references .unnumbered}
==========
