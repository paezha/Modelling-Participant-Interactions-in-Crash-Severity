---
title: A systematic assessment of the use of opponent variables, data subsetting and hierarchical specification in two-party crash severity analysis
author:
  - name: Antonio Paez
    email: paezha@mcmaster.ca
    affiliation: McMaster University
    footnote: Corresponding Author
  - name: Hany Hassan
    email: hassan1@lsu.edu
    affiliation: Louisiana State University
  - name: Mark Ferguson
    email: fergumr@mcmaster.ca
    affiliation: McMaster University
  - name: Saiedeh Razavi
    email: razavi@mcmaster.ca
    affiliation: McMaster University    
address:
  - code: McMaster University
    address: McMaster Institute for Transportation and Logistics, McMaster University, 1280 Main Street West, Hamilton, Ontario, Canada L8S 4K1
  - code: Louisiana State University
    address: Department of Civil and Environmental Engineering, Louisiana State University, Baton Rouge, Louisiana, USA 70803
abstract: |
  Road crashes impose an important burden on health and the economy. Numerous efforts have been undertaken to understand the factors that affect road collisions in general, and the severity of crashes in particular. In this literature several strategies have been proposed to model interactions between parties in a crash, including the use of variables regarding the other party (or parties) in the collision, data subsetting, and estimating models with hierarchical components. Since no systematic assessment has been conducted of the performance of these strategies, they appear to be used in an ad-hoc fashion in the literature. The objective of this paper is to empirically evaluate ways to model party interactions in the context of crashes involving two parties. To this end, a series of models are estimated using data from Canada's National Collision Database. Three levels of crash severity (no injury/injury/fatality) are analyzed using ordered probit models and covariates for the parties in the crash and the conditions of the crash. The models are assessed using predicted shares and classes of outcomes, and the results highlight the importance of considering opponent effects in crash severity analysis. The study also suggests that hierarchical (i.e., multi-level) specifications and subsetting do not necessarily perform better than a relatively simple single-level model with opponent-related factors. The results of this study provide insights regarding the performance of different modelling strategies, and should be informative to researchers in the field of crash severity.

journal: "Accident Analysis and Prevention"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
#linenumbers: true
numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article

header-includes:
   - \usepackage[margin=1in]{geometry}
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
   - \doublespacing
---

<!--- 
_Text based on elsarticle sample manuscript, see [http://www.elsevier.com/author-schemas/latex-instructions#elsarticle](http://www.elsevier.com/author-schemas/latex-instructions#elsarticle)_

This paper is an R markdown document that includes self-contained, reproducible analysis. To reproduce the paper the following files are needed:

1. Interactions-Crash-Severity-v1.Rmd (this R markdown document)

2. Two data files: NCDB_2016.csv and NCDB_2017.csv. These datasets correspond to the 2016 and 2017 releases of Canada's National Crash Database. These data are released by Transport Canada under the Open Government License - Canada version 2.0 [https://open.canada.ca/en/open-government-licence-canada]. The datasets can be obtained here:

https://open.canada.ca/data/en/dataset/1eb9eba7-71d1-4b30-9fb1-30cbdab7e63a

Or from the following repository:

https://github.com/paezha/Modelling-Participant-Interactions-in-Crash-Severity

3. For compiling into a pdf in the style of an Elsevier document: elsarticle.cls, elsevier-harvard.csl, elsevier-harvard-without-titles.csl, elsevier-vancouver.csl, elsevier-without-titles.cls, elsevier-with-titles.csl, elsevier-with-titles-alphabetical.csl, mybibfile.bib
--->

```{r load-packages, include=FALSE}
# Load the packages used in this notebook:
library(kableExtra)
library(latex2exp)
library(MASS)
library(readxl)
library(tidyverse)
library(verification)
```

```{r source-code-for-ordinal-model, include=FALSE}
# Fixed version of polr that provides better starting values; see here: https://r.789695.n4.nabble.com/bugs-and-misfeatures-in-polr-MASS-fixed-td3024677.html#a3030405

# file MASS/R/polr.R
# copyright (C) 1994-2008 W. N. Venables and B. D. Ripley
# Use of transformed intercepts contributed by David Firth
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 or 3 of the License
#  (at your option).
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  A copy of the GNU General Public License is available at
#  http://www.r-project.org/Licenses/
#
polr <- function(formula, data, weights, start, ..., subset,
                 na.action, contrasts = NULL, Hess = FALSE,
                 model = TRUE,
                 method = c("logistic", "probit", "cloglog", "cauchit"))
{
  logit <- function(p) log(p/(1 - p))
  
  fmin <- function(beta) {
    theta <- beta[pc + 1L:q]
    gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
    eta <- offset
    if (pc > 0)
      eta <- eta + drop(x %*% beta[1L:pc])
    pr <- pfun(gamm[y + 1] - eta) - pfun(gamm[y] - eta)
    if (all(pr > 0))
      -sum(wt * log(pr))
    else Inf
  }
  
  gmin <- function(beta)
  {
    jacobian <- function(theta) { ## dgamma by dtheta matrix
      k <- length(theta)
      etheta <- exp(theta)
      mat <- matrix(0 , k, k)
      mat[, 1] <- rep(1, k)
      for (i in 2:k) mat[i:k, i] <- etheta[i]
      mat
    }
    theta <- beta[pc + 1L:q]
    gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
    eta <- offset
    if(pc > 0) eta <- eta + drop(x %*% beta[1L:pc])
    pr <- pfun(gamm[y+1] - eta) - pfun(gamm[y] - eta)
    p1 <- dfun(gamm[y+1] - eta)
    p2 <- dfun(gamm[y] - eta)
    g1 <- if(pc > 0) t(x) %*% (wt*(p1 - p2)/pr) else numeric(0)
    xx <- .polrY1*p1 - .polrY2*p2
    g2 <- - t(xx) %*% (wt/pr)
    g2 <- t(g2) %*% jacobian(theta)
    if(all(pr > 0)) c(g1, g2) else rep(NA, pc+q)
  }
  
  m <- match.call(expand.dots = FALSE)
  method <- match.arg(method)
  pfun <- switch(method, logistic = plogis, probit = pnorm,
                 cloglog = pgumbel, cauchit = pcauchy)
  dfun <- switch(method, logistic = dlogis, probit = dnorm,
                 cloglog = dgumbel, cauchit = dcauchy)
  if(is.matrix(eval.parent(m$data)))
    m$data <- as.data.frame(data)
  m$start <- m$Hess <- m$method <- m$model <- m$... <- NULL
  m[[1L]] <- as.name("model.frame")
  m <- eval.parent(m)
  Terms <- attr(m, "terms")
  x <- model.matrix(Terms, m, contrasts)
  xint <- match("(Intercept)", colnames(x), nomatch=0L)
  n <- nrow(x)
  pc <- ncol(x)
  cons <- attr(x, "contrasts") # will get dropped by subsetting
  if(xint > 0) {
    x <- x[, -xint, drop=FALSE]
    pc <- pc - 1
  } else warning("an intercept is needed and assumed")
  wt <- model.weights(m)
  if(!length(wt)) wt <- rep(1, n)
  offset <- model.offset(m)
  if(length(offset) <= 1) offset <- rep(0, n)
  y <- model.response(m)
  if(!is.factor(y)) stop("response must be a factor")
  lev <- levels(y)
  if(length(lev) <= 2) stop("response must have 3 or more levels")
  y <- unclass(y)
  q <- length(lev) - 1
  Y <- matrix(0, n, q)
  .polrY1 <- col(Y) == y
  .polrY2 <- col(Y) == y - 1
  if(missing(start)) {
    # try something that should always work -tjb
    u <- as.integer(table(y))
    u <- (cumsum(u)/sum(u))[1:q]
    zetas <-
      switch(method,
             "logistic"= qlogis(u),
             "probit"=   qnorm(u),
             "cauchit"=  qcauchy(u),
             "cloglog"=  -log(-log(u)) )
    s0 <- c(rep(0,pc),zetas[1],log(diff(zetas)))
    
    ##         # try logistic/probit regression on 'middle' cut
    ##         q1 <- length(lev) %/% 2
    ##         y1 <- (y > q1)
    ##         X <- cbind(Intercept = rep(1, n), x)
    ##         fit <-
    ##             switch(method,
    ##                    "logistic"= glm.fit(X, y1, wt, family = binomial(), offset = offset),
    ##                    "probit" = glm.fit(X, y1, wt, family = binomial("probit"), offset = offset),
    ##                    ## this is deliberate, a better starting point
    ##                    "cloglog" = glm.fit(X, y1, wt, family = binomial("probit"), offset = offset),
    ##                    "cauchit" = glm.fit(X, y1, wt, family = binomial("cauchit"), offset = offset))
    ##         if(!fit$converged)
    ##             stop("attempt to find suitable starting values failed")
    ##         coefs <- fit$coefficients
    ##         if(any(is.na(coefs))) {
    ##             warning("design appears to be rank-deficient, so dropping some coefs")
    ##             keep <- names(coefs)[!is.na(coefs)]
    ##             coefs <- coefs[keep]
    ##             x <- x[, keep[-1L], drop = FALSE]
    ##             pc <- ncol(x)
    ##           }
    ##         spacing <- logit((1L:q)/(q+1)) # just a guess
    ##         if(method != "logistic") spacing <- spacing/1.7
    ##         gammas <- -coefs[1L] + spacing - spacing[q1]
    ##         thetas <- c(gammas[1L], log(diff(gammas)))
    ##         s0 <- c(coefs[-1L], thetas)
  } else if(length(start) != pc + q)
    stop("'start' is not of the correct length")
  else {
    s0 <- if(pc > 0) c(start[seq_len(pc+1)], log(diff(start[-seq_len(pc)])))
    else c(start[1L], log(diff(start)))
  }
  res <- optim(s0, fmin, gmin, method="BFGS", hessian = Hess, ...)
  beta <- res$par[seq_len(pc)]
  theta <- res$par[pc + 1L:q]
  zeta <- cumsum(c(theta[1L],exp(theta[-1L])))
  deviance <- 2 * res$value
  niter <- c(f.evals=res$counts[1L], g.evals=res$counts[2L])
  names(zeta) <- paste(lev[-length(lev)], lev[-1L], sep="|")
  if(pc > 0) {
    names(beta) <- colnames(x)
    eta <- offset + drop(x %*% beta)
  } else eta <- offset + rep(0, n)
  
  cumpr <- matrix(pfun(matrix(zeta, n, q, byrow=TRUE) - eta), , q)
  fitted <- t(apply(cumpr, 1L, function(x) diff(c(0, x, 1))))
  dimnames(fitted) <- list(row.names(m), lev)
  fit <- list(coefficients = beta, zeta = zeta, deviance = deviance,
              fitted.values = fitted, lev = lev, terms = Terms,
              df.residual = sum(wt) - pc - q, edf = pc + q, n = sum(wt),
              nobs = sum(wt),
              call = match.call(), method = method,
              convergence = res$convergence, niter = niter, lp = eta)
  if(Hess) {
    dn <- c(names(beta), names(zeta))
    H <- res$hessian
    dimnames(H) <- list(dn, dn)
    fit$Hessian <- H
  }
  if(model) fit$model <- m
  fit$na.action <- attr(m, "na.action")
  fit$contrasts <- cons
  fit$xlevels <- .getXlevels(Terms, m)
  class(fit) <- "polr"
  fit
}

print.polr <- function(x, ...)
{
  if(!is.null(cl <- x$call)) {
    cat("Call:\n")
    dput(cl, control=NULL)
  }
  if(length(coef(x))) {
    cat("\nCoefficients:\n")
    print(coef(x), ...)
  } else {
    cat("\nNo coefficients\n")
  }
  cat("\nIntercepts:\n")
  print(x$zeta, ...)
  cat("\nResidual Deviance:", format(x$deviance, nsmall=2), "\n")
  cat("AIC:", format(x$deviance + 2*x$edf, nsmall=2), "\n")
  if(nzchar(mess <- naprint(x$na.action))) cat("(", mess, ")\n", sep="")
  if(x$convergence > 0)
    cat("Warning: did not converge as iteration limit reached\n")
  invisible(x)
}

vcov.polr <- function(object, ...)
{
  jacobian <- function(theta) { ## dgamma by dtheta matrix
    k <- length(theta)
    etheta <- exp(theta)
    mat <- matrix(0 , k, k)
    mat[, 1] <- rep(1, k)
    for (i in 2:k) mat[i:k, i] <- etheta[i]
    mat
  }
  
  if(is.null(object$Hessian)) {
    message("\nRe-fitting to get Hessian\n")
    utils::flush.console()
    object <- update(object, Hess=TRUE,
                     start=c(object$coefficients, object$zeta))
  }
  vc <- ginv(object$Hessian)
  pc <- length(coef(object))
  gamma <- object$zeta
  z.ind <- pc + seq_along(gamma)
  theta <- c(gamma[1L], log(diff(gamma)))
  J <- jacobian(theta)
  A <- diag(pc + length(gamma))
  A[z.ind, z.ind] <- J
  V <- A %*% vc %*% t(A)
  structure(V,  dimnames = dimnames(object$Hessian))
}

summary.polr <- function(object, digits = max(3, .Options$digits - 3),
                         correlation = FALSE, ...)
{
  cc <- c(coef(object), object$zeta)
  pc <- length(coef(object))
  q <- length(object$zeta)
  coef <- matrix(0, pc+q, 3, dimnames=list(names(cc),
                                           c("Value", "Std. Error", "t value")))
  coef[, 1] <- cc
  vc <- vcov(object)
  coef[, 2] <- sd <- sqrt(diag(vc))
  coef[, 3] <- coef[, 1]/coef[, 2]
  object$coefficients <- coef
  object$pc <- pc
  object$digits <- digits
  if(correlation)
    object$correlation <- (vc/sd)/rep(sd, rep(pc+q, pc+q))
  class(object) <- "summary.polr"
  object
}

print.summary.polr <- function(x, digits = x$digits, ...)
{
  if(!is.null(cl <- x$call)) {
    cat("Call:\n")
    dput(cl, control=NULL)
  }
  coef <- format(round(x$coefficients, digits=digits))
  pc <- x$pc
  if(pc > 0) {
    cat("\nCoefficients:\n")
    print(x$coefficients[seq_len(pc), , drop=FALSE], quote = FALSE,
          digits = digits, ...)
  } else {
    cat("\nNo coefficients\n")
  }
  cat("\nIntercepts:\n")
  print(coef[(pc+1):nrow(coef), , drop=FALSE], quote = FALSE,
        digits = digits, ...)
  cat("\nResidual Deviance:", format(x$deviance, nsmall=2), "\n")
  cat("AIC:", format(x$deviance + 2*x$edf, nsmall=2), "\n")
  if(nzchar(mess <- naprint(x$na.action))) cat("(", mess, ")\n", sep="")
  if(!is.null(correl <- x$correlation)) {
    cat("\nCorrelation of Coefficients:\n")
    ll <- lower.tri(correl)
    correl[ll] <- format(round(correl[ll], digits))
    correl[!ll] <- ""
    print(correl[-1, -ncol(correl)], quote = FALSE, ...)
  }
  invisible(x)
}

predict.polr <- function(object, newdata, type=c("class","probs"), ...)
{
  if(!inherits(object, "polr")) stop("not a \"polr\" object")
  type <- match.arg(type)
  if(missing(newdata)) Y <- object$fitted
  else {
    newdata <- as.data.frame(newdata)
    Terms <- delete.response(object$terms)
    m <- model.frame(Terms, newdata, na.action = function(x) x,
                     xlev = object$xlevels)
    if (!is.null(cl <- attr(Terms, "dataClasses")))
      .checkMFClasses(cl, m)
    X <- model.matrix(Terms, m, contrasts = object$contrasts)
    xint <- match("(Intercept)", colnames(X), nomatch=0L)
    if(xint > 0) X <- X[, -xint, drop=FALSE]
    n <- nrow(X)
    q <- length(object$zeta)
    eta <- drop(X %*% object$coefficients)
    pfun <- switch(object$method, logistic = plogis, probit = pnorm,
                   cloglog = pgumbel, cauchit = pcauchy)
    cumpr <- matrix(pfun(matrix(object$zeta, n, q, byrow=TRUE) - eta), , q)
    Y <- t(apply(cumpr, 1L, function(x) diff(c(0, x, 1))))
    dimnames(Y) <- list(rownames(X), object$lev)
  }
  if(missing(newdata) && !is.null(object$na.action))
    Y <- napredict(object$na.action, Y)
  switch(type, class = {
    Y <- factor(max.col(Y), levels=seq_along(object$lev),
                labels=object$lev)
  }, probs = {})
  drop(Y)
}

extractAIC.polr <- function(fit, scale = 0, k = 2, ...)
{
  edf <- fit$edf
  c(edf, deviance(fit) + k * edf)
}

model.frame.polr <- function(formula, ...)
{
  dots <- list(...)
  nargs <- dots[match(c("data", "na.action", "subset"), names(dots), 0)]
  if(length(nargs) || is.null(formula$model)) {
    m <- formula$call
    m$start <- m$Hess <- m$... <- NULL
    m[[1L]] <- as.name("model.frame")
    m[names(nargs)] <- nargs
    if (is.null(env <- environment(formula$terms))) env <- parent.frame()
    data <- eval(m, env)
    if(!is.null(mw <- m$weights)) {
      nm <- names(data)
      nm[match("(weights)", nm)] <- as.character(mw)
      names(data) <- nm
    }
    data
  } else formula$model
}

pgumbel <- function(q, loc = 0, scale = 1, lower.tail = TRUE)
{
  q <- (q - loc)/scale
  p <- exp(-exp(-q))
  if (!lower.tail) 1 - p else p
}

dgumbel <- function (x, loc = 0, scale = 1, log = FALSE)
{
  x <- (x - loc)/scale
  d <- log(1/scale) - x - exp(-x)
  d[is.nan(d)] <- -Inf                # -tjb
  if (!log) exp(d) else d
}

anova.polr <- function (object, ..., test = c("Chisq", "none"))
{
  test <- match.arg(test)
  dots <- list(...)
  if (length(dots) == 0L)
    stop('anova is not implemented for a single "polr" object')
  mlist <- list(object, ...)
  nt <- length(mlist)
  dflis <- sapply(mlist, function(x) x$df.residual)
  s <- order(dflis, decreasing = TRUE)
  mlist <- mlist[s]
  if (any(!sapply(mlist, inherits, "polr")))
    stop('not all objects are of class "polr"')
  ns <- sapply(mlist, function(x) length(x$fitted.values))
  if(any(ns != ns[1L]))
    stop("models were not all fitted to the same size of dataset")
  rsp <- unique(sapply(mlist, function(x) paste(formula(x)[2L])))
  mds <- sapply(mlist, function(x) paste(formula(x)[3L]))
  dfs <- dflis[s]
  lls <- sapply(mlist, function(x) deviance(x))
  tss <- c("", paste(1L:(nt - 1), 2:nt, sep = " vs "))
  df <- c(NA, -diff(dfs))
  x2 <- c(NA, -diff(lls))
  pr <- c(NA, 1 - pchisq(x2[-1L], df[-1L]))
  out <- data.frame(Model = mds, Resid.df = dfs, Deviance = lls,
                    Test = tss, Df = df, LRtest = x2, Prob = pr)
  names(out) <- c("Model", "Resid. df", "Resid. Dev", "Test",
                  "   Df", "LR stat.", "Pr(Chi)")
  if (test == "none") out <- out[, 1L:6]
  class(out) <- c("Anova", "data.frame")
  attr(out, "heading") <-
    c("Likelihood ratio tests of ordinal regression models\n",
      paste("Response:", rsp))
  out
}

polr.fit <- function(x, y, wt, start, offset, method)
{
  logit <- function(p) log(p/(1 - p))
  
  fmin <- function(beta) {
    theta <- beta[pc + 1L:q]
    gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
    eta <- offset
    if (pc > 0)
      eta <- eta + drop(x %*% beta[1L:pc])
    pr <- pfun(gamm[y + 1] - eta) - pfun(gamm[y] - eta)
    if (all(pr > 0))
      -sum(wt * log(pr))
    else Inf
  }
  
  gmin <- function(beta)
  {
    jacobian <- function(theta) { ## dgamma by dtheta matrix
      k <- length(theta)
      etheta <- exp(theta)
      mat <- matrix(0 , k, k)
      mat[, 1] <- rep(1, k)
      for (i in 2:k) mat[i:k, i] <- etheta[i]
      mat
    }
    theta <- beta[pc + 1L:q]
    gamm <- c(-Inf, cumsum(c(theta[1L], exp(theta[-1L]))), Inf)
    eta <- offset
    if(pc > 0) eta <- eta + drop(x %*% beta[1L:pc])
    pr <- pfun(gamm[y+1] - eta) - pfun(gamm[y] - eta)
    p1 <- dfun(gamm[y+1] - eta)
    p2 <- dfun(gamm[y] - eta)
    g1 <- if(pc > 0) t(x) %*% (wt*(p1 - p2)/pr) else numeric(0)
    xx <- .polrY1*p1 - .polrY2*p2
    g2 <- - t(xx) %*% (wt/pr)
    g2 <- t(g2) %*% jacobian(theta)
    if(all(pr > 0)) c(g1, g2) else rep(NA, pc+q)
  }
  
  pfun <- switch(method, logistic = plogis, probit = pnorm,
                 cloglog = pgumbel, cauchit = pcauchy)
  dfun <- switch(method, logistic = dlogis, probit = dnorm,
                 cloglog = dgumbel, cauchit = dcauchy)
  n <- nrow(x)
  pc <- ncol(x)
  lev <- levels(y)
  if(length(lev) <= 2L) stop("response must have 3 or more levels")
  y <- unclass(y)
  q <- length(lev) - 1L
  Y <- matrix(0, n, q)
  .polrY1 <- col(Y) == y
  .polrY2 <- col(Y) == y - 1L
  # pc could be 0.
  s0 <- if(pc > 0) c(start[seq_len(pc+1)], diff(start[-seq_len(pc)]))
  else c(start[1L], diff(start))
  res <- optim(s0, fmin, gmin, method="BFGS")
  beta <- res$par[seq_len(pc)]
  theta <- res$par[pc + 1L:q]
  zeta <- cumsum(c(theta[1L],exp(theta[-1L])))
  deviance <- 2 * res$value
  names(zeta) <- paste(lev[-length(lev)], lev[-1L], sep="|")
  if(pc > 0) {
    names(beta) <- colnames(x)
    eta <- drop(x %*% beta)
  } else {
    eta <- rep(0, n)
  }
  list(coefficients = beta, zeta = zeta, deviance = deviance)
}

profile.polr <- function(fitted, which = 1L:p, alpha = 0.01,
                         maxsteps = 10, del = zmax/5, trace = FALSE, ...)
{
  Pnames <- names(B0 <- coefficients(fitted))
  pv0 <- t(as.matrix(B0))
  p <- length(Pnames)
  if(is.character(which)) which <- match(which, Pnames)
  summ <- summary(fitted)
  std.err <- summ$coefficients[, "Std. Error"]
  mf <- model.frame(fitted)
  n <- length(Y <- model.response(mf))
  O <- model.offset(mf)
  if(!length(O)) O <- rep(0, n)
  W <- model.weights(mf)
  if(length(W) == 0L) W <- rep(1, n)
  OriginalDeviance <- deviance(fitted)
  X <- model.matrix(fitted)[, -1L, drop=FALSE] # drop intercept
  zmax <- sqrt(qchisq(1 - alpha, 1))
  profName <- "z"
  prof <- vector("list", length=length(which))
  names(prof) <- Pnames[which]
  start <- c(fitted$coefficients, fitted$zeta)
  for(i in which) {
    zi <- 0
    pvi <- pv0
    Xi <- X[,  - i, drop = FALSE]
    pi <- Pnames[i]
    for(sgn in c(-1, 1)) {
      if(trace) {
        message("\nParameter:", pi, c("down", "up")[(sgn + 1)/2 + 1])
        utils::flush.console()
      }
      step <- 0
      z <- 0
      ## LP is the linear predictor including offset.
      ## LP <- X %*% fitted$coef + O
      while((step <- step + 1) < maxsteps && abs(z) < zmax) {
        bi <- B0[i] + sgn * step * del * std.err[i]
        o <- O + X[, i] * bi
        fm <- polr.fit(x = Xi, y = Y, wt = W, start = start[-i],
                       offset = o, method = fitted$method)
        ri <- pv0
        ri[, names(coef(fm))] <- coef(fm)
        ri[, pi] <- bi
        pvi <- rbind(pvi, ri)
        zz <- fm$deviance - OriginalDeviance
        if(zz > - 1e-3) zz <- max(zz, 0)
        else stop("profiling has found a better solution, so original fit had not converged")
        z <- sgn * sqrt(zz)
        zi <- c(zi, z)
      }
    }
    si <- order(zi)
    prof[[pi]] <- structure(data.frame(zi[si]), names = profName)
    prof[[pi]]$par.vals <- pvi[si, ]
  }
  val <- structure(prof, original.fit = fitted, summary = summ)
  class(val) <- c("profile.polr", "profile")
  val
}

confint.polr <- function(object, parm, level = 0.95, trace = FALSE, ...)
{
  pnames <- names(coef(object))
  if(missing(parm)) parm <- seq_along(pnames)
  else if(is.character(parm))  parm <- match(parm, pnames, nomatch = 0L)
  message("Waiting for profiling to be done...")
  utils::flush.console()
  object <- profile(object, which = parm, alpha = (1. - level)/4.,
                    trace = trace)
  confint(object, parm=parm, level=level, trace=trace, ...)
}

confint.profile.polr <-
  function(object, parm = seq_along(pnames), level = 0.95, ...)
  {
    of <- attr(object, "original.fit")
    pnames <- names(coef(of))
    if(is.character(parm))  parm <- match(parm, pnames, nomatch = 0L)
    a <- (1-level)/2
    a <- c(a, 1-a)
    pct <- paste(round(100*a, 1), "%")
    ci <- array(NA, dim = c(length(parm), 2L),
                dimnames = list(pnames[parm], pct))
    cutoff <- qnorm(a)
    for(pm in parm) {
      pro <- object[[ pnames[pm] ]]
      if(length(pnames) > 1L)
        sp <- spline(x = pro[, "par.vals"][, pm], y = pro[, 1])
      else sp <- spline(x = pro[, "par.vals"], y = pro[, 1])
      ci[pnames[pm], ] <- approx(sp$y, sp$x, xout = cutoff)$y
    }
    drop(ci)
  }

logLik.polr <- function(object, ...)
  structure(-0.5 * object$deviance, df = object$edf, class = "logLik")

simulate.polr <- function(object, nsim = 1, seed = NULL, ...)
{
  if(!is.null(object$model) && any(model.weights(object$model) != 1))
    stop("weighted fits are not supported")
  
  rgumbel <- function(n, loc = 0, scale = 1) loc - scale*log(rexp(n))
  
  ## start the same way as simulate.lm
  if(!exists(".Random.seed", envir = .GlobalEnv, inherits = FALSE))
    runif(1)                     # initialize the RNG if necessary
  if(is.null(seed))
    RNGstate <- get(".Random.seed", envir = .GlobalEnv)
  else {
    R.seed <- get(".Random.seed", envir = .GlobalEnv)
    set.seed(seed)
    RNGstate <- structure(seed, kind = as.list(RNGkind()))
    on.exit(assign(".Random.seed", R.seed, envir = .GlobalEnv))
  }
  rfun <- switch(object$method, logistic = rlogis, probit = rnorm,
                 cloglog = rgumbel, cauchit = rcauchy)
  eta <- object$lp
  n <- length(eta)
  res <- cut(rfun(n*nsim, eta),
             c(-Inf, object$zeta, Inf),
             labels = colnames(fitted(object)),
             ordered_result = TRUE)
  val <- split(res, rep(seq_len(nsim), each=n))
  names(val) <- paste("sim", seq_len(nsim), sep="_")
  val <- as.data.frame(val)
  if (!is.null(nm <- rownames(fitted(object)))) row.names(val) <- nm
  attr(val, "seed") <- RNGstate
  val
}
```

```{r read-source-data, include=FALSE, cache=TRUE}
# Read source data
ncdb_2017 <- read_csv("NCDB_2017.csv")
ncdb_2016 <- read_csv("NCDB_2016.csv")
```

```{r prepare-2017-data, include=FALSE, cache=TRUE}
# Convert variables to factors:
ncdb_2017 <- ncdb_2017 %>%
  mutate(C_CASE = factor(C_CASE),
         C_MNTH = factor(C_MNTH,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", 
                                    "09", "10", "11", "12", "UU"),
                         labels = c("January", "February", "March", "April", "May", "June", "July", "August",
                                    "September", "October", "November", "December", "Unknown")),
         C_SEV = factor(C_SEV, 
                        levels = c("1", "2", "U", "X"),
                        labels = c("1+ Fatality", "Non-fatal injury", "Unknown", "Unavailable")),
         C_CONF = factor(C_CONF,
                         levels = c("01", "02", "03", "04", "05", "06", 
                                    "21", "22", "23", "24", "25", 
                                    "31", "32", "33", "34", "35", "36",
                                    "41",
                                    "QQ", "UU", "XX"),
                         labels = c("Hit a Moving Object",
                                    "Hit a stationary object",
                                    "Ran off left shoulder",
                                    "Ran off right shoulder",
                                    "Rollover on roadway",
                                    "Other Single Vehicle",
                                    "Rear-end collision",
                                    "Side swipe",
                                    "One vehicle passing to the left of the other, or left turn conflict",
                                    "One vehicle passing to the right of the other, or right turn conflict",
                                    "Any other two vehicle - same direction of travel configuration",
                                    "Head-on collision",
                                    "Approaching side-swipe",
                                    "Left turn across opposing traffic",
                                    "Right turn, including turning conflicts",
                                    "Right angle collision",
                                    "Any other two-vehicle - different direction of travel configuration",
                                    "Hit a parked motor vehicle",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RCFG = factor(C_RCFG,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "QQ", "UU", "XX"),
                         labels = c("Non-intersection", 
                                    "Intersection", 
                                    "Intersection with Entrance",
                                    "Railroad Level Crossing", 
                                    "Bridge/Overpass/Viaduct",
                                    "Tunnel/Underpass",
                                    "Passing or climbing lane",
                                    "Ramp",
                                    "Traffic circle",
                                    "Freeway Express Lane",
                                    "Freeway Collector Lane",
                                    "Freeway Transfer Lane",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_WTHR = factor(C_WTHR,
                         levels = c("1", "2", "3", "4", "5", "6", "7", "Q", "U", "X"),
                         labels = c("Clear and sunny",
                                    "Overcast, cloudy but no precipitation",
                                    "Raining",
                                    "Snowing, not including drifting snow",
                                    "Freezing rain, sleet, hail",
                                    "Visibility limitation",
                                    "Strong wind",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RSUR = factor(C_RSUR,
                         levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "Q", "U", "X"),
                         labels = c("Dry",
                                    "Wet",
                                    "Fresh Loose Snow",
                                    "Slush/Wet Snow",
                                    "Icy",
                                    "Sand/Gravel/Dirt",
                                    "Muddy",
                                    "Oil",
                                    "Flooded",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RALN = factor(C_RALN,
                         levels = c("1", "2", "3", "4", "5", "6", "Q", "U", "X"),
                         labels = c("Straight and level",
                                    "Straight with gradient",
                                    "Curved and level",
                                    "Curved with gradient",
                                    "Top of hill or gradient",
                                    "Bottom of hill or gradient",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_TRAF = factor(C_TRAF,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "QQ", "UU", "XX"),
                         labels = c("Operational Traffic Signals",
                                    "Flashing Traffic",
                                    "Stop Sign",
                                    "Yield sign",
                                    "Warning sign",
                                    "Pedestrian crosswalk",
                                    "Police officer",
                                    "School guard",
                                    "School crossing",
                                    "Reduced speed zone",
                                    "No passing zone sign",
                                    "Markings on the road",
                                    "School bus stopped with school bus signal lights flashing",
                                    "School bus stopped with school bus signal lights not flashing",
                                    "Railway crossing with signals, or signals and gates",
                                    "Railway crossing with signs only",
                                    "Control device not specified",
                                    "No control present",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         V_ID = factor(V_ID),
         V_TYPE = factor(V_TYPE,
                         levels = c("01", 
                                    "05", "06", 
                                    "07", "08", "09", "10", "11", 
                                    "14", 
                                    "16", 
                                    "17", 
                                    "18", "19", "20", "21", "22", "23", 
                                    "NN", 
                                    "QQ", 
                                    "UU"),
                         labels = c("Light Duty Vehicles", 
                                    "Vans and Light Trucks", "Vans and Light Trucks", 
                                    "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles",
                                    "Motorcycle/Moped",
                                    "Off-road motor vehicles",
                                    "Bicycle",
                                    "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles",
                                    "Not Applicable",
                                    "Other",
                                    "Unknown")),
         P_ID = factor(P_ID),
         P_SEX = factor(P_SEX, 
                        levels = c("F", "M", "N", "U", "X"),
                        labels = c("Female", "Male", "Not Applicable", "Unknown", "Not Available")),
         P_AGE = ifelse(P_AGE == "NN" | P_AGE == "UU" | P_AGE == "XX", NA, P_AGE),
         P_AGE = as.numeric(P_AGE),
         P_PSN = ifelse(P_PSN == 11, "Driver", P_PSN),
         P_PSN = ifelse(P_PSN == 99, "Pedestrian", P_PSN),
         P_PSN = factor(P_PSN),
         P_ISEV = ifelse(P_ISEV == "N" | P_ISEV == "U" | P_ISEV == "X", NA, P_ISEV),
         P_ISEV = factor(P_ISEV, 
                         levels = c("1", "2", "3", "NA"),
                         labels = c("No Injury", "Injury", "Fatality", "NA"),
                         ordered = TRUE),
         P_SAFE = factor(P_SAFE, 
                         levels = c("01", "02", "09", "10", "11", "12", "13", "NN", "QQ", "UU", "XX"),
                         labels = c("No Safety Device", "Safety Device", "Helmet", "Reflective Clothing", "Helmet and Clothing", "Other", "Vehicle not Equiped", "Not Applicable", "Other", "Unknown", "Not Available")),
         P_USER = factor(P_USER, 
                         c("1", "2", "3", "4", "5", "U"), 
                         labels = c("Driver", "Passenger", "Pedestrian", "Bicyclist", "Motorcyclist", "Unknown")))
```

```{r prepare-2016-data, include=FALSE, cache=TRUE}
# Convert variables to factors:
ncdb_2016 <- ncdb_2016 %>%
  mutate(C_CASE = factor(C_CASE),
         C_MNTH = factor(C_MNTH,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", 
                                    "09", "10", "11", "12", "UU"),
                         labels = c("January", "February", "March", "April", "May", "June", "July", "August",
                                    "September", "October", "November", "December", "Unknown")),
         C_SEV = factor(C_SEV, 
                        levels = c("1", "2", "U", "X"),
                        labels = c("1+ Fatality", "Non-fatal injury", "Unknown", "Unavailable")),
         C_CONF = factor(C_CONF,
                         levels = c("01", "02", "03", "04", "05", "06", 
                                    "21", "22", "23", "24", "25", 
                                    "31", "32", "33", "34", "35", "36",
                                    "41",
                                    "QQ", "UU", "XX"),
                         labels = c("Hit a Moving Object",
                                    "Hit a stationary object",
                                    "Ran off left shoulder",
                                    "Ran off right shoulder",
                                    "Rollover on roadway",
                                    "Other Single Vehicle",
                                    "Rear-end collision",
                                    "Side swipe",
                                    "One vehicle passing to the left of the other, or left turn conflict",
                                    "One vehicle passing to the right of the other, or right turn conflict",
                                    "Any other two vehicle - same direction of travel configuration",
                                    "Head-on collision",
                                    "Approaching side-swipe",
                                    "Left turn across opposing traffic",
                                    "Right turn, including turning conflicts",
                                    "Right angle collision",
                                    "Any other two-vehicle - different direction of travel configuration",
                                    "Hit a parked motor vehicle",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RCFG = factor(C_RCFG,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "QQ", "UU", "XX"),
                         labels = c("Non-intersection", 
                                    "Intersection", 
                                    "Intersection with Entrance",
                                    "Railroad Level Crossing", 
                                    "Bridge/Overpass/Viaduct",
                                    "Tunnel/Underpass",
                                    "Passing or climbing lane",
                                    "Ramp",
                                    "Traffic circle",
                                    "Freeway Express Lane",
                                    "Freeway Collector Lane",
                                    "Freeway Transfer Lane",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_WTHR = factor(C_WTHR,
                         levels = c("1", "2", "3", "4", "5", "6", "7", "Q", "U", "X"),
                         labels = c("Clear and sunny",
                                    "Overcast, cloudy but no precipitation",
                                    "Raining",
                                    "Snowing, not including drifting snow",
                                    "Freezing rain, sleet, hail",
                                    "Visibility limitation",
                                    "Strong wind",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RSUR = factor(C_RSUR,
                         levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "Q", "U", "X"),
                         labels = c("Dry",
                                    "Wet",
                                    "Fresh Loose Snow",
                                    "Slush/Wet Snow",
                                    "Icy",
                                    "Sand/Gravel/Dirt",
                                    "Muddy",
                                    "Oil",
                                    "Flooded",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_RALN = factor(C_RALN,
                         levels = c("1", "2", "3", "4", "5", "6", "Q", "U", "X"),
                         labels = c("Straight and level",
                                    "Straight with gradient",
                                    "Curved and level",
                                    "Curved with gradient",
                                    "Top of hill or gradient",
                                    "Bottom of hill or gradient",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         C_TRAF = factor(C_TRAF,
                         levels = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "QQ", "UU", "XX"),
                         labels = c("Operational Traffic Signals",
                                    "Flashing Traffic",
                                    "Stop Sign",
                                    "Yield sign",
                                    "Warning sign",
                                    "Pedestrian crosswalk",
                                    "Police officer",
                                    "School guard",
                                    "School crossing",
                                    "Reduced speed zone",
                                    "No passing zone sign",
                                    "Markings on the road",
                                    "School bus stopped with school bus signal lights flashing",
                                    "School bus stopped with school bus signal lights not flashing",
                                    "Railway crossing with signals, or signals and gates",
                                    "Railway crossing with signs only",
                                    "Control device not specified",
                                    "No control present",
                                    "Other",
                                    "Unknown",
                                    "Not Available")),
         V_ID = factor(V_ID),
         V_TYPE = factor(V_TYPE,
                         levels = c("01", 
                                    "05", "06", 
                                    "07", "08", "09", "10", "11", 
                                    "14", 
                                    "16", 
                                    "17", 
                                    "18", "19", "20", "21", "22", "23", 
                                    "NN", 
                                    "QQ", 
                                    "UU"),
                         labels = c("Light Duty Vehicles", 
                                    "Vans and Light Trucks", "Vans and Light Trucks", 
                                    "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles",
                                    "Motorcycle/Moped",
                                    "Off-road motor vehicles",
                                    "Bicycle",
                                    "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles", "Heavy Vehicles",
                                    "Not Applicable",
                                    "Other",
                                    "Unknown")),
         P_ID = factor(P_ID),
         P_SEX = factor(P_SEX, 
                        levels = c("F", "M", "N", "U", "X"),
                        labels = c("Female", "Male", "Not Applicable", "Unknown", "Not Available")),
         P_AGE = ifelse(P_AGE == "NN" | P_AGE == "UU" | P_AGE == "XX", NA, P_AGE),
         P_AGE = as.numeric(P_AGE),
         P_PSN = ifelse(P_PSN == 11, "Driver", P_PSN),
         P_PSN = ifelse(P_PSN == 99, "Pedestrian", P_PSN),
         P_PSN = factor(P_PSN),
         P_ISEV = ifelse(P_ISEV == "N" | P_ISEV == "U" | P_ISEV == "X", NA, P_ISEV),
         P_ISEV = factor(P_ISEV, 
                         levels = c("1", "2", "3", "NA"),
                         labels = c("No Injury", "Injury", "Fatality", "NA"),
                         ordered = TRUE),
         P_SAFE = factor(P_SAFE, 
                         levels = c("01", "02", "09", "10", "11", "12", "13", "NN", "QQ", "UU", "XX"),
                         labels = c("No Safety Device", "Safety Device", "Helmet", "Reflective Clothing", "Helmet and Clothing", "Other", "Vehicle not Equiped", "Not Applicable", "Other", "Unknown", "Not Available")),
         P_USER = factor(P_USER, 
                         c("1", "2", "3", "4", "5", "U"), 
                         labels = c("Driver", "Passenger", "Pedestrian", "Bicyclist", "Motorcyclist", "Unknown")))
```

Introduction
==========================

Modelling the severity of injuries to victims of road crashes has been a preoccupation of transportation researchers, planners, auto insurance companies, governments, and the general public for decades. One of the earliest studies to investigate the severity of injuries conditional on a collision having occurred was by White and Clayton [-@White1972effects]. Kim et al. [-@Kim1995personal] later stated that the "linkages between severity of injury and driver characteristics and behaviors have not been thoroughly investigated" (p. 470). Nowadays, there is a burgeoning literature on this subject, which often relies on multivariate analysis of crash severity to clarify the way various factors can affect the outcome of an incident, and to discriminate between various levels of injury.

Crash severity is an active area of research, and one where methodological developments have aimed at improving the reliability, accuracy, and precision of models [e.g., @Savolainen2011statistical; @Yasmin2013evaluating; @Bogue2017modified]. Of interest in this literature is how different parties in a crash interact to influence the severity of individual outcomes. The importance of these interactions has been recognized by numerous authors [e.g., @Chiou2013modeling; @Lee2014analysis; @Torrao2014modeling; @Li2017interplay]. Lee and Li [-@Lee2014analysis] for instance, note that "[for] two-vehicle crashes, most studies only considered the effects of one vehicle on driver’s injury severity or the highest injury severity of two drivers. However, it is expected that driver’s injury severity is not only affected by characteristics of his/her own vehicle, but also characteristics of a partner vehicle." More generally, the severity of the outcome depends, at least in part, on the characteristics of the parties, and a crash between two heavy vehicles is likely to have very different outcomes compared to crash where a heavy vehicle hits a pedestrian.

For the purpose of this paper, we define a party as one or more individuals travelling in a traffic unit that becomes involved in a crash. Sometimes the traffic unit is a vehicle, and the party is a single individual (i.e. a single occupant vehicle); but in other cases, a party could consist of several individuals (i.e., a driver and one or more passengers). Other times, the individual _is_ the traffic unit, for instance a pedestrian or a bicyclist. An opponent is a different party that is involved in the same collision. In the literature, interactions between parties in a collision are treated by means of different strategies, including the use of _data subsetting_, _opponent variables_, and estimating models with _hierarchical components_. These strategies are not new, however, a systematic comparison between them is missing from the literature. For this reason, the objective of this paper is to empirically evaluate different strategies to model party interactions in crash severity in the context of incidents involving two parties. More concretely, this research aims to:

1. Systematize the analysis of party interactions in crash severity models. Although every strategy considered here has been used in past research, in this paper they are organized in a way that clarifies their operation.

2. Present a data management workflow to prepare a dataset to implement analysis of opponent effects.

3. Provide evidence of the performance of different modelling strategies. In particular, the importance of considering opponent-level effects and the suitability of single-level models.

4. Present an example of reproducible research in crash severity analysis: all data and code are publicly available from the beginning of the peer-review process\footnote{The source file for this paper is an `R` Markdown document; all code and data necessary to reproduce the analysis are available from the following GitHub repository: \url{https://github.com/paezha/Modelling-Participant-Interactions-in-Crash-Severity}}.
 
For the assessment we use data from Canada's National Collision Database, a database that collects all police-reported collisions in the country. Using the most recent version of the data set (2017). Three levels of crash severity (no injury/injury/fatality) are analyzed using ordered logit models, and covariates for the parties in the crash and the conditions of the crash. For model assessment, we conduct an in-sample prediction exercise using the estimation sample (i.e., _nowcasting_), and also an out-of-sample prediction exercise using the data set corresponding to 2016 (i.e., _backcasting_). The models are assessed using predicted shares and predicted classes of outcomes at the individual level, using an extensive array of verification statistics.

The rest of this paper is structured as follows. In Section \ref{sec:background} we discuss some background matters, and follow this with a concise review of the modelling strategies used to analyze crash severity \ref{sec:methods}. Section \ref{sec:application} describes the data requirements, data preprocessing, and the modelling strategies, along with the results of model estimation. The results of assessing the models and the discussion of these results is found in Section \ref{sec:assessment}. We then present some additional thoughts about the applicability of this approach in Section \ref{sec:further-considerations} before offering some concluding remarks in Section \ref{sec:concluding-remarks}.

Background {#sec:background}
============

Crash severity is often modeled using models for discrete outcomes. Analysts interested in crash severity have at their disposal an ample repertoire of models to choose from, including classification techniques from machine learning [e.g., @Iranitalab2017comparison; @Khan2015exploring; @Chang2006analysis; @Effati2015geospatial], Poisson models for counts [e.g., @Ma2008multivariate], unordered logit/probit models [e.g., @Tay2011multinomial], as well as ordered logit/probit models [e.g., @Rifaat2007accident], with numerous variants, such as random parameters/mixed logit [e.g., @Aziz2013exploring; @Haleem2013effect], partial proportional odds models [e.g., @Mooradian2013analysis; @Sasidharan2014partial], and the use of copulas [e.g., @Wang2015copula]. Recent reviews of methods include Savolainen et al. [-@Savolainen2011statistical], Yasmin and Eluru [-@Yasmin2013evaluating], and Mannering et al. [-@Mannering2016unobserved].

Irrespective of the modelling framework employed, models of crash severity often include variables in several categories, as shown with examples in Table \ref{tab:variable-categories} [also see @Montella2013crash]. Many crash databases and analyses also account for the multi-event nature of many crashes. Individuals in the crash may have had different roles depending on their situation, with some acting as operators of a vehicle (i.e., drivers, bicyclists), while others were passengers. They also may differ depending on what type of traffic unit they were, for example pedestrians, or operators/passengers of a vehicle. The multiplicity of roles makes for complicated modelling decisions when trying to understand the severity of injuries; for example, what is the unit of analysis, the person, the traffic unit, or the collision? Not surprisingly, it is possible to find examples of studies that adopt different perspectives. A common simplifying strategy in model specification is to consider only _drivers_ and/or only _single-vehicle_ crashes [e.g., @Kim2013driver; @Lee2014analysis; @Gong2017modeling; @Osman2018injury]. This strategy reduces the dimensions of the event, and it becomes possible, for example, to equate the traffic unit to the person for modelling purposes. 

The situation becomes more complex when dealing with events that involve two traffic units [e.g., @Torrao2014modeling; @Wang2015copula] and multi-traffic unit crashes [e.g., @Wu2014mixed; @Bogue2017modified]. Different strategies have been developed to study these, more complex events. A number of studies advocate the estimation of separate models for different parties, individuals, and/or situations. In this way, Wang and Kockelman [-@Wang2005use] estimated models for single-vehicle and two-vehicle crashes, while Savolainen and Mannering [-@Savolainen2007probabilistic] estimated models for single-vehicle and multi-vehicle crashes. More recently, Duddu et al. [-@Duddu2018modeling] and Penmetsa et al. [-@Penmetsa2017examining] presented research that estimated separate models for at-fault and not-at-fault drivers. The strategy of estimating separate models relies on _subsetting_ the data set, although it is possible to link the relevant models more tightly by means of a common covariance structure, as is the case of bivariate models [e.g., @Chiou2013modeling; @Chen2019investigation] or models with copulas [e.g., @Rana2010copula; @Shamsunnahar2014examining; @Wang2015copula].

A related strategy to specify crash severity models is to organize the data in such a way that it is possible to introduce _opponent effects_. There are numerous examples of studies that consider at least some characteristics of the opposite party (or parties) in two- or multi-vehicle crashes. For example, Wang and Kockelman [-@Wang2005use] considered the type of the opposite vehicle in their model for two-vehicle collisions. Similarly, Torrao et al. [-@Torrao2014modeling] included in their analysis the age, wheelbase, weight, and engine size of the opposite vehicle, while Bogue et al. [-@Bogue2017modified] used the body type of the opposite vehicle. Penmetsa et al. [-@Penmetsa2017examining] and Duddu et al. [-@Duddu2018modeling] are two of the most comprehensive examples of using opponent's information, as they included attributes of individuals in the opposite party (their physical condition, sex, and age), as well as characteristics of the other party's traffic unit (the vehicle type of the opponent). The twin strategies of subsetting the sample and using the attributes of the opponent are not mutually exclusive, but neither are they used consistently together, as a scan of the literature reveals.

Another strategy is to introduce _hierarchical components_ in the model, a technique widely used in the hierarchical or multi-level modelling literature. This involves considering observations as being nested at different levels: individuals nested in traffic units, which in turn are nested in accidents, as an example.

In this paper we consider three general modelling strategies, as follows:

- Strategy 1. Introducing opponent-related factors

- Strategy 2. Single-level model and multi-level (hierarchical) model specifications

- Strategy 3. Full sample and sample subsetting

These are discussed in more detail in the following section.

```{r table-variable-categories, echo=FALSE}
data.frame(Category = c("Human-factors",
                        "Traffic unit-factors",
                        "Environmental-factors",
                        "Road-factors",
                        "Opponent-related factors"),
           Examples = c("Attributes of individuals in the crash, e.g., injury status, age, gender, licensing status, professional driver status",
                        "Attributes of the traffic unit, e.g., type of traffic unit (pedestrian, car, motorcycle, etc.), maneuver, etc.",
                        "Attributes of the crash, e.g., location, weather conditions, light conditions, number of parties, etc.",
                        "Attributes of the road, e.g., surface condition, grade, geometry, etc.",
                        "Attributes of the opponent, e.g., age of opponent, gender of opponent, opponent vehicle type, etc.")) %>%
  kable(booktabs = T,
        caption = "\\label{tab:variable-categories}Categories of variables used in the analysis of crash severity with examples") %>% 
  column_spec(2, width = "22em") %>%
  kable_styling(font_size = 7)
```

Methods {#sec:methods}
============

## Choice of model

Before describing the modelling strategies, it is important to explain our choice of model. There have already been comparisons between different models. Yasmin and Eluru [-@Yasmin2013evaluating], for instance, conducted an extensive comparison of models for discrete outcomes in crash severity analysis, and found only small differences in the performance of unordered models and ordered models; however, ordered models are usually more parsimonious since only one latent functions needs to be estimated for all outcomes, as opposed to one for each outcome in unordered models. Bogue et al. [-@Bogue2017modified] also compared unordered and ordered models in the form of the mixed multinomial logit and a modified rank ordered logit, respectively, and found that the ordered model performed best. To keep the empirical assessment manageable, in this paper we will consider only the ordinal logit model, and will comment on potential extensions in Section \ref{sec:further-considerations}.

The ordinal model is a latent-variable approach, whereby the severity of the crash (observed) is linked to an underlying latent variable that is a function of the variables of interest, as follows:

\begin{equation}
\label{eq:latent-function}
y_{itk}^*=\sum_{l=1}^L\alpha_lp_{itkl} + \sum_{m=1}^M\beta_mu_{tkm} + \sum_{q=1}^Q\kappa_qc_{kq} + \epsilon_{itk}
\end{equation}

The left-hand side of the expression above ($y_{itk}^*$) is a latent (unobservable) variable that is associated with the severity of crash $k$ ($k=1,\cdots,K$) for individual $i$ in traffic unit $t$. The right-hand side of the expression is split in four parts. The first part gathers $l=1,\cdots,L$ human-factors $p$ for individual $i$ in traffic unit $t$ and crash $k$; these could relate to the person (e.g., age, gender, and road user class). The second part gathers $m=1,\cdots,M$ attributes $u$ related to traffic unit $t$ in crash $k$; these could be items such as maneuver or vehicle type. The third part gathers $q=1,\cdots,Q$ attributes $c$ related to the crash $k$, including environmental-factors and road-factors, such as weather conditions, road alignment, and type of surface. Lastly, the fourth element is a random term specific to individual $i$ in traffic unit $t$ and crash $k$. The function consists of a total of $Z=L+M+Q$ covariates and associated parameters.

For conciseness, in what follows we will abbreviate the function as follows:

\begin{equation}
\label{eq:latent-function-compact}
y_{itk}^*=\sum_{z=1}^Z\theta_zx_{itkz} + \epsilon_{itk}
\end{equation}

The latent variable is not observed directly, but it is possible to posit a probabilistic relationship with the outcome $y_{itk}$ (the severity of crash $k$ for individual $i$ in traffic unit $t$). Depending on the characteristics of the data and the assumptions made about the random component of the latent function different models can be obtained. For example, if crash severity is coded as a variable with three outcomes (e.g., property damage only/injury/fatal), we can relate the latent variable to the outcome as follows:

\begin{equation}
\label{eq:latent-function-ordered-outcomes}
y_{itk} = 
\begin{cases}
\text{fatality} & \text{if } y_{itk}^*> \mu_2\\
\text{injury} & \text{if } \mu_1< y_{itk}^*< \mu_2\\
\text{PDO} & \text{if } y_{itk}^*< \mu_1
\end{cases}
\end{equation}

\noindent where $\mu_1$ and $\mu_2$ are estimable thresholds. Due to the stochastic nature of the latent function, the outcome of the crash is not fully determined. However, we can make the following probability statements:

\begin{equation}
\label{eq:probability-ordered-outcomes}
\begin{array}{rcl}\
P(y_{itk} = \text{PDO}) &=& 1 - P(y_{itk} = \text{injury}) - P(y_{itk} = \text{fatality})\\ 
P(y_{itk} = \text{injury}) &=& P(\mu_1 - \sum_{z=1}\theta_zp_{itkz} < \epsilon_{itk} < \mu_2 - \sum_{z=1}\theta_zp_{itkz})\\
P(y_{itk} = \text{fatality}) &=& P(\epsilon_{itk} < \mu_1 - \sum_{z=1}\theta_zp_{itkz})
\end{array}
\end{equation}

If the random terms are assumed to follow the logistic distribution, the ordered logit model is obtained; if the normal distribution, then the ordered probit model. Estimation methods for these models are very well-established [e.g., @Maddala1986limited; @Train2009discrete]. There are numerous variations of the basic modelling framework above, including hierarchical models, bivariate models, multinomial models, and Bayesian models, among others [see @Savolainen2011statistical for a review of methods].

## Strategy 1: opponent-related factors 

When opponent-related variables are included, the function is augmented as follows:

\begin{equation}
\label{eq:latent-function-with-opponent-variables}
y_{itk}^*=\sum_{l=1}^L\alpha_lp_{itkl} + \sum_{m=1}^M\beta_mu_{tkm} + \sum_{q=1}^Q\kappa_qc_{kq} + \sum_{r=1}^R\delta_ro_{jvkr} + \epsilon_{itk}
\end{equation}

This function includes one additional summation compared to Equation \ref{eq:latent-function-ordered-outcomes}. This summation gathers $r=1,\cdots,R$ attributes $o$ related to individual $j$ in traffic unit $v$ that was an opposite party to individual $i$ in traffic unit $t$ in crash $k$. These attributes could be individual characteristics of the operator of the opposite traffic unit (such as age and gender) and/or characteristics of the opposite traffic unit (such as vehicle type or weight). To qualify as an opposite party, individual $j$ must have been an individual in crash $k$ but operating traffic unit $v\ne t$. Sometimes the person _is_ the traffic unit, as is the case of a pedestrian. And we exclude passengers of vehicles as opponents, since they do not operate the traffic unit. In case the opponent attributes include only characteristics of the traffic unit, the condition for the traffic unit to be an opponent is that it was part of crash $k$ and was different from $t$. After introducing this new set of terms, the latent function now consists of a total of $Z=L+M+Q+R$ covariates and associated parameters.

## Strategy 2: hierarchical model specification

We can choose to conceptualize the event leading to the outcome as a hierarchical process. There are a few different ways of doing this. For example, the hierarchy could be based on individuals in traffic units. In this case, we can rewrite the latent function as follows:

\begin{equation}
\label{eq:latent-function-with-hierarchical-traffic-unit}
y_{itk}^*=\sum_{m=1}^M\beta_mu_{tkm} + \sum_{q=1}^Q\kappa_qc_{kq} + \sum_{r=1}^R\delta_ro_{jvkr} + \epsilon_{itk}
\end{equation}

The coefficients of the traffic unit nest the individual attributes as follows. For any given coefficient $m$:

\begin{equation}
\label{eq:hierarchical-traffic-unit-coefficients}
\beta_{m}=\sum_{l=1}^L\beta_{ml}p_{itkl} 
\end{equation}

Therefore, the corresponding term in the latent function becomes (assuming that $p_{itk1} = 1$, i.e., it is a constant term):

\begin{equation}
\label{eq:hierarchical-traffic-unit-coefficients}
\begin{array}{rcl}\
\beta_{m}u_{tkm} &=& \big( \beta_{m1} + \beta_{m2}p_{itk2} + \cdots + \beta_{mL}p_{itkL}\big)u_{tkm}\\ 
&=& \beta_{m1}u_{tkm} + \beta_{m2}p_{itk2}u_{tkm} + \cdots + \beta_{mL}p_{itkL}u_{tkm}
\end{array}
\end{equation}

As an alternative, the nesting unit could be the interaction person-opponent, in which case the opponent-level attributes are nested in the following fashion: 

\begin{equation}
\label{eq:latent-function-with-opponent-variables}
y_{itk}^*=\sum_{l=1}^L\alpha_lp_{itkl} + \sum_{m=1}^M\beta_mu_{tkm} + \sum_{q=1}^Q\kappa_qc_{kq} + \epsilon_{itk}
\end{equation}

\noindent with any person-level coefficient $l$ that we wish to expand defined as follows:

\begin{equation}
\label{eq:hierarchical-traffic-unit-coefficients}
\alpha_{l}=\sum_{r=1}^R\alpha_{lr}o_{jvkr}
\end{equation}

\noindent with the same conditions as before, that $j\ne i$ is the operator of traffic unit $v\ne t$. The corresponding term in the latent function is now (assuming that $o_{jvk1}=1$, i.e., it is a constant term):

\begin{equation}
\label{eq:hierarchical-traffic-unit-coefficients}
\begin{array}{rcl}\
\alpha_{l}p_{itkl} &=& \big(\alpha_{l1} + \alpha_{l2}o_{jvk2} + \cdots + \alpha_{lR}o_{jvkR} \big)p_{itkl}\\
&=& \alpha_{l1}p_{itkl} + \alpha_{l2}o_{jvk2}p_{itkl} + \cdots + \alpha_{lR}o_{jvkR}p_{itkl}
\end{array} 
\end{equation}

Discerning readers will identify this model specification strategy as Casetti's expansion method [@Casetti1972generating; @Roorda2010trip]. This is a deterministic strategy for modelling contextual effects which, when augmented with random components, becomes the well-known multi-level modelling method [@Hedeker1994random, more on this in Section \ref{sec:further-considerations}]. It is worthwhile to note that higher-order hierarchical effects are possible; for instance, individual attributes nested within traffic units, which in turn are nested within collisions. We do not explore higher-level hierarchies further in the current paper.

## Strategy 3: sample subsetting

The third model specification strategy that we will consider is subsetting the sample. This is applicable in conjunction with any of the other strategies discussed above. In essence, we define the latent function with restrictions as follows. Consider a continuous variable, e.g., age of person, and imagine that we wish to concentrate the analysis on older adults [e.g., @Dissanayake2002factors]. The latent function is defined as desired (see above), however, the following restriction is applied to the sample:

\begin{equation}
\label{eq:sampling-age}
\text{Age of individual } i \text{ in traffic unit } t \text{ in crash } k = 
\begin{cases}
\ge 65 & \text{use record } itk\\
< 65 & \text{do not use record } itk
\end{cases}
\end{equation}

Suppose instead that we are interested in crashes by or against a specific type of traffic unit [e.g., pedestrians, @Amoh2017effect]:

\begin{equation}
\label{eq:sampling-pedestrian}
\text{Road user class of individual } i \text{ in traffic unit } t \text{ in crash } k = 
\begin{cases}
\text{Pedestrian} & \text{use record } itk\\
\text{Not pedestrian} & \text{do not use record } itk
\end{cases}
\end{equation}

\noindent or:

\begin{equation}
\label{eq:sampling-pedestrian-opponent}
\text{Road user class of individual } j \text{ in traffic unit } v \text{ in crash } k = 
\begin{cases}
\text{Pedestrian} & \text{use record } jvk\\
\text{Not pedestrian} & \text{do not use record } jvk
\end{cases}
\end{equation}

More generally, for any variable $x$ of interest:

\begin{equation}
\label{eq:sampling-general}
x_{itk} = 
\begin{cases}
\text{Condition: TRUE} & \text{use record } itk\\
\text{Condition: FALSE} & \text{do not use record } itk
\end{cases}
\end{equation}

Several conditions can be imposed to subset the sample in any way that the analyst deems appropriate or suitable.

Setting for empirical assessment {#sec:application}
============

In this section we present the setting for the empirical assessment of the modelling strategies discussed in Section \ref{sec:methods}, namely matters related to data and model estimation.

## Data for empirical assessment {#sec:data}

To assess the performance of the various modelling strategies we use data from Canada's National Collision Database (NCDB). This database contains all police-reported motor vehicle collisions on public roads in Canada. Data are originally collected by provinces and territories, and shared with the federal government, that proceeds to combine, track, and analyze them for reporting deaths, injuries, and collisions in Canada at the national level. The NCDB is provided by Transport Canada, the agency of the federal government of Canada in charge of transportation policies and programs, under the Open Government License - Canada version 2.0 [https://open.canada.ca/en/open-government-licence-canada]. 

The NCDB is available from 1999. For the purpose of this paper, we use the data corresponding to 2017, which is the most recent year available as of this writing. Furthermore, for assessment we also use the data corresponding to 2016. Similar to databases in other jurisdictions [see @Montella2013crash], the NCDB contains information pertaining to the collision, the traffic unit(s), and the person(s) involved in a crash. The definitions of variables in this database are shown in the Appendix at the end of this document, in Tables \ref{tab:ncdb-descriptives-collision}, \ref{tab:ncdb-descriptives-vehicle}, and \ref{tab:ncdb-descriptives-person}. Notice that, compared to Table \ref{tab:variable-categories}, environmental-factors variables and road-factors variables are gathered under a single variable class, namely collision-related, since they are unique for each crash.

Data are organized by person; in other words, there is one record per individual in a collision, be they drivers, passengers, pedestrians, etc. The only variable directly available with respect to opponents in a collision is the number of vehicles involved [see models in @Bogue2017modified]. Therefore, the data needs to be processed to obtain attributes of the opposing party for each individual in a collision. The protocol to do this is described next.

## Data preprocessing

To prepare the data for analysis, in particular for Strategy 1 (opponent-related factors), we apply an initial filter, whereby we scan the database to remove all records that are not a person (including parked cars and other objects) or that are missing information.

```{r initial-filter, include=FALSE}
# Remove parked cars and other objects
ncdb_2017 <- ncdb_2017 %>%
  mutate(P_ID = ifelse(P_ID == "NN" | P_ID == "UU", NA, P_ID)) %>%
  drop_na(P_ID)

# Remove records where the road user type is unknown:
ncdb_2017 <- ncdb_2017 %>%
  filter(P_USER != "Unknown")

# Remove records where the sex of the person is unknown:
ncdb_2017 <- ncdb_2017 %>%
  filter(P_SEX != "Not Applicable" & P_SEX != "Unknown" & P_SEX != "Not Available")

# Remove records where the age of the person is unknown:
ncdb_2017 <- ncdb_2017 %>%
  drop_na(P_AGE)

# Remove records where the severity of the outcome is unknown:
ncdb_2017 <- ncdb_2017 %>%
  filter(P_ISEV != "NA")
```

```{r summarize-cases, include=FALSE}
ncdb_2017_by_case <- ncdb_2017 %>%
  group_by(C_CASE)
accidents <- summarize(ncdb_2017_by_case, n = n())
```

After the initial filter, the database is summarized to find the number of individual-level records that correspond to each collision (C_CASE). At this point, there are `r format(table(accidents$n)[1], digits = 2, big.mark = ",")` collisions, involving only one (known) individual, there are `r format(table(accidents$n)[2], digits = 2, big.mark = ",")` collisions involving two parties, `r format(table(accidents$n)[3], digits = 2, big.mark = ",")` collisions with three parties, `r format(table(accidents$n)[4], digits = 2, big.mark = ",")` collisions involving four parties, `r format(table(accidents$n)[5], digits = 2, big.mark = ",")` collisions with five parties, `r format(table(accidents$n)[6], digits = 2, big.mark = ",")` collisions with six parties, and `r format(sum(table(accidents$n)[7:length(table(accidents$n))]), digits = 2, big.mark = ",")` collisions involving seven or more parties These parties were possibly occupants in different vehicles or were otherwise their own traffic units (e.g., pedestrians). Accordingly, the sample includes `r format(summary(ncdb_2017$P_USER)[1], digits = 2, big.mark = ",")` drivers, `r format(summary(ncdb_2017$P_USER)[2], digits = 2, big.mark = ",")` passengers, `r format(summary(ncdb_2017$P_USER)[3], digits = 2, big.mark = ",")` pedestrians, `r format(summary(ncdb_2017$P_USER)[4], digits = 2, big.mark = ",")` bicyclists, and `r format(summary(ncdb_2017$P_USER)[5], digits = 2, big.mark = ",")` motorcyclists. 

```{r remove-collisions-single-person, include=FALSE}
#Create a new variable with the number of records in each incident, as per the table:
ncdb_2017 <- ncdb_2017 %>%
  left_join(accidents, by = "C_CASE")

# Drop all cases with only one person involved:
ncdb_2017 <- ncdb_2017 %>%
  filter(n > 1)
```

```{r vehicles-per-collisions, include=FALSE}
# Find number of vehicles involved in each case:
ncdb_2017_by_case_veh <- ncdb_2017 %>%
  mutate(V_ID = ifelse(V_ID == "UU", NA, V_ID)) %>%
  drop_na(V_ID) %>%
  distinct(C_CASE, V_ID) %>%
  group_by(C_CASE)
veh_per_accident <- summarize(ncdb_2017_by_case_veh, n_veh = n())
table(veh_per_accident$n_veh)

# Create a new variable with the number of vehicles in each incident, as per the table:
ncdb_2017 <- ncdb_2017 %>%
  left_join(veh_per_accident, by = "C_CASE")
```

The next step is to remove all collisions that involve only one party. This still leaves numerous cases where multiple parties could have been in a single vehicle, for instance in a collision against a stationary object. Therefore, we proceed to use the vehicle sequence number to find the number of vehicles involved in each collision. This reveals that there are `r format(table(ncdb_2017$n_veh)[1], big.mark = ",")` collisions that involve only one vehicle but possibly multiple individuals (i.e., driver and one or more passengers). In addition, there are `r format(table(ncdb_2017$n_veh)[2], big.mark = ",")` collisions involving two vehicles (and possibly multiple individuals). Finally, there are `r format(sum(table(ncdb_2017$n_veh)[3:length(table(ncdb_2017$n_veh))]), big.mark = ",")` collisions with three or more vehicles.

```{r filter-two-vehicle-collisions, include=FALSE}
# Filter all cases that involve only two vehicles
ncdb_2017 <- ncdb_2017 %>%
  filter(n_veh == 2)

# Calculate the distribution of participants per two-vehicle case
people_per_two_vehicle_case <- ncdb_2017 %>%
  group_by(C_CASE) %>%
  summarize(n_people = n())
```

Once we have identified the number of vehicles in each collision, we select all cases that involve only two vehicles. The most common cases in two-vehicle collisions are those that include drivers (`r format(table(people_per_two_vehicle_case$n_people)[1], big.mark = ",")` collisions; this is reflective of the prevalence of single-occupant vehicles). This is followed by cases with passengers (`r format(table(people_per_two_vehicle_case$n_people)[2], big.mark = ",")` collisions), pedestrians (`r format(table(people_per_two_vehicle_case$n_people)[3], big.mark = ",")` collisions), bicyclists (`r format(table(people_per_two_vehicle_case$n_people)[4], big.mark = ",")` collisions), and motorcyclists (`r format(table(people_per_two_vehicle_case$n_people)[5], big.mark = ",")` collisions). The distribution of individuals per traffic unit is as follows: `r format(summary(ncdb_2017$V_ID)[1], big.mark = ",")` individuals are coded as being in V_ID = 1, `r format(summary(ncdb_2017$V_ID)[2], big.mark = ",")` individuals are coded as being in V_ID = 2, and `r format(summary(ncdb_2017$V_ID)[38], big.mark = ",")` individuals are coded as pedestrians. In addition, `r format(sum(summary(ncdb_2017$V_ID)[3:37]), big.mark = ",")` individuals are coded as being in vehicles 3 through 9, despite our earlier filter to retain only collisions with two vehicles. At this point we select only individuals assigned to vehicles 1 or 2, as well as pedestrians. As a result of this filter a number of cases with only one known individual need to be removed.

```{r filter-cases-for-vehicles-1-2-pedestrians, include=FALSE}

# Select individuals who were in vehicle 1, vehicle 2, or pedestrians
ncdb_2017 <- ncdb_2017 %>%
  filter(V_ID == "01" | V_ID == "02" | V_ID == "99")

# Check whether the number of vehicles per accident changed due to this:
ncdb_2017_by_case_veh <- ncdb_2017 %>%
  distinct(C_CASE, V_ID) %>%
  group_by(C_CASE)
veh_per_accident <- summarize(ncdb_2017_by_case_veh, n_veh = n())
table(veh_per_accident$n_veh)

#A few incidents now have only one known person. Join to the dataframe:
ncdb_2017 <- ncdb_2017 %>%
  dplyr::select(-n_veh) %>%
  left_join(veh_per_accident, by = "C_CASE")

# And select incidents that have only two correctly identified vehicles:
ncdb_2017 <- ncdb_2017 %>%
  filter(n_veh == 2)
```

```{r collisions-involving-pedestrians, include=FALSE, cache=TRUE}
# Add a label to identify whether a pedestrian was involved:
ncdb_2017_pedestrian <- ncdb_2017 %>%
  group_by(C_CASE) %>%
  summarize(Pedestrian = any(P_USER == "Pedestrian"))

# Obtain a summary of the pedestrian label:
#summary(ncdb_2017_pedestrian$Pedestrian)

# Joint to table:
ncdb_2017 <- ncdb_2017 %>%
  left_join(ncdb_2017_pedestrian, by = "C_CASE")
```

```{r split-dataframe-by-pedestrian-involvement, include=FALSE}
# To create a dataframe with opponents, it is convenient to split the dataframe in two, for cases involving pedestrians and for cases not involving pedestrians:
ncdb_2017_with_pedestrians <- ncdb_2017 %>%
  filter(Pedestrian == TRUE)

ncdb_2017_without_pedestrians <- ncdb_2017 %>%
  filter(Pedestrian == FALSE)

#Check that the split is exhaustive:
nrow(ncdb_2017) == nrow(ncdb_2017_with_pedestrians) + nrow(ncdb_2017_without_pedestrians)
```

```{r extract-pedestrians-as-main-and-opponents, include=FALSE}
# Extract pedestrians as main:
ncdb_2017_pedestrian_main <- ncdb_2017_with_pedestrians %>%
  filter(P_USER == "Pedestrian") %>%
  #dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)

# Extract pedestrians as opponent:
ncdb_2017_pedestrian_opponent <- ncdb_2017_with_pedestrians %>%
  filter(P_USER == "Pedestrian") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)
```

```{r extract-individuals-in-vehicles-as main-in-pedestrian-collisions, include=FALSE}
# Extract non-pedestrians as main:
ncdb_2017_non_pedestrian_main <- ncdb_2017_with_pedestrians %>%
  filter(P_USER != "Pedestrian") %>%
  #dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)
```

```{r extract-drivers-as-opponents-in-pedestrian-collisions, include=FALSE}
# Extract drivers as opponent:
ncdb_2017_driver_opponent <- ncdb_2017_with_pedestrians %>%
  filter(P_USER == "Driver") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)
```

```{r join-opponents-in-pedestrian-collisions, include=FALSE}
# Now join the dataframe of drivers as opponents to pedestrians as main:
ncdb_2017_pedestrian_main <- ncdb_2017_pedestrian_main %>%
  left_join(ncdb_2017_driver_opponent, by = "C_CASE")

# Also join the dataframe of pedestrians as opponents to non-pedestrians as main:
ncdb_2017_non_pedestrian_main <- ncdb_2017_non_pedestrian_main %>%
  left_join(ncdb_2017_pedestrian_opponent, by = "C_CASE")

# Notice that some cases are missing a driver. This could be because info about the driver was missing and the record was removed:
summary(ncdb_2017_pedestrian_main$P2_USER)

# Clear all records where the driver is missing as an opponent.
ncdb_2017_pedestrian_main <- ncdb_2017_pedestrian_main %>%
  drop_na(P2_USER)

# Bind the two dataframes for incidents involving pedestrians:
ncdb_2017_with_pedestrians_opponents <- rbind(ncdb_2017_non_pedestrian_main, ncdb_2017_pedestrian_main) %>%
  arrange(C_CASE)
```

```{r extract-individuals-vehicle-1-as-main, include=FALSE}
# Now, to work with the subset of records that do not involve pedestrians.
# First, we extract all individuals in vehicle 1 as main:
ncdb_2017_veh1_main <- ncdb_2017_without_pedestrians %>%
  filter(V_ID == "01") %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)
```

```{r extract-driver-vehicle-1-as-opponent, include=FALSE}
# Next, extract the driver of vehicle 1 as opponent ("driver" includes bicyclists and motorcyclists):
ncdb_2017_driver_veh1_opponent <- ncdb_2017_without_pedestrians %>%
  filter(V_ID == "01", P_USER != "Passenger") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)
```

```{r extract-individuals-vehicle-2-as-main, include=FALSE}
# Similarly, extract all individuals in vehicle 2 as main:
ncdb_2017_veh2_main <- ncdb_2017_without_pedestrians %>%
  filter(V_ID == "02") %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)
```

```{r extract-driver-vehicle-2-as-opponent, include=FALSE}
# And extract the driver of vehicle 2 as opponent:
ncdb_2017_driver_veh2_opponent <- ncdb_2017_without_pedestrians %>%
  filter(V_ID == "02", P_USER != "Passenger") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)
```

```{r join-opponents-in-vehicle-vs-vehicle-collisions, include=FALSE}
# Now join the dataframe of drivers of vehicle 1 as opponents to occupants of vehicle 2 as main:
ncdb_2017_veh2_main <- ncdb_2017_veh2_main %>%
  left_join(ncdb_2017_driver_veh1_opponent, by = "C_CASE")

# Also join the dataframe of drivers of vehicle 2 as opponents to occupants of vehicle 1 as main:
ncdb_2017_veh1_main <- ncdb_2017_veh1_main %>%
  left_join(ncdb_2017_driver_veh2_opponent, by = "C_CASE")
```

```{r include=FALSE}
# Notice that these two combined dataframe are slightly larger than the original. This is because some non-pedestrians have multiple pedestrians as opponents:
nrow(ncdb_2017_without_pedestrians) == nrow(ncdb_2017_veh1_main) + nrow(ncdb_2017_veh2_main)

# Bind the two dataframes for incidents not involving pedestrians:
ncdb_2017_without_pedestrians_opponents <- rbind(ncdb_2017_veh1_main, ncdb_2017_veh2_main) %>%
  arrange(C_CASE)

# Notice that some cases are missing a driver. This could be because info about the driver was missing and the record was removed:
summary(ncdb_2017_without_pedestrians_opponents$P2_USER)

# Clear all records where the driver is missing as an opponent.
ncdb_2017_without_pedestrians_opponents <- ncdb_2017_without_pedestrians_opponents %>%
  drop_na(P2_USER)
```

```{r bind-dataframes-with-opponent-information-and-clean, include=FALSE}
# Finally, bind the dataframes to combine all pertinent records paired with their opponents:
ncdb_2017_paired_records <- rbind(ncdb_2017_with_pedestrians_opponents, ncdb_2017_without_pedestrians_opponents) %>%
  arrange(C_CASE)

# Drop unused levels
ncdb_2017_paired_records <- droplevels(ncdb_2017_paired_records)
```

```{r summary-opponent-information, echo=FALSE}
#Cross-tabulation by user:
rbind(cbind(xtabs(~ P1_USER + P2_USER, data = ncdb_2017_paired_records),
            xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records),
            prop.table(xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records), margin = 1)),
      # Opponent: Driver
      cbind(xtabs(~ P1_USER + P2_USER, data = ncdb_2017_paired_records %>% filter(P2_USER == "Driver")),
            xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Driver")),
            prop.table(xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Driver")), margin = 1)),
      # Opponent: Pedestrian
      cbind(xtabs(~ P1_USER + P2_USER, data = ncdb_2017_paired_records %>% filter(P2_USER == "Pedestrian")),
            xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Pedestrian")),
            prop.table(xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Pedestrian")), margin = 1)),
      # Opponent: Bicyclist
      cbind(xtabs(~ P1_USER + P2_USER, data = ncdb_2017_paired_records %>% filter(P2_USER == "Bicyclist")),
            xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Bicyclist")),
            prop.table(xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Bicyclist")), margin = 1)),
      # Opponent: Motorcyclist
      cbind(xtabs(~ P1_USER + P2_USER, data = ncdb_2017_paired_records %>% filter(P2_USER == "Motorcyclist")),
            xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Motorcyclist")),
            prop.table(xtabs(~ P1_USER + P_ISEV, data = ncdb_2017_paired_records %>% filter(P2_USER == "Motorcyclist")), margin = 1))) %>%
  data.frame() %>%
  rownames_to_column(var = "P1_USER") %>%
  mutate(P1_USER = rep(c("Driver", "Passenger", "Pedestrian", "Bicyclist", "Motorcyclist"), 5),
         No.Injury.1 = ifelse(is.na(No.Injury.1), "-", format(No.Injury.1, digits = 4)),
         Injury.1 = ifelse(is.na(Injury.1), "-", format(Injury.1, digits = 4)),
         Fatality.1 = ifelse(is.na(Fatality.1), "-", format(Fatality.1, digits = 4))) %>%
  kable(booktabs = TRUE,
        digits = 4,
        col.names = c("Road User Class",
                      "Driver", 
                      "Pedestrian", 
                      "Bicyclist", 
                      "Motorcyclist", 
                      "No Injury", 
                      "Injury", 
                      "Fatality", 
                      "No Injury",
                      "Injury",
                      "Fatality"),
        caption = "\\label{tab:summary-opponent-information}Summary of opponent interactions and outcomes by road user class") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "scale_down", "hold_position")) %>%
  add_header_above(c("", "Road User Class of Opponent" = 4, "Outcome" = 3, "Proportion by Road User Class" = 3)) %>%
  pack_rows("All opponents", 1, 5) %>% 
  pack_rows("Opponent: Driver", 6, 10) %>% 
  pack_rows("Opponent: Pedestrian", 11, 15) %>% 
  pack_rows("Opponent: Bicyclist", 16, 20) %>% 
  pack_rows("Opponent: Motorcyclist", 21, 25)
```

At this point we have a complete, workable sample of individual records of parties in two-vehicle collisions. There are two possible cases for the collisions, depending on the traffic units involved: 1) vehicle vs vehicle collisions ("vehicle" is all motorized vehicles, including motorcycles/mopeds, as well as bicycles); and 2) vehicle vs pedestrian collisions. To identify the opposite parties in each collision it is convenient to classify collisions by pedestrian involvement. In this way, we find that the database includes `r format(nrow(ncdb_2017_with_pedestrians), big.mark = ",")` collisions that are vehicle vs pedestrian (possibly multiple pedestrians), and `r format(nrow(ncdb_2017_without_pedestrians), big.mark = ",")` collisions that involve two vehicles. After splitting the database according to pedestrian involvement, we can now extract relevant information about the different parties in the collision. This involves renaming the person-level variables so that we can distinguish each individual by their party in a given record. Notice that when working with individuals in vehicles, only drivers are considered opposites in a collision. 

Once the personal attributes of opposite operators in a given collision are extracted, their information is joined to the individual records by means of the collision unique identifier. As a result of this process, a new set of variables are now available for analysis: the age, sex, and road user class of the opposite driver, as well as the type of the opposite vehicle. A summary of opponent interactions and outcomes can be found in Table \ref{tab:summary-opponent-information}. The information there shows that the most common type of opponent for drivers are other drivers, followed by pedestrians. The only opponents of pedestrians, on the other hand, are drivers. Bicyclists and motorcyclists are mostly opposed by drivers, but occasionally by other road users as well. In terms of outcomes, we observe that virtually all fatalities occur when the opponent is a driver, and only very rarely when the opponent is a motorcyclist. Injuries are also more common when the opponent is a driver, whereas "no injury" is a relatively more frequent outcome when the opponent is a pedestrian or a bicyclist.

```{r dataframe-with-opponent-information-2016, include=FALSE, cache=TRUE}
# Remove parked cars and other objects
ncdb_2016 <- ncdb_2016 %>%
  mutate(P_ID = ifelse(P_ID == "NN" | P_ID == "UU", NA, P_ID)) %>%
  drop_na(P_ID)

# Remove records where the road user type is unknown:
ncdb_2016 <- ncdb_2016 %>%
  filter(P_USER != "Unknown")

# Remove records where the sex of the person is unknown:
ncdb_2016 <- ncdb_2016 %>%
  filter(P_SEX != "Not Applicable" & P_SEX != "Unknown" & P_SEX != "Not Available")

# Remove records where the age of the person is unknown:
ncdb_2016 <- ncdb_2016 %>%
  drop_na(P_AGE)

# Remove records where the severity of the outcome is unknown:
ncdb_2016 <- ncdb_2016 %>%
  filter(P_ISEV != "NA")

# Add a label to identify whether a pedestrian was involved:
ncdb_2016_pedestrian <- ncdb_2016 %>%
  group_by(C_CASE) %>%
  summarize(Pedestrian = any(P_USER == "Pedestrian"))

# Obtain a summary of the pedestrian label:
#summary(ncdb_2016_pedestrian$Pedestrian)

# Joint to table:
ncdb_2016 <- ncdb_2016 %>%
  left_join(ncdb_2016_pedestrian, by = "C_CASE")

# To create a dataframe with opponents, it is convenient to split the dataframe in two, for cases involving pedestrians and for cases not involving pedestrians:
ncdb_2016_with_pedestrians <- ncdb_2016 %>%
  filter(Pedestrian == TRUE)

ncdb_2016_without_pedestrians <- ncdb_2016 %>%
  filter(Pedestrian == FALSE)

#Check that the split is exhaustive:
nrow(ncdb_2016) == nrow(ncdb_2016_with_pedestrians) + nrow(ncdb_2016_without_pedestrians)

# Extract pedestrians as main:
ncdb_2016_pedestrian_main <- ncdb_2016_with_pedestrians %>%
  filter(P_USER == "Pedestrian") %>%
  #dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)

# Extract pedestrians as opponent:
ncdb_2016_pedestrian_opponent <- ncdb_2016_with_pedestrians %>%
  filter(P_USER == "Pedestrian") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)

# Extract non-pedestrians as main:
ncdb_2016_non_pedestrian_main <- ncdb_2016_with_pedestrians %>%
  filter(P_USER != "Pedestrian") %>%
  #dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)

# Extract drivers as opponent:
ncdb_2016_driver_opponent <- ncdb_2016_with_pedestrians %>%
  filter(P_USER == "Driver") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)

# Now join the dataframe of drivers as opponents to pedestrians as main:
ncdb_2016_pedestrian_main <- ncdb_2016_pedestrian_main %>%
  left_join(ncdb_2016_driver_opponent, by = "C_CASE")

# Also join the dataframe of pedestrians as opponents to non-pedestrians as main:
ncdb_2016_non_pedestrian_main <- ncdb_2016_non_pedestrian_main %>%
  left_join(ncdb_2016_pedestrian_opponent, by = "C_CASE")

# Notice that some cases are missing a driver. This could be because info about the driver was missing and the record was removed:
summary(ncdb_2016_pedestrian_main$P2_USER)

# Clear all records where the driver is missing as an opponent.
ncdb_2016_pedestrian_main <- ncdb_2016_pedestrian_main %>%
  drop_na(P2_USER)

# Bind the two dataframes for incidents involving pedestrians:
ncdb_2016_with_pedestrians_opponents <- rbind(ncdb_2016_non_pedestrian_main, ncdb_2016_pedestrian_main) %>%
  arrange(C_CASE)

# Now, to work with the subset of records that do not involve pedestrians.
# First, we extract all individuals in vehicle 1 as main:
ncdb_2016_veh1_main <- ncdb_2016_without_pedestrians %>%
  filter(V_ID == "01") %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)

# Next, extract the driver of vehicle 1 as opponent ("driver" includes bicyclists and motorcyclists):
ncdb_2016_driver_veh1_opponent <- ncdb_2016_without_pedestrians %>%
  filter(V_ID == "01", P_USER != "Passenger") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)

# Similarly, extract all individuals in vehicle 2 as main:
ncdb_2016_veh2_main <- ncdb_2016_without_pedestrians %>%
  filter(V_ID == "02") %>%
  rename(V1_TYPE = V_TYPE, P1_SEX = P_SEX, P1_AGE = P_AGE, P1_PSN = P_PSN, P1_SAFE = P_SAFE, P1_USER = P_USER)

# And extract the driver of vehicle 2 as opponent:
ncdb_2016_driver_veh2_opponent <- ncdb_2016_without_pedestrians %>%
  filter(V_ID == "02", P_USER != "Passenger") %>%
  dplyr::select(C_CASE, V_TYPE, P_SEX, P_AGE, P_PSN, P_SAFE, P_USER) %>%
  rename(V2_TYPE = V_TYPE, P2_SEX = P_SEX, P2_AGE = P_AGE, P2_PSN = P_PSN, P2_SAFE = P_SAFE, P2_USER = P_USER)

# Now join the dataframe of drivers of vehicle 1 as opponents to occupants of vehicle 2 as main:
ncdb_2016_veh2_main <- ncdb_2016_veh2_main %>%
  left_join(ncdb_2016_driver_veh1_opponent, by = "C_CASE")

# Also join the dataframe of drivers of vehicle 2 as opponents to occupants of vehicle 1 as main:
ncdb_2016_veh1_main <- ncdb_2016_veh1_main %>%
  left_join(ncdb_2016_driver_veh2_opponent, by = "C_CASE")

# Notice that these two combined dataframe are slightly larger than the original. This is because some non-pedestrians have multiple pedestrians as opponents:
nrow(ncdb_2016_without_pedestrians) == nrow(ncdb_2016_veh1_main) + nrow(ncdb_2016_veh2_main)

# Bind the two dataframes for incidents not involving pedestrians:
ncdb_2016_without_pedestrians_opponents <- rbind(ncdb_2016_veh1_main, ncdb_2016_veh2_main) %>%
  arrange(C_CASE)

# Notice that some cases are missing a driver. This could be because info about the driver was missing and the record was removed:
summary(ncdb_2016_without_pedestrians_opponents$P2_USER)

# Clear all records where the driver is missing as an opponent.
ncdb_2016_without_pedestrians_opponents <- ncdb_2016_without_pedestrians_opponents %>%
  drop_na(P2_USER)

# Finally, bind the dataframes to combine all pertinent records paired with their opponents:
ncdb_2016_paired_records <- rbind(ncdb_2016_with_pedestrians_opponents, ncdb_2016_without_pedestrians_opponents) %>%
  arrange(C_CASE)

# Drop unused levels
ncdb_2016_paired_records <- droplevels(ncdb_2016_paired_records)
```

## Model estimation {#sec:model-estimation}

Before model estimation, the variables are prepared as follows. First, age is scaled from years to decades. Secondly, new variables are defined to describe the vehicle type. Three classes of vehicle types are considered: 1) light duty vehicles (which in Canada include passenger cars, passenger vans, light utility vehicles, and light duty pick up trucks); 2) light trucks (all other vehicles $\le$ 4536 kg in gross vehicle weight rating); and heavy vehicles (all other vehicles $\ge$ 4536 kg in gross vehicle weight rating). Furthermore, this typology of vehicle is combined with the road user class of the individual to distinguish between drivers and passengers of light duty vehicles, light trucks, and heavy vehicles, in addition to pedestrians, bicyclists, and motorcyclists. This is done for both the individual and the opponent. Variable interactions are calculated to produce hierarchical variables. For example, for a hierarchical definition of traffic unit-level variables, age (and the square of age to account for possible non-monotonic effects) are interacted with gender, road user class, and vehicle type. For hierarchical opponent variables, age (and the square of age) are interacted with the age of opponent (and the corresponding square). The variables thus obtained are shown in Table \ref{tab:model-specification-summary}. As seen in the table, Models 1 and 2 are single-level models, and the difference between them is that Model 2 includes opponent variables. Models 3 and 4, in contrast, are hierarchical models. Model 3 considers the hierarchy on the basis of the traffic unit, while Model 4 considers the hierarchy on the basis of the opponent. 

Models 1 through 4 are estimated using the full sample. As discussed above, a related modelling strategy is to subset the sample [e.g., @Islam2014comprehensive; @Lee2014analysis; @Torrao2014modeling; @Wu2014mixed]. In this case we subset by a combination of traffic unit type of the individual (i.e., light duty vehicle, light truck, heavy vehicle, pedestrian, bicyclist, and motorcyclist) and vehicle type of the opponent (i.e., light duty vehicle, light truck, heavy vehicle). This leads to an ensemble of eighteen models to be estimated using subsets of data (see Table \ref{tab:model-specification-summary}). By subsetting the sample, at least _some_ opponent effects are incorporated implicitly. Models 1 and 2 are re-estimated using this strategy, dropping variables as necessary whenever they become irrelevant (for instance, after filtering for pedestrians, no other traffic unit types are present in the subset of data). In addition to variables that are no longer relevant in some data subsets, it is important to note that when using some data subsets a few variables had to be  occasionally dropped to avoid convergence issues. This tended to happen particularly with smaller subsets where some particular combination of attributes was rare as a result of subsampling (e.g., in 2017 there were few or no collisions that involved a motorcyclist and a heavy vehicle in a bridge, or overpass, or viaduct). The process of estimation carefully paid attention to convergence issues to ensure the validity of the models reported here.

```{r data-preparation-1, include=FALSE}
# Change age to decades and calculate the square:
# For 2017:
ncdb_2017_paired_records <- ncdb_2017_paired_records %>%
  mutate(P1_AGE = P1_AGE / 10, P1_AGE2 = P1_AGE ^2,
         P2_AGE = P2_AGE / 10, P2_AGE2 = P2_AGE ^2)

# For 2016:
ncdb_2016_paired_records <- ncdb_2016_paired_records %>%
  mutate(P1_AGE = P1_AGE / 10, P1_AGE2 = P1_AGE ^2,
         P2_AGE = P2_AGE / 10, P2_AGE2 = P2_AGE ^2)
```

```{r data-preparation-2, include=FALSE, cache=TRUE}
# Create new factors to describe the user (P_USER) and vehicle type (V_TYPE). 

# For 2017:
ncdb_2017_paired_records <- ncdb_2017_paired_records %>%
  mutate(P1_TYPE = case_when(P1_USER == "Driver" & V1_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P1_USER == "Driver" & V1_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P1_USER == "Driver" & V1_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P1_USER == "Passenger" & V1_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P1_USER == "Pedestrian" ~ "Pedestrian",
                             P1_USER == "Bicyclist" ~ "Bicyclist",
                             P1_USER == "Motorcyclist" ~ "Motorcyclist"),
         P1_TYPE = factor(P1_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")),
         P2_TYPE = case_when(P2_USER == "Driver" & V2_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P2_USER == "Driver" & V2_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P2_USER == "Driver" & V2_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P2_USER == "Passenger" & V2_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P2_USER == "Pedestrian" ~ "Pedestrian",
                             P2_USER == "Bicyclist" ~ "Bicyclist",
                             P2_USER == "Motorcyclist" ~ "Motorcyclist"),
         P2_TYPE = factor(P2_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")))

# For 2016:
ncdb_2016_paired_records <- ncdb_2016_paired_records %>%
  mutate(P1_TYPE = case_when(P1_USER == "Driver" & V1_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P1_USER == "Driver" & V1_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P1_USER == "Driver" & V1_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P1_USER == "Passenger" & V1_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P1_USER == "Passenger" & V1_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P1_USER == "Pedestrian" ~ "Pedestrian",
                             P1_USER == "Bicyclist" ~ "Bicyclist",
                             P1_USER == "Motorcyclist" ~ "Motorcyclist"),
         P1_TYPE = factor(P1_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")),
         P2_TYPE = case_when(P2_USER == "Driver" & V2_TYPE == "Light Duty Vehicles" ~ "Driver: Light Vehicle",
                             P2_USER == "Driver" & V2_TYPE == "Vans and Light Trucks" ~ "Driver: Light Truck",
                             P2_USER == "Driver" & V2_TYPE == "Heavy Vehicles" ~ "Driver: Heavy Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Light Duty Vehicles" ~ "Passenger: Light Vehicle",
                             P2_USER == "Passenger" & V2_TYPE == "Vans and Light Trucks" ~ "Passenger: Light Truck",
                             P2_USER == "Passenger" & V2_TYPE == "Heavy Vehicles" ~ "Passenger: Heavy Vehicle",
                             P2_USER == "Pedestrian" ~ "Pedestrian",
                             P2_USER == "Bicyclist" ~ "Bicyclist",
                             P2_USER == "Motorcyclist" ~ "Motorcyclist"),
         P2_TYPE = factor(P2_TYPE,
                          levels = c("Driver: Light Vehicle", "Driver: Light Truck", "Driver: Heavy Vehicle",
                                     "Passenger: Light Vehicle", "Passenger: Light Truck", "Passenger: Heavy Vehicle",
                                     "Pedestrian",
                                     "Bicyclist",
                                     "Motorcyclist")))
```

```{r data-preparation-3, include=FALSE, cache=TRUE}
# Prepare data for estimation (also used for in-sample predictions, i.e., nowcasting)
nowcast_data.df <- ncdb_2017_paired_records %>% 
  transmute(P1_USER,
            P_ISEV,
            # INDIVIDUAL-LEVEL VARIABLES
            P1_SEX,
            P1_SAFE,
            P1_AGE,
            P1_AGE2 = P1_AGE^2,
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            DRIVER1 = 1 * (P1_USER == "Driver"),
            PASSENGER1 = 1 * (P1_USER == "Passenger"),
            PEDESTRIAN1 = 1 * (P1_USER == "Pedestrian"),
            BICYCLIST1 = 1 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1 = 1 * (P1_USER == "Motorcyclist"),
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            LD = 1 * (V1_TYPE == "Light Duty Vehicles"),
            LT = 1 * (V1_TYPE == "Vans and Light Trucks"),
            HV = 1 * (V1_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
            P1_AGExP2_AGExF = P1_AGE * P2_AGE * (P2_SEX == "Female"),
            P1_AGExP2_AGE2xM = P1_AGE * P2_AGE^2 * (P2_SEX == "Male"), 
            P1_AGExP2_AGE2xF = P1_AGE * P2_AGE^2 * (P2_SEX == "Female"),
            P1_AGE2xP2_AGExM = P1_AGE^2 * P2_AGE * (P2_SEX == "Male"),
            P1_AGE2xP2_AGExF = P1_AGE^2 * P2_AGE^2 * (P2_SEX == "Female"),
            LD_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LD_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LT_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            LT_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            HV_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            HV_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            LD_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LD_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LT_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            LT_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            HV_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            HV_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            PEDESTRIAN1_AGE = P1_AGE * (P1_USER == "Pedestrian"),
            PEDESTRIAN1_AGE2 = P1_AGE2 * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE = P1_AGE * (P1_USER == "Bicyclist"),
            BICYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE = P1_AGE * (P1_USER == "Motorcyclist"),
            MOTORCYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Motorcyclist"),
            
            # OPPONENT VARIABLES
            P2_SEX,
            P2_AGE,
            P2_AGE2 = P2_AGE^2,
            xLD = 1 * (V2_TYPE == "Light Duty Vehicles"),
            xLT = 1 * (V2_TYPE == "Vans and Light Trucks"),
            xHV = 1 * (V2_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL OPPONENT VARIABLES
            P1_AGExP2_AGE = P1_AGE * P2_AGE,
            P1_AGExP2_AGE2 = P1_AGE * P2_AGE^2,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE^2,
            LDxLD = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            LDxLT = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            LDxHV = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            LTxLD = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Light Duty Vehicles"),
            LTxLT = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Vans and Light Trucks"),
            LTxHV = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Heavy Vehicles"),
            HVxLD = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            HVxLT = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            HVxHV = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            PEDESTRIANxLD = (P1_USER == "Pedestrian") * (V2_TYPE == "Light Duty Vehicles"),
            PEDESTRIANxLT = (P1_USER == "Pedestrian") * (V2_TYPE == "Vans and Light Trucks"),
            PEDESTRIANxHV = (P1_USER == "Pedestrian") * (V2_TYPE == "Heavy Vehicles"),
            BICYCLISTxLD = (P1_USER == "Bicyclist") * (V2_TYPE == "Light Duty Vehicles"),
            BICYCLISTxLT = (P1_USER == "Bicyclist") * (V2_TYPE == "Vans and Light Trucks"),
            BICYCLISTxHV =  (P1_USER == "Bicylist") * (V2_TYPE == "Heavy Vehicles"),
            MOTORCYCLISTxLD = (P1_USER == "Motorcyclist") * (V2_TYPE == "Light Duty Vehicles"),
            MOTORCYCLISTxLT = (P1_USER == "Motorcyclist") * (V2_TYPE == "Vans and Light Trucks"),
            MOTORCYCLISTxHV =  (P1_USER == "Motorcyclist") * (V2_TYPE == "Heavy Vehicles"),
            
            # CASE-LEVEL VARIABLES
            C_CONF,
            C_RCFG,
            C_WTHR,
            C_RSUR,
            C_RALN,
            C_TRAF,
            C_MNTH)

# Prepare data for out-of-sample predictions, i.e., backcasting)
backcast_data.df <- ncdb_2016_paired_records %>% 
  transmute(P1_USER,
            P_ISEV,
            # INDIVIDUAL-LEVEL VARIABLES
            P1_SEX,
            P1_SAFE,
            P1_AGE,
            P1_AGE2 = P1_AGE^2,
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            DRIVER1 = 1 * (P1_USER == "Driver"),
            PASSENGER1 = 1 * (P1_USER == "Passenger"),
            PEDESTRIAN1 = 1 * (P1_USER == "Pedestrian"),
            BICYCLIST1 = 1 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1 = 1 * (P1_USER == "Motorcyclist"),
            
            # TRAFFIC UNIT-LEVEL VARIABLES
            LD = 1 * (V1_TYPE == "Light Duty Vehicles"),
            LT = 1 * (V1_TYPE == "Vans and Light Trucks"),
            HV = 1 * (V1_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
            LD_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LD_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Light Duty Vehicles"),
            LT_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            LT_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Vans and Light Trucks"),
            HV_DRIVER1_AGE = P1_AGE * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            HV_DRIVER1_AGE2 = P1_AGE2 * (P1_USER == "Driver") * (V1_TYPE == "Heavy Vehicles"),
            LD_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LD_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Light Duty Vehicles"),
            LT_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            LT_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Vans and Light Trucks"),
            HV_PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            HV_PASSENGER1_AGE2 = P1_AGE2 * (P1_USER == "Passenger") * (V1_TYPE == "Heavy Vehicles"),
            PEDESTRIAN1_AGE = P1_AGE * (P1_USER == "Pedestrian"),
            PEDESTRIAN1_AGE2 = P1_AGE2 * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE = P1_AGE * (P1_USER == "Bicyclist"),
            BICYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE = P1_AGE * (P1_USER == "Motorcyclist"),
            MOTORCYCLIST1_AGE2 = P1_AGE2 * (P1_USER == "Motorcyclist"),
            
            # OPPONENT VARIABLES
            P2_SEX,
            P2_AGE,
            P2_AGE2 = P2_AGE^2,
            xLD = 1 * (V2_TYPE == "Light Duty Vehicles"),
            xLT = 1 * (V2_TYPE == "Vans and Light Trucks"),
            xHV = 1 * (V2_TYPE == "Heavy Vehicles"),
            
            # HIERARCHICAL OPPONENT VARIABLES
            P1_AGExP2_AGE = P1_AGE * P2_AGE,
            P1_AGExP2_AGE2 = P1_AGE * P2_AGE^2,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE,
            P1_AGE2xP2_AGE = P1_AGE^2 * P2_AGE^2,
            P1_AGExP2_AGExF = P1_AGE * P2_AGE * (P2_SEX == "Female"),
            P1_AGExP2_AGE2xM = P1_AGE * P2_AGE^2 * (P2_SEX == "Male"), 
            P1_AGExP2_AGE2xF = P1_AGE * P2_AGE^2 * (P2_SEX == "Female"),
            P1_AGE2xP2_AGExM = P1_AGE^2 * P2_AGE * (P2_SEX == "Male"),
            P1_AGE2xP2_AGExF = P1_AGE^2 * P2_AGE^2 * (P2_SEX == "Female"),
            LDxLD = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            LDxLT = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            LDxHV = (V1_TYPE == "Light Duty Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            LTxLD = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Light Duty Vehicles"),
            LTxLT = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Vans and Light Trucks"),
            LTxHV = (V1_TYPE == "Vans and Light Trucks") * (V2_TYPE == "Heavy Vehicles"),
            HVxLD = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Light Duty Vehicles"),
            HVxLT = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Vans and Light Trucks"),
            HVxHV = (V1_TYPE == "Heavy Vehicles") * (V2_TYPE == "Heavy Vehicles"),
            PEDESTRIANxLD = (P1_USER == "Pedestrian") * (V2_TYPE == "Light Duty Vehicles"),
            PEDESTRIANxLT = (P1_USER == "Pedestrian") * (V2_TYPE == "Vans and Light Trucks"),
            PEDESTRIANxHV = (P1_USER == "Pedestrian") * (V2_TYPE == "Heavy Vehicles"),
            BICYCLISTxLD = (P1_USER == "Bicyclist") * (V2_TYPE == "Light Duty Vehicles"),
            BICYCLISTxLT = (P1_USER == "Bicyclist") * (V2_TYPE == "Vans and Light Trucks"),
            BICYCLISTxHV =  (P1_USER == "Bicylist") * (V2_TYPE == "Heavy Vehicles"),
            MOTORCYCLISTxLD = (P1_USER == "Motorcyclist") * (V2_TYPE == "Light Duty Vehicles"),
            MOTORCYCLISTxLT = (P1_USER == "Motorcyclist") * (V2_TYPE == "Vans and Light Trucks"),
            MOTORCYCLISTxHV =  (P1_USER == "Motorcyclist") * (V2_TYPE == "Heavy Vehicles"),
            
            # CASE-LEVEL VARIABLES
            C_CONF,
            C_RCFG,
            C_WTHR,
            C_RSUR,
            C_RALN,
            C_TRAF,
            C_MNTH)
```

```{r model-specification-summary, echo=FALSE, cache=TRUE}
data.frame(Variable = c(# INDIVIDUAL-LEVEL VARIABLES
  "Age",
  "Age Squared",
  "Sex",
  "Use of Safety Devices",
  
  # TRAFFIC UNIT-LEVEL VARIABLES
  
  "Passenger",
  "Pedestrian",
  "Bicyclist",
  "Motorcyclist",
  "Light Truck",
  "Heavy Vehicle",
  
  # OPPONENT VARIABLES
  
  "Age of Opponent",
  "Age of Opponent Squared",
  "Sex of Opponent",
  "Opponent: Light Duty Vehicle",
  "Opponent: Light Truck",
  "Opponent: Heavy Vehicle",
  
  # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
  
  "Light Truck Driver:Age",
  "Light Truck Driver:Age Squared",
  "Heavy Vehicle Driver:Age",
  "Heavy Vehicle Driver:Age Squared",
  "Light Truck Passenger:Age",
  "Light Truck Passenger:Age Squared:",
  "Heavy Vehicle Passenger:Age",
  "Heavy Vehicle Passenger:Age Squared",
  "Pedestrian:Age",
  "Pedestrian:Age Squared",
  "Bicyclist:Age",
  "Bicyclist:Age Squared",
  "Motorcyclist:Age",
  "Motorcyclist:Age Squared",
  
  # HIERARCHICAL OPPONENT VARIABLES
  
  "Age:Age of Opponent",
  "Age:Age of Female Opponent",
  "Age:Age of Male Opponent Squared",
  "Age:Age of Female Opponent Squared",
  "Age Squared:Age of Male Opponent",
  "Age Squared:Age of Female Opponent",
  
  # CASE-LEVEL VARIABLES
  
  "Crash Configuration",
  "Road Configuration",
  "Weather",
  "Surface",
  "Road Alignment",
  "Traffic Controls",
  "Month"),
  Notes = c("In decades",
            " ",
            "Reference: Female",
            "7 levels; Reference: No Safety Device",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Driver",
            "Reference: Light Duty Vehicle",
            "Reference: Light Duty Vehicle",
            "In decades",
            " ",
            "Reference: Female",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            "Reference: Pedestrian/Bicyclist/Motorcyclist",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            " ",
            "19 levels; Reference: Hit a moving object",
            "12 levels; Reference: Non-intersection",
            "9 levels; Reference: Clear and sunny",
            "11 levels; Reference: Dry",
            "8 levels; Reference: Straight and level",
            "19 levels; Reference: Operational traffic signals",
            "12 levels; Reference: January"),
  Model1 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model2 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model3 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$"),
  Model4 = c("$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             " ",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$",
             "$\\checkmark$")) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        col.names = c("Variable",
                      "Notes",
                      "Model 1\nSingle-level\n/No opponent",
                      "Model 2\nSingle-level\n/Opponent attributes",
                      "Model 3\nHierarchical: Traffic unit",
                      "Model 4\nHierarchical: Opponent attributes"),
        caption = "\\label{tab:model-specification-summary}Summary of variables and model specification") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "scale_down", "hold_position")) %>%
  #column_spec(2, width = "10em") %>%
  column_spec(3:6, width = "6em") %>%
  pack_rows("Individual-level variables", 1, 4) %>% 
  pack_rows("Traffic unit-level variables", 5, 10) %>% 
  pack_rows("Opponent variables", 11, 16) %>%
  pack_rows("Hierarchical traffic unit variables", 17, 30) %>%
  pack_rows("Hierarchical opponent variables", 31, 36) %>%
  pack_rows("Collision-level variables", 37, 43)
```

```{r model-1, include = FALSE, cache = TRUE}

# Initial model with individual-level attributes and case-level attributes: flat model

## Full data set: This is the model with a "flat" structure, including only individual-, vehicle-, and case-level variables. Estimate the model and save to named object:

mod1 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_AGE + 
               P1_AGE2 + 
               P1_SEX + 
               P1_SAFE +
               # TRAFFIC UNIT-LEVEL VARIABLES
               PASSENGER1 + 
               PEDESTRIAN1 +
               BICYCLIST1 +
               MOTORCYCLIST1 +
               LT +
               HV +
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r cases-for-subsetting, include=FALSE}
# Tabulate the number of cases by user-opponent type:

nowcast_data.df %>% dplyr::select(ends_with("xLD") , ends_with("xLT") , ends_with("xHV")) %>% colSums()
```

```{r model-1-ensemble, include = FALSE, cache = TRUE}

# Same model specification but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs light duty vehicle
mod1_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs light truck vehicle
mod1_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod1_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light duty vehicle
mod1_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light truck
mod1_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod1_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light duty vehicle
mod1_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLD == 1, 
                                                     C_RCFG != "Freeway Express Lane",
                                                     C_RCFG != "Traffic circle",
                                                     C_RSUR != "Muddy",
                                                     C_RSUR != "Sand/Gravel/Dirt",
                                                     C_WTHR != "Other",
                                                     C_TRAF != "Warning sign",
                                                     C_TRAF != "No passing zone sign",
                                                     C_TRAF != "Markings on the road") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light truck
mod1_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vs heavy vehicle
mod1_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     #DRIVER1 +
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs light duty vehicle
mod1_PEDESTRIANxLD <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs light truck
mod1_PEDESTRIANxLT <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs heavy vehicle
mod1_PEDESTRIANxHV <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #DRIVER1 +
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Bicyclist vs light duty vehicle
mod1_BICYCLISTxLD <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #DRIVER1 +
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs light truck
mod1_BICYCLISTxLT <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #DRIVER1 +
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                            P1_SAFE != "Other",
                                                            C_CONF != "Hit a stationary object",
                                                            C_CONF != "Ran off left shoulder",
                                                            C_CONF != "Ran off right shoulder",
                                                            C_CONF != "Approaching side-swipe",
                                                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                            C_CONF != "Head-on collision",
                                                            C_CONF != "Right turn, including turning conflicts",
                                                            C_RCFG != "Bridge/Overpass/Viaduct",
                                                            C_RCFG != "Unknown",
                                                            C_TRAF != "Other",
                                                            C_TRAF != "School guard") %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic",
                          control= list(maxit = 1500))

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod1_BICYCLISTxHV <- polr(P_ISEV ~
#                      # INDIVIDUAL-LEVEL VARIABLES
#                      P1_AGE + 
#                      P1_AGE2 + 
#                      P1_SEX + 
#                      P1_SAFE +
#                      # TRAFFIC UNIT-LEVEL VARIABLES
#                      #DRIVER1 +
#                      #PASSENGER1 + 
#                      #PEDESTRIAN1 +
#                      #BICYCLIST1 +
#                      #MOTORCYCLIST1 +
#                      #LT +
#                      #HV +
#                      # CASE-LEVEL VARIABLES
#                      C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#              data = nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% droplevels(),
#              Hess = TRUE,
#              method = "logistic")

# Motorcyclist vs light duty vehicle
mod1_MOTORCYCLISTxLD <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs light truck
mod1_MOTORCYCLISTxLT <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 500))

# Motorcyclist vs heavy vehicle
mod1_MOTORCYCLISTxHV <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #DRIVER1 +
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                               P1_SAFE != "Safety Device",
                                                               C_CONF != "Unknown",
                                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                                               C_TRAF != "Markings on the road",
                                                               C_TRAF != "School guard",
                                                               C_WTHR != "Raining") %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 4000))
```

```{r model-2, include=FALSE, cache = TRUE}

# Second model with individual-level attributes, case-level attributes, and opponent attributes: flat model

## Full data set: This is the model with a "flat" structure, including individual-, vehicle-, and case-level variables, and additionally opponent attributes. Estimate the model and save to named object:
mod2 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_AGE + 
               P1_AGE2 + 
               P1_SEX + 
               P1_SAFE +
               # TRAFFIC UNIT-LEVEL VARIABLES
               PASSENGER1 + 
               PEDESTRIAN1 +
               BICYCLIST1 +
               MOTORCYCLIST1 +
               LT +
               HV +
               # OPPONENT ATTRIBUTES
               P2_AGE + 
               P2_AGE2 +
               P2_SEX +
               xLD +
               xLT +
               xHV +
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r model-2-ensemble, include = FALSE, cache = TRUE}

# Same specification as Model 2 but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs ligth duty vehicle
mod2_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs ligth truck
mod2_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod2_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth duty vehicle
mod2_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth truck
mod2_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod2_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth duty vehicle
mod2_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLD == 1,
                                                     C_RCFG != "Traffic circle",
                                                     C_RCFG != "Freeway Express Lane",
                                                     C_WTHR != "Other",
                                                     C_RSUR != "Sand/Gravel/Dirt",
                                                     C_TRAF != "Markings on the road",
                                                     C_TRAF != "Markings on the road",
                                                     C_TRAF != "Warning sign") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth truck
mod2_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1,
                                                     C_CONF != "Ran off right shoulder") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic",
                   control = list(maxit=500))

# Heavy vehicle vs heavy vehicle
mod2_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_AGE + 
                     P1_AGE2 + 
                     P1_SEX + 
                     P1_SAFE +
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     PASSENGER1 + 
                     #PEDESTRIAN1 +
                     #BICYCLIST1 +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     # OPPONENT ATTRIBUTES
                     P2_AGE + 
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs ligth duty vehicle
mod2_PEDESTRIANxLD <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # OPPONENT ATTRIBUTES
                             P2_AGE + 
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs light ruck
mod2_PEDESTRIANxLT <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # OPPONENT ATTRIBUTES
                             P2_AGE + 
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic",
                           control = list(maxit=500))

# Pedestrian vs heavy vehicle
mod2_PEDESTRIANxHV <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_AGE + 
                             P1_AGE2 + 
                             P1_SEX + 
                             P1_SAFE +
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             #PASSENGER1 + 
                             #PEDESTRIAN1 +
                             #BICYCLIST1 +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             # OPPONENT ATTRIBUTES
                             P2_AGE + 
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Bicyclist vs ligth duty vehicle
mod2_BICYCLISTxLD <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # OPPONENT ATTRIBUTES
                            P2_AGE + 
                            P2_AGE2 +
                            P2_SEX +
                            #xLD +
                            #xLT +
                            #xHV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs ligth truck
mod2_BICYCLISTxLT <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_AGE + 
                            P1_AGE2 + 
                            P1_SEX + 
                            P1_SAFE +
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            #PASSENGER1 + 
                            #PEDESTRIAN1 +
                            #BICYCLIST1 +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            # OPPONENT ATTRIBUTES
                            P2_AGE + 
                            P2_AGE2 +
                            P2_SEX +
                            #xLD +
                            #xLT +
                            #xHV +
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                            P1_SAFE != "Other") %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic",
                          control = list(maxit = 500))

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod2_BICYCLISTxHV <- polr(P_ISEV ~
#                      # INDIVIDUAL-LEVEL VARIABLES
#                      P1_AGE + 
#                      P1_AGE2 + 
#                      P1_SEX + 
#                      P1_SAFE +
#                      # TRAFFIC UNIT-LEVEL VARIABLES
#                      #PASSENGER1 + 
#                      #PEDESTRIAN1 +
#                      #BICYCLIST1 +
#                      #MOTORCYCLIST1 +
#                      #LT +
#                      #HV +
#                      # OPPONENT ATTRIBUTES
#                      P2_AGE + 
#                      P2_AGE2 +
#                      P2_SEX +
#                      #xLD +
#                      #xLT +
#                      #xHV +
#                      # CASE-LEVEL VARIABLES
#                      C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#                    data = nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% droplevels(),
#                    Hess = TRUE,
#                    method = "logistic")

# Motorcyclist vs light duty vehicle
mod2_MOTORCYCLISTxLD <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # OPPONENT ATTRIBUTES
                               P2_AGE + 
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs light truck
mod2_MOTORCYCLISTxLT <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # OPPONENT ATTRIBUTES
                               P2_AGE + 
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs heavy vehicle
mod2_MOTORCYCLISTxHV <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_AGE + 
                               P1_AGE2 + 
                               P1_SEX + 
                               P1_SAFE +
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               #PASSENGER1 + 
                               #PEDESTRIAN1 +
                               #BICYCLIST1 +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               # OPPONENT ATTRIBUTES
                               P2_AGE + 
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1,
                                                               P1_SAFE != "Safety Device",
                                                               P1_SAFE != "Other",
                                                               C_CONF != "Approaching side-swipe",
                                                               C_CONF != "Unknown",
                                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                                               C_RALN != "Top of hill or gradient",
                                                               C_TRAF != "Markings on the road") %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 4000))
```

```{r model-3, include=FALSE, cache=TRUE}

## Third model with hierarchical traffic unit-level attributes, case-level attributes, and opponents

mod3 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
               
               # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
               #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + # Omitted to avoid perfect colinearity
               LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
               HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
               LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
               LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
               HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
               PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
               BICYCLIST1_AGE + BICYCLIST1_AGE2 +
               MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
               
               # OPPONENT VARIABLES
               P2_AGE +
               P2_AGE2 +
               P2_SEX +
               xLD +
               xLT +
               xHV +
               
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r model-3-ensemble, include = FALSE, cache = TRUE}
# Same specification as Model 3 but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs ligth duty vehicle
mod3_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     LD_DRIVER1_AGE + LD_DRIVER1_AGE2 +
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic",
                   control = list(maxit = 500))

# Light duty vehicle vs ligth truck
mod3_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     LD_DRIVER1_AGE + LD_DRIVER1_AGE2 +
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod3_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth duty vehicle
mod3_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs ligth truck
mod3_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod3_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth duty vehicle
mod3_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + # Omitted to avoid perfect colinearity
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Warning sign") %>%
                     droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs ligth truck
mod3_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1,
                                                     C_CONF != "Other Single Vehicle",
                                                     C_CONF != "Ran off right shoulder") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic",
                   control = list(maxit=500))

# Heavy vehicle vs heavy vehicle
mod3_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                     #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                     #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                     HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                     #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                     #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                     HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                     #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                     #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                     #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                     
                     # OPPONENT VARIABLES
                     P2_AGE +
                     P2_AGE2 +
                     P2_SEX +
                     #xLD +
                     #xLT +
                     #xHV +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs ligth duty vehicle
mod3_PEDESTRIANxLD <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                             
                             # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                             #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                             #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                             #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                             #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                             #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                             #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                             #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                             #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                             #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                           
                           # OPPONENT VARIABLES
                           P2_AGE +
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs light ruck
mod3_PEDESTRIANxLT <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                             
                             # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                             #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                             #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                             #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                             #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                             #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                             #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                             #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                             #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                             #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                           
                           # OPPONENT VARIABLES
                           P2_AGE +
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic",
                           control = list(maxit = 500))

# Pedestrian vs heavy vehicle
mod3_PEDESTRIANxHV <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                             
                             # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                             #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                             #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                             #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                             #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                             #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                             #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                             #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                             #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                             #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                           
                           # OPPONENT VARIABLES
                           P2_AGE +
                             P2_AGE2 +
                             P2_SEX +
                             #xLD +
                             #xLT +
                             #xHV +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Bicyclist vs ligth duty vehicle
mod3_BICYCLISTxLD <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                            
                            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                            #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                            #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                            #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                            #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                            #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                            #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                            #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                            #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                            #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                          
                          # OPPONENT VARIABLES
                          P2_AGE +
                            P2_AGE2 +
                            P2_SEX +
                            #xLD +
                            #xLT +
                            #xHV +
                            
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs ligth truck
mod3_BICYCLISTxLT <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                            
                            # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                            #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                            #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                            #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                            #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                            #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                            #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                            #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                            #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                            #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                          
                          # OPPONENT VARIABLES
                          P2_AGE +
                            P2_AGE2 +
                            P2_SEX +
                            #xLD +
                            #xLT +
                            #xHV +
                            
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                            P1_SAFE != "Other") %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic",
                          control = list(maxit = 500))

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod2_BICYCLISTxHV <- polr(P_ISEV ~
# # INDIVIDUAL-LEVEL VARIABLES
# P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
# 
# # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
# #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + # Omitted to avoid perfect colinearity
# LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
# HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
# LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
# LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
# HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
# PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
# BICYCLIST1_AGE + BICYCLIST1_AGE2 +
# MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
# 
# # OPPONENT VARIABLES
# P2_AGE +
# P2_AGE2 +
# P2_SEX +
# xLD +
# xLT +
# xHV +
# 
# # CASE-LEVEL VARIABLES
# C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#                    data = nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% droplevels(),
#                    Hess = TRUE,
#                    method = "logistic")

# Motorcyclist vs light duty vehicle
mod3_MOTORCYCLISTxLD <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                               #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                               #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                               #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                               #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                               #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                               #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                               #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                               #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                               #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                             
                             # OPPONENT VARIABLES
                             P2_AGE +
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs light truck
mod3_MOTORCYCLISTxLT <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                               #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                               #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                               #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                               #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                               #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                               #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                               #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                               #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                               #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                             
                             # OPPONENT VARIABLES
                             P2_AGE +
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 500))

# Motorcyclist vs heavy vehicle
mod3_MOTORCYCLISTxHV <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # HIERARCHICAL TRAFFIC UNIT-LEVEL VARIABLES
                               #LD_DRIVER1_AGE + LD_DRIVER1_AGE2 + 
                               #LT_DRIVER1_AGE + LT_DRIVER1_AGE2 +
                               #HV_DRIVER1_AGE + HV_DRIVER1_AGE2 +
                               #LD_PASSENGER1_AGE + LD_PASSENGER1_AGE2 +
                               #LT_PASSENGER1_AGE + LT_PASSENGER1_AGE2 +
                               #HV_PASSENGER1_AGE + HV_PASSENGER1_AGE2 +
                               #PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 + 
                               #BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                               #MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                             
                             # OPPONENT VARIABLES
                             P2_AGE +
                               P2_AGE2 +
                               P2_SEX +
                               #xLD +
                               #xLT +
                               #xHV +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1,
                                                               P1_SAFE != "Safety Device",
                                                               C_CONF != "Approaching side-swipe",
                                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                                               C_RALN != "Top of hill or gradient",
                                                               C_TRAF != "School guard",
                                                               C_TRAF != "Markings on the road") %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 5000))
```

```{r model-4, include = FALSE, cache=TRUE}
# Fourth model with hierarchical opponent-attributes, traffic unit-level attributes, and case-level attributes
mod4 <- polr(P_ISEV ~
               # INDIVIDUAL-LEVEL VARIABLES
               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
               
               # TRAFFIC UNIT-LEVEL VARIABLES
               # P1_DRIVER +
               PASSENGER1  +
               PEDESTRIAN1  +
               BICYCLIST1  +
               MOTORCYCLIST1 +
               LT +
               HV +
               
               # HIERARCHICAL OPPONENT VARIABLES
               P1_AGExP2_AGE+
               P1_AGExP2_AGExF +
               P1_AGExP2_AGE2xM +
               P1_AGExP2_AGE2xF +
               P1_AGE2xP2_AGExM +
               P1_AGE2xP2_AGExF +
               
               # OPPONENT VARIABLES
               xLT +
               xHV +
               xLD +
               
               # CASE-LEVEL VARIABLES
               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
             data = nowcast_data.df,
             Hess = TRUE,
             method = "logistic")
```

```{r model-4-ensemble, include = FALSE, cache = TRUE}
# Same model specification but sub-setting by user - opponent type. This gives an ensemble of models for the different combinations

# Light duty vehicle vs light duty vehicle
mod4_LDxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic",
                   control = list(maxit = 500))

# Light duty vehicle vs light truck vehicle
mod4_LDxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light duty vehicle vs heavy vehicle
mod4_LDxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LDxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light duty vehicle
mod4_LTxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLD == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs light truck
mod4_LTxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxLT == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Light truck vs heavy vehicle
mod4_LTxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(LTxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light duty vehicle
mod4_HVxLD <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLD == 1,
                                                     C_RCFG != "Traffic circle",
                                                     C_RCFG != "Freeway Express Lane",
                                                     C_WTHR != "Other",
                                                     C_RSUR != "Sand/Gravel/Dirt",
                                                     C_TRAF != "No passing zone sign",
                                                     C_TRAF != "Warning sign") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Heavy vehicle vs light truck
mod4_HVxLT <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxLT == 1,
                                                     C_CONF != "Ran off right shoulder",
                                                     C_CONF != "Other Single Vehicle",
                                                     C_CONF != "Side swipe") %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic",
                   control = list(maxit = 500))

# Heavy vs heavy vehicle
mod4_HVxHV <- polr(P_ISEV ~
                     # INDIVIDUAL-LEVEL VARIABLES
                     P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                     
                     # TRAFFIC UNIT-LEVEL VARIABLES
                     # P1_DRIVER +
                     PASSENGER1  +
                     #PEDESTRIAN1  +
                     #BICYCLIST1  +
                     #MOTORCYCLIST1 +
                     #LT +
                     #HV +
                     
                     # HIERARCHICAL OPPONENT VARIABLES
                     P1_AGExP2_AGE+
                     P1_AGExP2_AGExF +
                     P1_AGExP2_AGE2xM +
                     P1_AGExP2_AGE2xF +
                     P1_AGE2xP2_AGExM +
                     P1_AGE2xP2_AGExF +
                     
                     # OPPONENT VARIABLES
                     #xLT +
                     #xHV +
                     #xLD +
                     
                     # CASE-LEVEL VARIABLES
                     C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                   data = nowcast_data.df %>% filter(HVxHV == 1) %>% droplevels(),
                   Hess = TRUE,
                   method = "logistic")

# Pedestrian vs light duty vehicle
mod4_PEDESTRIANxLD <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + #P1_AGE2 +
                             
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             # P1_DRIVER +
                             #PASSENGER1  +
                             #PEDESTRIAN1  +
                             #BICYCLIST1  +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             
                             # HIERARCHICAL OPPONENT VARIABLES
                           P1_AGExP2_AGE+
                             P1_AGExP2_AGExF +
                             P1_AGExP2_AGE2xM +
                             P1_AGExP2_AGE2xF +
                             P1_AGE2xP2_AGExM +
                             P1_AGE2xP2_AGExF +
                             
                             # OPPONENT VARIABLES
                             #xLT +
                             #xHV +
                             #xLD +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Pedestrian vs light truck
mod4_PEDESTRIANxLT <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                             
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             # P1_DRIVER +
                             #PASSENGER1  +
                             #PEDESTRIAN1  +
                             #BICYCLIST1  +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             
                             # HIERARCHICAL OPPONENT VARIABLES
                           P1_AGExP2_AGE+
                             P1_AGExP2_AGExF +
                             P1_AGExP2_AGE2xM +
                             P1_AGExP2_AGE2xF +
                             P1_AGE2xP2_AGExM +
                             P1_AGE2xP2_AGExF +
                             
                             # OPPONENT VARIABLES
                             #xLT +
                             #xHV +
                             #xLD +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic",
                           control = list(maxit = 500))

# Pedestrian vs heavy vehicle
mod4_PEDESTRIANxHV <- polr(P_ISEV ~
                             # INDIVIDUAL-LEVEL VARIABLES
                             P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                             
                             # TRAFFIC UNIT-LEVEL VARIABLES
                             # P1_DRIVER +
                             #PASSENGER1  +
                             #PEDESTRIAN1  +
                             #BICYCLIST1  +
                             #MOTORCYCLIST1 +
                             #LT +
                             #HV +
                             
                             # HIERARCHICAL OPPONENT VARIABLES
                           P1_AGExP2_AGE+
                             P1_AGExP2_AGExF +
                             P1_AGExP2_AGE2xM +
                             P1_AGExP2_AGE2xF +
                             P1_AGE2xP2_AGExM +
                             P1_AGE2xP2_AGExF +
                             
                             # OPPONENT VARIABLES
                             #xLT +
                             #xHV +
                             #xLD +
                             
                             # CASE-LEVEL VARIABLES
                             C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                           data = nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% droplevels(),
                           Hess = TRUE,
                           method = "logistic")

# Bicyclist vs light duty vehicle
mod4_BICYCLISTxLD <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            P1_SEX + P1_SAFE + P1_AGE + #P1_AGE2 +
                            
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            # P1_DRIVER +
                            #PASSENGER1  +
                            #PEDESTRIAN1  +
                            #BICYCLIST1  +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            
                            # HIERARCHICAL OPPONENT VARIABLES
                          P1_AGExP2_AGE+
                            P1_AGExP2_AGExF +
                            P1_AGExP2_AGE2xM +
                            P1_AGExP2_AGE2xF +
                            P1_AGE2xP2_AGExM +
                            P1_AGE2xP2_AGExF +
                            
                            # OPPONENT VARIABLES
                            #xLT +
                            #xHV +
                            #xLD +
                            
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic")

# Bicyclist vs light truck
mod4_BICYCLISTxLT <- polr(P_ISEV ~
                            # INDIVIDUAL-LEVEL VARIABLES
                            #P1_SEX + 
                            P1_SAFE + P1_AGE + #P1_AGE2 +
                            
                            # TRAFFIC UNIT-LEVEL VARIABLES
                            # P1_DRIVER +
                            #PASSENGER1  +
                            #PEDESTRIAN1  +
                            #BICYCLIST1  +
                            #MOTORCYCLIST1 +
                            #LT +
                            #HV +
                            
                            # HIERARCHICAL OPPONENT VARIABLES
                          #P1_AGExP2_AGE+
                          P1_AGExP2_AGExF +
                            P1_AGExP2_AGE2xM +
                            P1_AGExP2_AGE2xF +
                            P1_AGE2xP2_AGExM +
                            P1_AGE2xP2_AGExF +
                            
                            # OPPONENT VARIABLES
                            #xLT +
                            #xHV +
                            #xLD +
                            
                            # CASE-LEVEL VARIABLES
                            C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                          data = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                            P1_SAFE != "Other",
                                                            C_CONF != "Ran off left shoulder",
                                                            C_CONF != "Ran off right shoulder",
                                                            C_WTHR != "Visibility limitation") %>% droplevels(),
                          Hess = TRUE,
                          method = "logistic",
                          control = list(maxit=1500))

# Bicyclist vs heavy vehicle
# ZERO CASES: Do not estimate
# mod4_BICYCLISTxHV <- polr(P_ISEV ~
# # INDIVIDUAL-LEVEL VARIABLES
# P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
# 
# # TRAFFIC UNIT-LEVEL VARIABLES
# # P1_DRIVER +
# PASSENGER1  +
# PEDESTRIAN1  +
# BICYCLIST1  +
# MOTORCYCLIST1 +
# LT +
# HV +
# 
# # HIERARCHICAL OPPONENT VARIABLES
# P1_AGExP2_AGE+
# P1_AGExP2_AGExF +
# P1_AGExP2_AGE2xM +
# P1_AGExP2_AGE2xF +
# P1_AGE2xP2_AGExM +
# P1_AGE2xP2_AGExF +
# 
# # OPPONENT VARIABLES
# xLT +
# xHV +
# xLD +
# 
# # CASE-LEVEL VARIABLES
# C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
#              data = nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% droplevels(),
#              Hess = TRUE,
#              method = "logistic")

# Motorcyclist vs light duty vehicle
mod4_MOTORCYCLISTxLD <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               # P1_DRIVER +
                               #PASSENGER1  +
                               #PEDESTRIAN1  +
                               #BICYCLIST1  +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               
                               # HIERARCHICAL OPPONENT VARIABLES
                             P1_AGExP2_AGE+
                               P1_AGExP2_AGExF +
                               P1_AGExP2_AGE2xM +
                               P1_AGExP2_AGE2xF +
                               P1_AGE2xP2_AGExM +
                               P1_AGE2xP2_AGExF +
                               
                               # OPPONENT VARIABLES
                               #xLT +
                               #xHV +
                               #xLD +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic")

# Motorcyclist vs light truck
mod4_MOTORCYCLISTxLT <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               # P1_DRIVER +
                               #PASSENGER1  +
                               #PEDESTRIAN1  +
                               #BICYCLIST1  +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               
                               # HIERARCHICAL OPPONENT VARIABLES
                             P1_AGExP2_AGE+
                               P1_AGExP2_AGExF +
                               P1_AGExP2_AGE2xM +
                               #P1_AGExP2_AGE2xF +
                               P1_AGE2xP2_AGExM +
                               P1_AGE2xP2_AGExF +
                               
                               # OPPONENT VARIABLES
                               #xLT +
                               #xHV +
                               #xLD +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1,
                                                               P1_SAFE != "Vehicle not Equiped",
                                                               P1_SAFE != "Other",
                                                               C_CONF != "Ran off right shoulder",
                                                               C_CONF != "Right turn, including turning conflicts",
                                                               C_CONF != "Other Single Vehicle",
                                                               C_CONF != "Side swipe",
                                                               C_RCFG != "Ramp",
                                                               C_RCFG != "Unknown",
                                                               C_RCFG != "Other",
                                                               C_TRAF != "Yield sign") %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 10000))

# Motorcyclist vs heavy vehicle
mod4_MOTORCYCLISTxHV <- polr(P_ISEV ~
                               # INDIVIDUAL-LEVEL VARIABLES
                               P1_SEX + P1_SAFE + P1_AGE + P1_AGE2 +
                               
                               # TRAFFIC UNIT-LEVEL VARIABLES
                               # P1_DRIVER +
                               #PASSENGER1  +
                               #PEDESTRIAN1  +
                               #BICYCLIST1  +
                               #MOTORCYCLIST1 +
                               #LT +
                               #HV +
                               
                               # HIERARCHICAL OPPONENT VARIABLES
                             P1_AGExP2_AGE+
                               P1_AGExP2_AGExF +
                               P1_AGExP2_AGE2xM +
                               P1_AGExP2_AGE2xF +
                               P1_AGE2xP2_AGExM +
                               #P1_AGE2xP2_AGExF +
                               
                               # OPPONENT VARIABLES
                               #xLT +
                               #xHV +
                               #xLD +
                               
                               # CASE-LEVEL VARIABLES
                               C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF + C_MNTH,
                             data = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                               P1_SAFE != "Safety Device",
                                                               C_CONF != "Approaching side-swipe",
                                                               C_RCFG != "Bridge/Overpass/Viaduct") %>% droplevels(),
                             Hess = TRUE,
                             method = "logistic",
                             control = list(maxit = 8000))
```

```{r save-models-and-data, eval=FALSE, echo=FALSE}
# This is a shortcut to avoid having to re-estimate the models while working on the paper
save.image(file = "Models-and-Data.RData")
```

```{r load-models-and-data, eval=FALSE, echo=FALSE}
# This is a shortcut to avoid having to re-estimate the models while working on the paper
load("Models-and-Data.RData")
```

Model assessment {#sec:assessment}
============

In this section we report an in-depth examination of the performance of the models. We begin by inspecting the statistical goodness of fit of the models by means of Akaike's Information Criterion ($AIC$). Next, we use the models to conduct in-sample predictions (i.e., _nowcasting_), using the same sample that was used to estimate the models, and out-of-sample predictions, using the data set corresponding to the year 2016 (i.e., _backcasting_). Predictions are commonly evaluated in two different ways in the literature. Some researchers analyze the outcome shares based on the predicted probabilities [e.g., @Bogue2017modified; @Yasmin2013evaluating]. This is a form of aggregate forecasting. Other researchers, in contrast, evaluate the classes of outcomes based on the individual-level predictions [e.g., @Tang2019crash; @Torrao2014modeling]. This is a form of disaggregate forecasting.

## Goodness of fit of models {#sec:goodness-of-fit}

We begin our empirical assessment by examining the results of estimating the models described above. Tables \ref{tab:model-full-sample-summary} and \ref{tab:model-subsample-summary} present some key summary statistics of the estimated models. Of interest is the goodness of fit of the models, which in the case is measured with Akaike's Information Criterion ($AIC$). This criterion is calculated as follows:

\begin{equation}
\label{eq:aic}
AIC = 2Z - 2\ln{\hat{L}}
\end{equation}

\noindent where $Z$ is the number of coefficients estimated by the model, and $\hat{L}$ the maximized likelihood of the model. Since $AIC$ penalizes the model fit by means of the number of coefficients, this criterion gives preference to more parsimonious models. The objective is to minimize the $AIC$, and therefore smaller values of this criterion represent better model fits. Model comparison can be conducted using the relative likelihood. Suppose that we have two models, say Model $a$ and Model $b$, with $AIC_{a} \le AIC_{b}$. The relative likelihood is calculated as:

\begin{equation}
\label{eq:relative-likelihood}
e^{(AIC_a - AIC_b)/2}
\end{equation}

The relative likelihood is interpreted as the probability that Model $b$ minimizes the information loss as well as Model $a$.

Turning our attention to the models estimated using the full sample (Table \ref{tab:model-full-sample-summary}), it is possible to see that, compared to the base (single-level) model without opponent variables (Model 1), there are large and significant improvements in goodness of fit to be gained by introducing opponent effects. However, the gains are not as large when hierarchical specifications are used, even when the number of additional coefficients that need to be estimated is not substantially larger (recall that the penalty per coefficient in $AIC$ is 2). The best model according to this measure of goodness of fit is Model 2 (single-level with opponent effects), followed by Model 4 (hierarchical opponent variables), Model 3 (hierarchical traffic unit variables with opponent effects), and finally Model 1 (single-level without opponent effects). 

It is important to note that the likelihood function of a model, and therefore the value of its $AIC$, both depend on the size of the sample, which is why $AIC$ is not comparable across models estimated with different sample sizes. For this reason, the full sample models cannot be compared directly to the models estimated with subsets of data. The models in the ensembles, however, can be compared to each other (Table \ref{tab:model-subsample-summary}). As seen in the table, introducing opponent variables leads to a better fit in the case of most, but not all models. The simplest model (single-level without opponent effects) is clearly the best fitting candidate in the case of bicycle vs light truck collisions, bicycle vs heavy vehicle collisions, motorcyclist vs light duty vehicle collisions, and motorcyclist vs heavy vehicle collisions. Model 1 is a statistical toss for best performance with two competing models in the case of pedestrian vs heavy vehicle collisions. The relative likelihood of Model 1 compared to Models 2 and 3 in this case is `r format(exp((AIC(mod1_PEDESTRIANxHV) - AIC(mod2_PEDESTRIANxHV))/2), digits = 3)`, which means that these two models are `r format(exp((AIC(mod1_PEDESTRIANxHV) - AIC(mod2_PEDESTRIANxHV))/2), digits = 3)` times as probable as Model 1 to minimize the information loss. 

Model 2 is the best fit in the case of light truck vs heavy vehicle collisions. This model is also tied for best fit with Model 2 in the case of pedestrian vs light duty vehicle and pedestrian vs light truck collisions, and is a statistical toss with Model 4 in the case of heavy vehicle vs heavy vehicle collisions (relative likelihood is `r format(exp((AIC(mod2_HVxHV) - AIC(mod4_HVxHV))/2), digits = 3)`). Model 3 is the best fit in the case of light duty vehicle vs light duty vehicle collisions and heavy vehicle vs light duty vehicle. Model 4 is the best fit in the case of light duty vehicle vs light truck collisions, light duty vehicle vs heavy vehicle collisions, light truck vs light duty vehicle collisions, heavy vehicle vs light truck collisions, and motorcycle vs light truck collisions. This model is a statistical toss with Model 2 in the case of light truck vs light truck collisions, with a relative likelihood of `r format(exp((AIC(mod4_LTxLT) - AIC(mod2_LTxLT))/2), digits = 3)`.

These results give some preliminary ideas about the relative performance of the different modelling strategies. In the next subsection we delve more deeply into this question by examining the predictive performance of the various modelling strategies. The results up to this point indicate that different model specification strategies might work best when combined with subsampling strategies. For space reasons, from this point onwards, we will consider the ensembles of models for predictions and will not compare individual models within the ensembles; this we suggest is a matter for future research. 

```{r model-full-sample-summary, echo=FALSE, cache=TRUE}
data.frame(Model = c("Model 1. Single-level/No opponent", 
                     "Model 2. Single-level/Opponent attributes",
                     "Model 3. Hierarchical: Traffic unit",
                     "Model 4. Hierarchical: Opponent)"),
           n = c(mod1$nobs,
                 mod2$nobs,
                 mod3$nobs,
                 mod4$nobs),
           k = c(length(mod1$coefficients) + length(mod1$zeta),
                 length(mod2$coefficients) + length(mod2$zeta),
                 length(mod3$coefficients) + length(mod3$zeta),
                 length(mod4$coefficients) + length(mod4$zeta)),
           AIC = c(AIC(mod1),
                   AIC(mod2),
                   AIC(mod3),
                   AIC(mod4))) %>%
  mutate(n = format(n, digits = 2, big.mark = ","),
         AIC = format(AIC, digits = 2, big.mark = ",")) %>%
  kable(digits = 2,
        booktabs = TRUE,
        escape = FALSE,
        align = c("l", "c", "c", "c"),
        col.names = linebreak(c("Model", "Number of\nobservations", "Number of\ncoefficients", "AIC")),
        caption = "\\label{tab:model-full-sample-summary}Summary of model estimation results: Full sample models") %>%
  kable_styling(font_size = 7, latex_options = c("striped"))
```

```{r model-subsample-summary, echo=FALSE, cache=TRUE}
data.frame(Model = c("Light duty vehicle vs light duty vehicle",
                     "Light duty vehicle vs light truck",
                     "Light duty vehicle vs heavy vehicle",
                     "Light truck vs light duty vehicle",
                     "Light truck vs light truck",
                     "Light truck vs heavy vehicle",
                     "Heavy vehicle vs light duty vehicle",
                     "Heavy vehicle vs light truck",
                     "Heavy vehicle vs heavy vehicle",
                     "Pedestrian vs light duty vehicle",
                     "Pedestrian vs light truck",
                     "Pedestrian vs heavy vehicle",
                     "Bicyclist vs light duty vehicle",
                     "Bicyclist vs light truck",
                     "Bicyclist vs heavy vehicle",
                     "Motorcyclist vs light duty vehicle",
                     "Motorcyclist vs light truck",
                     "Motorcyclist vs heavy vehicle"),
           n1 = c(mod1_LDxLD$nobs,
                  mod1_LDxLT$nobs,
                  mod1_LDxHV$nobs,
                  mod1_LTxLD$nobs,
                  mod1_LTxLT$nobs,
                  mod1_LTxHV$nobs,
                  mod1_HVxLD$nobs,
                  mod1_HVxLT$nobs,
                  mod1_HVxHV$nobs,
                  mod1_PEDESTRIANxLD$nobs,
                  mod1_PEDESTRIANxLT$nobs,
                  mod1_PEDESTRIANxHV$nobs,
                  mod1_BICYCLISTxLD$nobs,
                  mod1_BICYCLISTxLT$nobs,
                  NA, 
                  mod1_MOTORCYCLISTxLD$nobs,
                  mod1_MOTORCYCLISTxLT$nobs,
                  mod1_MOTORCYCLISTxHV$nobs),
           k1 = c(length(mod1_LDxLD$coefficients) + length(mod1_LDxLD$zeta),
                  length(mod1_LDxLT$coefficients) + length(mod1_LDxLT$zeta),
                  length(mod1_LDxHV$coefficients) + length(mod1_LDxHV$zeta),
                  length(mod1_LTxLD$coefficients) + length(mod1_LTxLD$zeta),
                  length(mod1_LTxLT$coefficients) + length(mod1_LTxLT$zeta),
                  length(mod1_LTxHV$coefficients) + length(mod1_LTxHV$zeta),
                  length(mod1_HVxLD$coefficients) + length(mod1_HVxLD$zeta),
                  length(mod1_HVxLT$coefficients) + length(mod1_HVxLT$zeta),
                  length(mod1_HVxHV$coefficients) + length(mod1_HVxHV$zeta),
                  length(mod1_PEDESTRIANxLD$coefficients) + length(mod1_PEDESTRIANxLD$zeta),
                  length(mod1_PEDESTRIANxLT$coefficients) + length(mod1_PEDESTRIANxLT$zeta),
                  length(mod1_PEDESTRIANxHV$coefficients) + length(mod1_PEDESTRIANxHV$zeta),
                  length(mod1_BICYCLISTxLD$coefficients) + length(mod1_BICYCLISTxLD$zeta),
                  length(mod1_BICYCLISTxLT$coefficients) + length(mod1_BICYCLISTxLT$zeta),
                  NA, 
                  length(mod1_MOTORCYCLISTxLD$coefficients) + length(mod1_MOTORCYCLISTxLD$zeta),
                  length(mod1_MOTORCYCLISTxLT$coefficients) + length(mod1_MOTORCYCLISTxLT$zeta),
                  length(mod1_MOTORCYCLISTxHV$coefficients) + length(mod1_MOTORCYCLISTxHV$zeta)),
           AIC1 = c(AIC(mod1_LDxLD),
                    AIC(mod1_LDxLT),
                    AIC(mod1_LDxHV),
                    AIC(mod1_LTxLD),
                    AIC(mod1_LTxLT),
                    AIC(mod1_LTxHV),
                    AIC(mod1_HVxLD),
                    AIC(mod1_HVxLT),
                    AIC(mod1_HVxHV),
                    AIC(mod1_PEDESTRIANxLD),
                    AIC(mod1_PEDESTRIANxLT),
                    AIC(mod1_PEDESTRIANxHV),
                    AIC(mod1_BICYCLISTxLD),
                    AIC(mod1_BICYCLISTxLT),
                    NA, 
                    AIC(mod1_MOTORCYCLISTxLD),
                    AIC(mod1_MOTORCYCLISTxLT),
                    AIC(mod1_MOTORCYCLISTxHV)),
           k2 = c(length(mod2_LDxLD$coefficients) + length(mod2_LDxLD$zeta),
                  length(mod2_LDxLT$coefficients) + length(mod2_LDxLT$zeta),
                  length(mod2_LDxHV$coefficients) + length(mod2_LDxHV$zeta),
                  length(mod2_LTxLD$coefficients) + length(mod2_LTxLD$zeta),
                  length(mod2_LTxLT$coefficients) + length(mod2_LTxLT$zeta),
                  length(mod2_LTxHV$coefficients) + length(mod2_LTxHV$zeta),
                  length(mod2_HVxLD$coefficients) + length(mod2_HVxLD$zeta),
                  length(mod2_HVxLT$coefficients) + length(mod2_HVxLT$zeta),
                  length(mod2_HVxHV$coefficients) + length(mod2_HVxHV$zeta),
                  length(mod2_PEDESTRIANxLD$coefficients) + length(mod2_PEDESTRIANxLD$zeta),
                  length(mod2_PEDESTRIANxLT$coefficients) + length(mod2_PEDESTRIANxLT$zeta),
                  length(mod2_PEDESTRIANxHV$coefficients) + length(mod2_PEDESTRIANxHV$zeta),
                  length(mod2_BICYCLISTxLD$coefficients) + length(mod2_BICYCLISTxLD$zeta),
                  length(mod2_BICYCLISTxLT$coefficients) + length(mod2_BICYCLISTxLT$zeta),
                  NA, 
                  length(mod2_MOTORCYCLISTxLD$coefficients) + length(mod2_MOTORCYCLISTxLD$zeta),
                  length(mod2_MOTORCYCLISTxLT$coefficients) + length(mod2_MOTORCYCLISTxLT$zeta),
                  length(mod2_MOTORCYCLISTxHV$coefficients) + length(mod2_MOTORCYCLISTxHV$zeta)),
           AIC2 = c(AIC(mod2_LDxLD),
                    AIC(mod2_LDxLT),
                    AIC(mod2_LDxHV),
                    AIC(mod2_LTxLD),
                    AIC(mod2_LTxLT),
                    AIC(mod2_LTxHV),
                    AIC(mod2_HVxLD),
                    AIC(mod2_HVxLT),
                    AIC(mod2_HVxHV),
                    AIC(mod2_PEDESTRIANxLD),
                    AIC(mod2_PEDESTRIANxLT),
                    AIC(mod2_PEDESTRIANxHV),
                    AIC(mod2_BICYCLISTxLD),
                    AIC(mod2_BICYCLISTxLT),
                    NA, 
                    AIC(mod2_MOTORCYCLISTxLD),
                    AIC(mod2_MOTORCYCLISTxLT),
                    AIC(mod2_MOTORCYCLISTxHV)),
           k3 = c(length(mod3_LDxLD$coefficients) + length(mod3_LDxLD$zeta),
                  length(mod3_LDxLT$coefficients) + length(mod3_LDxLT$zeta),
                  length(mod3_LDxHV$coefficients) + length(mod3_LDxHV$zeta),
                  length(mod3_LTxLD$coefficients) + length(mod3_LTxLD$zeta),
                  length(mod3_LTxLT$coefficients) + length(mod3_LTxLT$zeta),
                  length(mod3_LTxHV$coefficients) + length(mod3_LTxHV$zeta),
                  length(mod3_HVxLD$coefficients) + length(mod3_HVxLD$zeta),
                  length(mod3_HVxLT$coefficients) + length(mod3_HVxLT$zeta),
                  length(mod3_HVxHV$coefficients) + length(mod3_HVxHV$zeta),
                  length(mod3_PEDESTRIANxLD$coefficients) + length(mod3_PEDESTRIANxLD$zeta),
                  length(mod3_PEDESTRIANxLT$coefficients) + length(mod3_PEDESTRIANxLT$zeta),
                  length(mod3_PEDESTRIANxHV$coefficients) + length(mod3_PEDESTRIANxHV$zeta),
                  length(mod3_BICYCLISTxLD$coefficients) + length(mod3_BICYCLISTxLD$zeta),
                  length(mod3_BICYCLISTxLT$coefficients) + length(mod3_BICYCLISTxLT$zeta),
                  NA, 
                  length(mod3_MOTORCYCLISTxLD$coefficients) + length(mod3_MOTORCYCLISTxLD$zeta),
                  length(mod3_MOTORCYCLISTxLT$coefficients) + length(mod3_MOTORCYCLISTxLT$zeta),
                  length(mod3_MOTORCYCLISTxHV$coefficients) + length(mod3_MOTORCYCLISTxHV$zeta)),
           AIC3 = c(AIC(mod3_LDxLD),
                    AIC(mod3_LDxLT),
                    AIC(mod3_LDxHV),
                    AIC(mod3_LTxLD),
                    AIC(mod3_LTxLT),
                    AIC(mod3_LTxHV),
                    AIC(mod3_HVxLD),
                    AIC(mod3_HVxLT),
                    AIC(mod3_HVxHV),
                    AIC(mod3_PEDESTRIANxLD),
                    AIC(mod3_PEDESTRIANxLT),
                    AIC(mod3_PEDESTRIANxHV),
                    AIC(mod3_BICYCLISTxLD),
                    AIC(mod3_BICYCLISTxLT),
                    NA, 
                    AIC(mod3_MOTORCYCLISTxLD),
                    AIC(mod3_MOTORCYCLISTxLT),
                    AIC(mod3_MOTORCYCLISTxHV)),
           k4 = c(length(mod4_LDxLD$coefficients) + length(mod4_LDxLD$zeta),
                  length(mod4_LDxLT$coefficients) + length(mod4_LDxLT$zeta),
                  length(mod4_LDxHV$coefficients) + length(mod4_LDxHV$zeta),
                  length(mod4_LTxLD$coefficients) + length(mod4_LTxLD$zeta),
                  length(mod4_LTxLT$coefficients) + length(mod4_LTxLT$zeta),
                  length(mod4_LTxHV$coefficients) + length(mod4_LTxHV$zeta),
                  length(mod4_HVxLD$coefficients) + length(mod4_HVxLD$zeta),
                  length(mod4_HVxLT$coefficients) + length(mod4_HVxLT$zeta),
                  length(mod4_HVxHV$coefficients) + length(mod4_HVxHV$zeta),
                  length(mod4_PEDESTRIANxLD$coefficients) + length(mod4_PEDESTRIANxLD$zeta),
                  length(mod4_PEDESTRIANxLT$coefficients) + length(mod4_PEDESTRIANxLT$zeta),
                  length(mod4_PEDESTRIANxHV$coefficients) + length(mod4_PEDESTRIANxHV$zeta),
                  length(mod4_BICYCLISTxLD$coefficients) + length(mod4_BICYCLISTxLD$zeta),
                  length(mod4_BICYCLISTxLT$coefficients) + length(mod4_BICYCLISTxLT$zeta),
                  NA, 
                  length(mod4_MOTORCYCLISTxLD$coefficients) + length(mod4_MOTORCYCLISTxLD$zeta),
                  length(mod4_MOTORCYCLISTxLT$coefficients) + length(mod4_MOTORCYCLISTxLT$zeta),
                  length(mod4_MOTORCYCLISTxHV$coefficients) + length(mod4_MOTORCYCLISTxHV$zeta)),
           AIC4 = c(AIC(mod4_LDxLD),
                    AIC(mod4_LDxLT),
                    AIC(mod4_LDxHV),
                    AIC(mod4_LTxLD),
                    AIC(mod4_LTxLT),
                    AIC(mod4_LTxHV),
                    AIC(mod4_HVxLD),
                    AIC(mod4_HVxLT),
                    AIC(mod4_HVxHV),
                    AIC(mod4_PEDESTRIANxLD),
                    AIC(mod4_PEDESTRIANxLT),
                    AIC(mod4_PEDESTRIANxHV),
                    AIC(mod4_BICYCLISTxLD),
                    AIC(mod4_BICYCLISTxLT),
                    NA, 
                    AIC(mod4_MOTORCYCLISTxLD),
                    AIC(mod4_MOTORCYCLISTxLT),
                    AIC(mod4_MOTORCYCLISTxHV))) %>%
  mutate(n1 = format(n1, digits = 2, big.mark = ","),
         AIC1 = format(AIC1, digits = 2, big.mark = ","),
         AIC2 = format(AIC2, digits = 2, big.mark = ","),
         AIC3 = format(AIC3, digits = 2, big.mark = ","),
         AIC4 = format(AIC4, digits = 2, big.mark = ","),
         n1 = replace(n1, n1 == "     NA", "-"),
         k1 = replace(k1, is.na(k1), "-"),
         k2 = replace(k2, is.na(k2), "-"),
         k3 = replace(k3, is.na(k3), "-"),
         k4 = replace(k4, is.na(k4), "-"),
         AIC1 = replace(AIC1, AIC1 == "     NA", "-"),
         AIC2 = replace(AIC2, AIC2 == "     NA", "-"),
         AIC3 = replace(AIC3, AIC3 == "     NA", "-"),
         AIC4 = replace(AIC4, AIC4 == "     NA", "-")) %>%
  kable(digits = 2,
        booktabs = TRUE,
        escape = FALSE,
        align = c("l", "c", "c", "c", "c", "c", "c", "c", "c", "c"),
        col.names = linebreak(c("Model", "Number of\nobservations", 
                                "Number of\ncoefficients", "AIC",
                                "Number of\ncoefficients", "AIC", 
                                "Number of\ncoefficients", "AIC", 
                                "Number of\ncoefficients", "AIC")),
        caption = "\\label{tab:model-summary}Summary of model estimation results: Data Subset Models") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "scale_down")) %>%
  add_header_above(c(" " = 1, " " = 1, 
                     "Model 1\nSingle-level/No opponent" = 2, 
                     "Model 2\nSingle-level/Opponent attributes" = 2, 
                     "Model 3\nHierarchical: Traffic unit" = 2, 
                     "Model 4\nHierarchical: Opponent" = 2)) %>%
  landscape() %>%
  footnote(general = "There are zero cases of Bicyclist vs heavy vehicle in the sample")
```

## Outcome shares based on predicted probabilities {#sec:outcomes-shares}

In this, and the following section, _backcasting_ refers to the prediction of probabilities and classes of outcomes using the 2016 data set. When conducting backcasting, the data set is preprocessed in identical manner as the 2017 data set. In addition, the variables used in backcasting match exactly those in the models. This means that some variables were dropped when they were present in the 2016 data set but not in the models. This tended to happen in the case of relatively rare outcomes (e.g., in 2016, there was at least one collision between a heavy vehicle and a light duty vehicle in a school crossing zone; no such event was observed in 2017). 

The shares of each outcome are calculated as the sum of the estimated probabilities for each observation:

\begin{equation}
\label{eq:predicted-shares}
\begin{array}{rcl}
\hat{S}_{\text{PDO}} &=& \sum_{itk}\hat{P}(y_{itk}=\text{PDO})\\
\hat{S}_{\text{injury}} &=& \sum_{itk}\hat{P}(y_{itk}=\text{injury})\\
\hat{S}_{\text{fatality}} &=& \sum_{itk}\hat{P}(y_{itk}=\text{fatality})
\end{array}
\end{equation}

\noindent where $\hat{P}(y_{itk}=h_w)$ is the estimated probability of outcome $h_w$ for individual $i$ in traffic unit $t$ and crash $k$. The estimated share of outcome $h$ is $\hat{S}_{h_w}$.

The estimated shares can be used to assess the ability of the model to forecast for the population the total number of cases of each outcome. A summary statistic useful to evaluate the performance is the Average Percentage Error, or $APE$ [see @Bogue2017modified, p. 31], which is calculated for each outcome as follows:

\begin{equation}
\label{eq:APE}
APE_{h_w} = \Bigg|\frac{\hat{S}_{h_w} - S_{h_w}}{S_{h_w}}\Bigg|\times 100
\end{equation}

The Weighted Average Percentage Error ($WAPE$) aggregates the $APE$ as follows:

\begin{equation}
\label{eq:WAPE}
WAPE = \frac{\sum_w^WAPE_{h_w}\times S_{h_w}}{\sum_w^WS_{h_w}}
\end{equation}

The results of this exercise are reported in Table \ref{tab:ape-results}. Of the four full-sample models (Models 1-4), the $APE$ of Model 2 is lowest in the nowcasting exercise for every outcome, with the exception of Fatality, where Model 4 produces a considerably lower $APE$. When the results are aggregated by means of the $WAPE$, Model 2 gives marginally better results than Model 4. It is interesting to see that the four ensemble models have lower $APE$ values across the board in the nowcasting exercise, and much better $WAPE$ than the full sample models. However, once we turn to the results of the backcasting exercise, these results do not hold, and it is possible to see that the Average Percentage Errors of the ensemble worsen considerably, particularly in the case of Fatality. The Weighted Average Prediction Error of the ensemble models in the backcasting exercise is also worse than for any of the full sample models. Excellent in-sample predictions but not as good out-of-sample predictions are often evidence of overfitting, as in the case of the ensemble models here. 

In terms of backcasting, full sample Model 1 is marginally better than full sample Models 2 and 3, and better than full sample Model 4. The reason for this is the lower $APE$ of Model 1 when predicting Injury, the most frequent outcome. However, the performance of Model 1 with respect to Fatality (the least frequent outcome) is the worst of all models. Whereas Model 4 has the best performance predicting Fatality, its performance with respect to other classes of outcomes is less impressive. Model 3 does better than Model 2 with respect to Injury, but performs relatively poorly when backcasting Fatality. Overall, Model 2 appears to be the most balanced, with good in-sample performance and competitive out-of-sample performance that is also balanced with respect to the various classes of outcomes.

```{r nowcast-probabilities-model-1, include=FALSE, cache=TRUE}
# Nowcast of probabilities and shares
P_ISEV_mod1 = predict(mod1, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 1")
```

```{r nowcast-probabilities-model-1-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod1_ensemble <- rbind(predict(mod1_LDxLD, 
                                      newdata = nowcast_data.df %>% filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LDxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LDxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLD == 1, 
                                               C_RCFG != "Freeway Express Lane",
                                               C_RCFG != "Traffic circle",
                                               C_RSUR != "Muddy",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_WTHR != "Other",
                                               C_TRAF != "Warning sign",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Markings on the road") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_BICYCLISTxLD, 
                                      newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_BICYCLISTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               C_CONF != "Hit a stationary object",
                                               C_CONF != "Ran off left shoulder",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_CONF != "Head-on collision",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Unknown",
                                               C_TRAF != "Other",
                                               C_TRAF != "School guard") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1, 
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Unknown",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "School guard",
                                               C_WTHR != "Raining") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLD == 1, 
                            C_RCFG != "Freeway Express Lane",
                            C_RCFG != "Traffic circle",
                            C_RSUR != "Muddy",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_WTHR != "Other",
                            C_TRAF != "Warning sign",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Markings on the road") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other",
                            C_CONF != "Hit a stationary object",
                            C_CONF != "Ran off left shoulder",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_CONF != "Head-on collision",
                            C_CONF != "Right turn, including turning conflicts",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Unknown",
                            C_TRAF != "Other",
                            C_TRAF != "School guard") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1, 
                            P1_SAFE != "Safety Device",
                            C_CONF != "Unknown",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "School guard",
                            C_WTHR != "Raining") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 1 Ensemble")
```

```{r nowcast-probabilities-model-2, include=FALSE, cache=TRUE}
P_ISEV_mod2 = predict(mod2, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 2")
```

```{r nowcast-probabilities-model-2-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod2_ensemble <- rbind(predict(mod2_LDxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LDxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LDxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Warning sign") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Ran off right shoulder") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_BICYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_BICYCLISTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1,
                                               P1_SAFE != "Safety Device",
                                               P1_SAFE != "Other",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Unknown",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Markings on the road") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Warning sign") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Ran off right shoulder") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1,
                            P1_SAFE != "Safety Device",
                            P1_SAFE != "Other",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Unknown",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Markings on the road") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 2 Ensemble")
```

```{r nowcast-probabilities-model-3, include=FALSE, cache=TRUE}
P_ISEV_mod3 = predict(mod3, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 3")
```

```{r nowcast-probabilities-model-3-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod3_ensemble <- rbind(predict(mod3_LDxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LDxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LDxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Warning sign") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Ran off right shoulder"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_BICYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_BICYCLISTxLT, 
                                      newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                           P1_SAFE != "Other") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod3_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxLD, 
                                      newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxLT, 
                                      newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Approaching side-swipe",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "School guard",
                                               C_TRAF != "Markings on the road") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Warning sign") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Ran off right shoulder") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                              P1_SAFE != "Other") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Approaching side-swipe",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "School guard",
                            C_TRAF != "Markings on the road") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 3 Ensemble")
```

```{r nowcast-probabilities-model-4, include=FALSE, cache=TRUE}
P_ISEV_mod4 = predict(mod4, newdata = nowcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2017_paired_records$P_ISEV,
             P1_USER = ncdb_2017_paired_records$P1_USER,
             xLD = nowcast_data.df$xLD,
             xLT = nowcast_data.df$xLT,
             xHV = nowcast_data.df$xHV,
             Model = "Model 4")
```

```{r nowcast-probabilities-model-4-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod4_ensemble <- rbind(predict(mod4_LDxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_LDxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_LDxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LDxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_LTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_LTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_LTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(LTxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_HVxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Warning sign") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_HVxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Side swipe") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_HVxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(HVxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_PEDESTRIANxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_PEDESTRIANxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_PEDESTRIANxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_BICYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_BICYCLISTxLT, 
                                      newdata = nowcast_data.df %>%
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               C_CONF != "Ran off left shoulder",
                                               C_CONF != "Ran off right shoulder",
                                               C_WTHR != "Visibility limitation") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod4_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod4_MOTORCYCLISTxLD, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_MOTORCYCLISTxLT, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1,
                                               P1_SAFE != "Vehicle not Equiped",
                                               P1_SAFE != "Other",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Side swipe",
                                               C_RCFG != "Ramp",
                                               C_RCFG != "Unknown",
                                               C_RCFG != "Other",
                                               C_TRAF != "Yield sign") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod4_MOTORCYCLISTxHV, 
                                      newdata = nowcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1, 
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Approaching side-swipe",
                                               C_RCFG != "Bridge/Overpass/Viaduct") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  data.frame(rbind(nowcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LDxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(LTxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Warning sign") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Side swipe") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(HVxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1) %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other",
                            C_CONF != "Ran off left shoulder",
                            C_CONF != "Ran off right shoulder",
                            C_WTHR != "Visibility limitation") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1,
                            P1_SAFE != "Vehicle not Equiped",
                            P1_SAFE != "Other",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Side swipe",
                            C_RCFG != "Ramp",
                            C_RCFG != "Unknown",
                            C_RCFG != "Other",
                            C_TRAF != "Yield sign") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   nowcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1, 
                            P1_SAFE != "Safety Device",
                            C_CONF != "Approaching side-swipe",
                            C_RCFG != "Bridge/Overpass/Viaduct") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 4 Ensemble")
```

```{r nowcast-probabilities-collect-results, include=FALSE}
# Collect the results of the nowcasting exercise
nowcast.probs <- rbind(P_ISEV_mod1,
                       P_ISEV_mod2,
                       P_ISEV_mod3,
                       P_ISEV_mod4,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3_ensemble,
                       P_ISEV_mod4_ensemble)
```

```{r nowcast-probabilities-summary, include=FALSE, cache=TRUE}
# Summarize the results of nowcasting the probabilities by calculating the shares of each outcome as the sum of the predicted probabilities; based on the predicted shares, calculate the Average Prediction Error (APE) and the Weighted Average Prediction Error (WAPE). See Bogue, Paleti, and Balan (2017) for an example of these measures
nowcast_ape <- nowcast.probs %>% 
  #filter(P_ISEV == "No Injury") %>% 
  dplyr::select(P_ISEV, No.Injury, Injury, Fatality, Model) %>%
  group_by(Model) %>%
  summarize(No.Injury.2017 = sum(P_ISEV == "No Injury"), 
            No.Injury = sum(No.Injury),
            Injury.2017 = sum(P_ISEV == "Injury"), 
            Injury = sum(Injury),
            Fatality.2017 = sum(P_ISEV == "Fatality"), 
            Fatality = sum(Fatality)) %>%
  transmute(Model, 
            No.Injury.2017, 
            No.Injury, 
            APE.No.Injury = abs(No.Injury - No.Injury.2017)/No.Injury.2017 * 100,
            Injury.2017, 
            Injury, 
            APE.Injury = abs(Injury - Injury.2017)/Injury.2017 * 100,
            Fatality.2017, 
            Fatality, 
            APE.Fatality = abs(Fatality - Fatality.2017)/Fatality.2017 * 100,
            WAPE = (APE.No.Injury * No.Injury.2017 + APE.Injury * Injury.2017 + APE.Fatality * Fatality.2017)/(No.Injury.2017 + Injury.2017 + Fatality.2017))
```

```{r backcast-probabilities-model-1, include=FALSE, cache=TRUE}
# The 2016 dataset is used to Backcast of probabilities and shares of the outcomes.
P_ISEV_mod1 = predict(mod1, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 1")
```

```{r backcast-probabilities-model-1-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod1_ensemble <- rbind(predict(mod1_LDxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LDxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLT == 1,
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LDxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxHV == 1,
                                               C_CONF != "Rollover on roadway",
                                               C_RSUR != "Oil",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLD == 1,
                                               P1_SAFE != "Helmet",
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLT == 1,
                                               C_WTHR != "Unknown",
                                               C_RALN != "Unknown"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_LTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxHV == 1,
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLD == 1, 
                                               C_RCFG != "Freeway Express Lane",
                                               C_RCFG != "Traffic circle",
                                               C_RSUR != "Muddy",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RSUR != "Oil",
                                               C_WTHR != "Other",
                                               C_TRAF != "Warning sign",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only",
                                               C_TRAF != "Control device not specified") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_HVxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxHV == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Other",
                                               C_TRAF != "Flashing Traffic"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1,
                                               C_RCFG != "Tunnel/Underpass"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Side swipe",
                                               C_WTHR != "Strong wind",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Flashing Traffic"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_PEDESTRIANxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1,
                                               C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing",
                                               C_TRAF != "Control device not specified"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_BICYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1,
                                               C_CONF != "Ran off left shoulder",
                                               C_TRAF != "No passing zone sign", 
                                               C_TRAF != "Control device not specified"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_BICYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Hit a stationary object",
                                               C_CONF != "Ran off left shoulder",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_CONF != "Head-on collision",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Unknown",
                                               C_TRAF != "Other",
                                               C_TRAF != "School guard",
                                               C_WTHR != "Unknown",
                                               C_RALN != "Curved and level") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1,
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_WTHR != "Freezing rain, sleet, hail", 
                                               C_WTHR != "Strong wind"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1,
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_MNTH != "December"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod1_MOTORCYCLISTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1, 
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Unknown",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Intersection with Entrance",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "School guard",
                                               C_WTHR != "Raining",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_MNTH != "November") %>% 
                                        droplevels(), type = "probs")) %>%
  data.frame(rbind(backcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LDxLT == 1,
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LDxHV == 1,
                            C_CONF != "Rollover on roadway",
                            C_RSUR != "Oil",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxLD == 1,
                            P1_SAFE != "Helmet",
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxLT == 1,
                            C_WTHR != "Unknown",
                            C_RALN != "Unknown") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxHV == 1,
                            C_CONF != "Hit a parked motor vehicle",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxLD == 1, 
                            C_RCFG != "Freeway Express Lane",
                            C_RCFG != "Traffic circle",
                            C_RSUR != "Muddy",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RSUR != "Oil",
                            C_WTHR != "Other",
                            C_TRAF != "Warning sign",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only",
                            C_TRAF != "Control device not specified") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Hit a parked motor vehicle",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxHV == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Other",
                            C_TRAF != "Flashing Traffic") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1,
                            C_RCFG != "Tunnel/Underpass") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Side swipe",
                            C_WTHR != "Strong wind",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Flashing Traffic") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1,
                            C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Any other two-vehicle - different direction of travel configuration",
                            C_TRAF != "School bus stopped with school bus signal lights flashing",
                            C_TRAF != "Control device not specified") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(BICYCLISTxLD == 1,
                            C_CONF != "Ran off left shoulder",
                            C_TRAF != "No passing zone sign", 
                            C_TRAF != "Control device not specified") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other",
                            P1_SAFE != "Safety Device",
                            C_CONF != "Hit a stationary object",
                            C_CONF != "Ran off left shoulder",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_CONF != "Head-on collision",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Hit a parked motor vehicle",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Unknown",
                            C_TRAF != "Other",
                            C_TRAF != "School guard",
                            C_WTHR != "Unknown",
                            C_RALN != "Curved and level") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1,
                            C_WTHR != "Snowing, not including drifting snow",
                            C_WTHR != "Freezing rain, sleet, hail", 
                            C_WTHR != "Strong wind") %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1,
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Snowing, not including drifting snow",
                            C_MNTH != "December") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1, 
                            P1_SAFE != "Safety Device",
                            C_CONF != "Unknown",
                            C_CONF != "Right turn, including turning conflicts",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Intersection with Entrance",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "School guard",
                            C_WTHR != "Raining",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_MNTH != "November") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 1 Ensemble")
```

```{r backcast-probabilities-model-2, include=FALSE, cache=TRUE}
P_ISEV_mod2 = predict(mod2, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = backcast_data.df$P_ISEV,
             P1_USER = backcast_data.df$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 2")
```

```{r  backcast-probabilities-model-2-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod2_ensemble <- rbind(predict(mod2_LDxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LDxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLT == 1,
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LDxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxHV == 1,
                                               C_CONF != "Rollover on roadway",
                                               C_RSUR != "Oil",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLD == 1,
                                               P1_SAFE != "Helmet",
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLT == 1,
                                               C_WTHR != "Unknown",
                                               C_RALN != "Unknown"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_LTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxHV == 1,
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RSUR != "Oil",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Warning sign",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only",
                                               C_TRAF != "Control device not specified") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_HVxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxHV == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Other",
                                               C_TRAF != "Flashing Traffic"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1,
                                               C_RCFG != "Tunnel/Underpass"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Side swipe",
                                               C_WTHR != "Strong wind",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Flashing Traffic"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_PEDESTRIANxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1,
                                               C_CONF != "One vehicle passing to the right of the other, or right turn conflict", 
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing",
                                               C_TRAF != "Control device not specified"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_BICYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1,
                                               C_CONF != "Ran off left shoulder",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Control device not specified"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_BICYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_WTHR != "Unknown",
                                               C_RALN != "Curved and level") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxLD,
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1,
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_WTHR != "Freezing rain, sleet, hail",
                                               C_WTHR != "Strong wind"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1,
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_MNTH != "December"),
                                      type = "probs"),
                              #**********************************#
                              predict(mod2_MOTORCYCLISTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1,
                                               P1_SAFE != "Safety Device",
                                               P1_SAFE != "Other",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Unknown",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Intersection with Entrance",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Markings on the road",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_MNTH != "November") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  #**********************************#
  data.frame(rbind(backcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LDxLT == 1,
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LDxHV == 1,
                            C_CONF != "Rollover on roadway",
                            C_RSUR != "Oil",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxLD == 1,
                            P1_SAFE != "Helmet",
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxLT == 1,
                            C_WTHR != "Unknown",
                            C_RALN != "Unknown") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(LTxHV == 1,
                            C_CONF != "Hit a parked motor vehicle",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RSUR != "Oil",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Warning sign",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only",
                            C_TRAF != "Control device not specified") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Hit a parked motor vehicle",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(HVxHV == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Other",
                            C_TRAF != "Flashing Traffic") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1,
                            C_RCFG != "Tunnel/Underpass") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Side swipe",
                            C_WTHR != "Strong wind",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Flashing Traffic") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1,
                            C_CONF != "One vehicle passing to the right of the other, or right turn conflict", 
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Any other two-vehicle - different direction of travel configuration",
                            C_TRAF != "School bus stopped with school bus signal lights flashing",
                            C_TRAF != "Control device not specified") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(BICYCLISTxLD == 1,
                            C_CONF != "Ran off left shoulder",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Control device not specified") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other",
                            P1_SAFE != "Safety Device",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Hit a parked motor vehicle",
                            C_WTHR != "Unknown",
                            C_RALN != "Curved and level") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1,
                            C_WTHR != "Snowing, not including drifting snow",
                            C_WTHR != "Freezing rain, sleet, hail",
                            C_WTHR != "Strong wind") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1,
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Snowing, not including drifting snow",
                            C_MNTH != "December") %>%
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #**********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1,
                            P1_SAFE != "Safety Device",
                            P1_SAFE != "Other",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Unknown",
                            C_CONF != "Right turn, including turning conflicts",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Intersection with Entrance",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Markings on the road",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_MNTH != "November") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 2 Ensemble")
```

```{r backcast-probabilities-model-3, include=FALSE, cache=TRUE}
P_ISEV_mod3 = predict(mod3, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 3")
```

```{r backcast-probabilities-model-3-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod3_ensemble <- rbind(predict(mod3_LDxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LDxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLT == 1,
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LDxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxHV == 1,
                                               C_CONF != "Rollover on roadway",
                                               C_RSUR != "Oil",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLD == 1,
                                               P1_SAFE != "Helmet",
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLT == 1,
                                               C_WTHR != "Unknown",
                                               C_RALN != "Unknown"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_LTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxHV == 1,
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RSUR != "Oil",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Markings on the road",
                                               C_TRAF != "Warning sign",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only",
                                               C_TRAF != "Control device not specified") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_HVxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxHV == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Other",
                                               C_TRAF != "Flashing Traffic"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1,
                                               C_RCFG != "Tunnel/Underpass"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Side swipe",
                                               C_WTHR != "Strong wind",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Flashing Traffic"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_PEDESTRIANxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1,
                                               C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing",
                                               C_TRAF != "Control device not specified"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_BICYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1,
                                               C_CONF != "Ran off left shoulder",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Control device not specified"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_BICYCLISTxLT, 
                                      newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                            P1_SAFE != "Other",
                                                                            P1_SAFE != "Safety Device",
                                                                            C_CONF != "Other Single Vehicle",
                                                                            C_CONF != "Hit a parked motor vehicle",
                                                                            C_WTHR != "Unknown",
                                                                            C_RALN != "Curved and level") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #**********************************#
                              #predict(mod3_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1,
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_WTHR != "Freezing rain, sleet, hail",
                                               C_WTHR != "Strong wind"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1,
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_MNTH != "December"), 
                                      type = "probs"),
                              #**********************************#
                              predict(mod3_MOTORCYCLISTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Intersection with Entrance",
                                               C_RCFG != "Other",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "School guard",
                                               C_TRAF != "Markings on the road",
                                               C_WTHR != "Strong wind",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_MNTH != "November") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  #********************************#
  data.frame(rbind(backcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(LDxLT == 1,
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(LDxHV == 1,
                            C_CONF != "Rollover on roadway",
                            C_RSUR != "Oil",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(LTxLD == 1,
                            P1_SAFE != "Helmet",
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(LTxLT == 1,
                            C_WTHR != "Unknown",
                            C_RALN != "Unknown") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(LTxHV == 1,
                            C_CONF != "Hit a parked motor vehicle",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RSUR != "Oil",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Markings on the road",
                            C_TRAF != "Warning sign",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only",
                            C_TRAF != "Control device not specified") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Hit a parked motor vehicle",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(HVxHV == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Other",
                            C_TRAF != "Flashing Traffic") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1,
                            C_RCFG != "Tunnel/Underpass") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Side swipe",
                            C_WTHR != "Strong wind",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Flashing Traffic") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1,
                            C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Any other two-vehicle - different direction of travel configuration",
                            C_TRAF != "School bus stopped with school bus signal lights flashing",
                            C_TRAF != "Control device not specified") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(BICYCLISTxLD == 1,
                            C_CONF != "Ran off left shoulder",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Control device not specified") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_WTHR != "Unknown",
                                               C_RALN != "Curved and level") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1,
                            C_WTHR != "Snowing, not including drifting snow",
                            C_WTHR != "Freezing rain, sleet, hail",
                            C_WTHR != "Strong wind") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1,
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Snowing, not including drifting snow",
                            C_MNTH != "December") %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #********************************#
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Right turn, including turning conflicts",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Intersection with Entrance",
                            C_RCFG != "Other",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "School guard",
                            C_TRAF != "Markings on the road",
                            C_WTHR != "Strong wind",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_MNTH != "November") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 3 Ensemble")
```

```{r  backcast-probabilities-model-4, include=FALSE, cache=TRUE}
P_ISEV_mod4 = predict(mod4, newdata = backcast_data.df, type = "probs") %>%
  data.frame(P_ISEV = ncdb_2016_paired_records$P_ISEV,
             P1_USER = ncdb_2016_paired_records$P1_USER,
             xLD = backcast_data.df$xLD,
             xLT = backcast_data.df$xLT,
             xHV = backcast_data.df$xHV,
             Model = "Model 4")
```

```{r backcast-probabilities-model-4-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod4_ensemble <- rbind(predict(mod4_LDxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLD == 1), 
                                      type = "probs"),
                              predict(mod4_LDxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxLT == 1,
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_LDxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LDxHV == 1,
                                               C_CONF != "Rollover on roadway",
                                               C_RSUR != "Oil",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only")%>% 
                                        droplevels(),
                                      type = "probs"),
                              predict(mod4_LTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLD == 1,
                                               P1_SAFE != "Helmet",
                                               C_CONF != "Hit a stationary object",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RALN != "Other",
                                               C_TRAF != "Railway crossing with signals, or signals and gates")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_LTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxLT == 1,
                                               C_WTHR != "Unknown",
                                               C_RALN != "Unknown")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_LTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(LTxHV == 1,
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_HVxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLD == 1,
                                               C_RCFG != "Traffic circle",
                                               C_RCFG != "Freeway Express Lane",
                                               C_WTHR != "Other",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_RSUR != "Oil",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Warning sign",
                                               C_TRAF != "School crossing",
                                               C_TRAF != "Railway crossing with signals, or signals and gates",
                                               C_TRAF != "Railway crossing with signs only",
                                               C_TRAF != "Control device not specified") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_HVxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxLT == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Side swipe",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RSUR != "Other",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_HVxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(HVxHV == 1,
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_WTHR != "Other",
                                               C_TRAF != "Flashing Traffic")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_PEDESTRIANxLD, newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLD == 1,
                                               C_RCFG != "Tunnel/Underpass")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_PEDESTRIANxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxLT == 1,
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Side swipe",
                                               C_WTHR != "Strong wind",
                                               C_RALN != "Top of hill or gradient",
                                               C_TRAF != "Flashing Traffic")%>% 
                                        droplevels(),
                                      type = "probs"),
                              predict(mod4_PEDESTRIANxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(PEDESTRIANxHV == 1,
                                               C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                               C_TRAF != "School bus stopped with school bus signal lights flashing",
                                               C_TRAF != "Control device not specified")%>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_BICYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLD == 1,
                                               C_CONF != "Ran off left shoulder",
                                               C_TRAF != "No passing zone sign",
                                               C_TRAF != "Control device not specified")%>% 
                                        droplevels(),
                                      type = "probs"),
                              predict(mod4_BICYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(BICYCLISTxLT == 1,
                                               P1_SAFE != "Other",
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Ran off left shoulder",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Hit a parked motor vehicle",
                                               C_WTHR != "Visibility limitation",
                                               C_WTHR != "Unknown",
                                               C_RALN != "Curved and level") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "probs"),
                              predict(mod4_MOTORCYCLISTxLD, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLD == 1,
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_WTHR != "Freezing rain, sleet, hail",
                                               C_WTHR != "Strong wind") %>% 
                                        droplevels(),
                                      type = "probs"),
                              predict(mod4_MOTORCYCLISTxLT, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxLT == 1,
                                               P1_SAFE != "Vehicle not Equiped",
                                               P1_SAFE != "Other",
                                               C_CONF != "Ran off right shoulder",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_CONF != "Other Single Vehicle",
                                               C_CONF != "Side swipe",
                                               C_CONF != "Any other two vehicle - same direction of travel configuration",
                                               C_RCFG != "Ramp",
                                               C_RCFG != "Unknown",
                                               C_RCFG != "Other",
                                               C_TRAF != "Yield sign",
                                               C_WTHR != "Snowing, not including drifting snow",
                                               C_RALN != "Top of hill or gradient",
                                               C_MNTH != "December") %>% 
                                        droplevels(), 
                                      type = "probs"),
                              predict(mod4_MOTORCYCLISTxHV, 
                                      newdata = backcast_data.df %>% 
                                        filter(MOTORCYCLISTxHV == 1, 
                                               P1_SAFE != "Safety Device",
                                               C_CONF != "Approaching side-swipe",
                                               C_CONF != "Right turn, including turning conflicts",
                                               C_RCFG != "Bridge/Overpass/Viaduct",
                                               C_RCFG != "Intersection with Entrance",
                                               C_RCFG != "Other",
                                               C_WTHR != "Strong wind",
                                               C_RSUR != "Sand/Gravel/Dirt",
                                               C_MNTH != "November") %>% 
                                        droplevels(), 
                                      type = "probs")) %>%
  data.frame(rbind(backcast_data.df %>% 
                     filter(LDxLD == 1) %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(LDxLT == 1,
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(LDxHV == 1,
                            C_CONF != "Rollover on roadway",
                            C_RSUR != "Oil",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(LTxLD == 1,
                            P1_SAFE != "Helmet",
                            C_CONF != "Hit a stationary object",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RALN != "Other",
                            C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(LTxLT == 1,
                            C_WTHR != "Unknown",
                            C_RALN != "Unknown") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(LTxHV == 1,
                            C_CONF != "Hit a parked motor vehicle",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(HVxLD == 1,
                            C_RCFG != "Traffic circle",
                            C_RCFG != "Freeway Express Lane",
                            C_WTHR != "Other",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_RSUR != "Oil",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Warning sign",
                            C_TRAF != "School crossing",
                            C_TRAF != "Railway crossing with signals, or signals and gates",
                            C_TRAF != "Railway crossing with signs only",
                            C_TRAF != "Control device not specified") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(HVxLT == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Side swipe",
                            C_CONF != "Hit a parked motor vehicle",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RSUR != "Other",
                            C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                     droplevels() %>%
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(HVxHV == 1,
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_WTHR != "Other",
                            C_TRAF != "Flashing Traffic") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLD == 1,
                            C_RCFG != "Tunnel/Underpass") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(PEDESTRIANxLT == 1,
                            P1_SAFE != "Safety Device",
                            C_CONF != "Side swipe",
                            C_WTHR != "Strong wind",
                            C_RALN != "Top of hill or gradient",
                            C_TRAF != "Flashing Traffic") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(PEDESTRIANxHV == 1,
                            C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Any other two-vehicle - different direction of travel configuration",
                            C_TRAF != "School bus stopped with school bus signal lights flashing",
                            C_TRAF != "Control device not specified") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(BICYCLISTxLD == 1,
                            C_CONF != "Ran off left shoulder",
                            C_TRAF != "No passing zone sign",
                            C_TRAF != "Control device not specified") %>%
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(BICYCLISTxLT == 1,
                            P1_SAFE != "Other",
                            P1_SAFE != "Safety Device",
                            C_CONF != "Ran off left shoulder",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Hit a parked motor vehicle",
                            C_WTHR != "Visibility limitation",
                            C_WTHR != "Unknown",
                            C_RALN != "Curved and level") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLD == 1,
                            C_WTHR != "Snowing, not including drifting snow",
                            C_WTHR != "Freezing rain, sleet, hail",
                            C_WTHR != "Strong wind") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxLT == 1,
                            P1_SAFE != "Vehicle not Equiped",
                            P1_SAFE != "Other",
                            C_CONF != "Ran off right shoulder",
                            C_CONF != "Right turn, including turning conflicts",
                            C_CONF != "Other Single Vehicle",
                            C_CONF != "Side swipe",
                            C_CONF != "Any other two vehicle - same direction of travel configuration",
                            C_RCFG != "Ramp",
                            C_RCFG != "Unknown",
                            C_RCFG != "Other",
                            C_TRAF != "Yield sign",
                            C_WTHR != "Snowing, not including drifting snow",
                            C_RALN != "Top of hill or gradient",
                            C_MNTH != "December") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                   backcast_data.df %>% 
                     filter(MOTORCYCLISTxHV == 1, 
                            P1_SAFE != "Safety Device",
                            C_CONF != "Approaching side-swipe",
                            C_CONF != "Right turn, including turning conflicts",
                            C_RCFG != "Bridge/Overpass/Viaduct",
                            C_RCFG != "Intersection with Entrance",
                            C_RCFG != "Other",
                            C_WTHR != "Strong wind",
                            C_RSUR != "Sand/Gravel/Dirt",
                            C_MNTH != "November") %>% 
                     droplevels() %>% 
                     dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
             Model = "Model 4 Ensemble")
```

```{r backcast-probabilities-collect-results, include=FALSE}
# Collect predicted probabilities of all models
backcast.probs <- rbind(P_ISEV_mod1,
                        P_ISEV_mod2,
                        P_ISEV_mod3,
                        P_ISEV_mod4,
                        P_ISEV_mod1_ensemble,
                        P_ISEV_mod2_ensemble,
                        P_ISEV_mod3_ensemble,
                        P_ISEV_mod4_ensemble)
```

```{r backcast-probabilities-summary, include=FALSE}
# Summarize the results of backcasting the probabilities by calculating the shares of each outcome as the sum of the predicted probabilities; based on the predicted shares, calculate the Average Prediction Error (APE) and the Weighted Average Prediction Error (WAPE). See Bogue, Paleti, and Balan (2017) for an example of these measures

backcast_ape <- backcast.probs %>% 
  #filter(P_ISEV == "No Injury") %>% 
  dplyr::select(P_ISEV, No.Injury, Injury, Fatality, Model) %>%
  group_by(Model) %>%
  summarize(No.Injury.2016 = sum(P_ISEV == "No Injury"), 
            No.Injury = sum(No.Injury),
            Injury.2016 = sum(P_ISEV == "Injury"), 
            Injury = sum(Injury),
            Fatality.2016 = sum(P_ISEV == "Fatality"), 
            Fatality = sum(Fatality)) %>%
  transmute(Model, 
            No.Injury.2016, 
            No.Injury, 
            APE.No.Injury = abs(No.Injury - No.Injury.2016)/No.Injury.2016 * 100,
            Injury.2016, 
            Injury, 
            APE.Injury = abs(Injury - Injury.2016)/Injury.2016 * 100,
            Fatality.2016, 
            Fatality, 
            APE.Fatality = abs(Fatality - Fatality.2016)/Fatality.2016 * 100,
            WAPE = (APE.No.Injury * No.Injury.2016 + APE.Injury * Injury.2016 + APE.Fatality * Fatality.2016)/(No.Injury.2016 + Injury.2016 + Fatality.2016))
```

```{r table-ape-results, echo=FALSE}
rbind(nowcast_ape %>% rename(No.Injury.obs = No.Injury.2017, Injury.obs = Injury.2017, Fatality.obs = Fatality.2017), 
      backcast_ape %>% rename(No.Injury.obs = No.Injury.2016, Injury.obs = Injury.2016, Fatality.obs = Fatality.2016)) %>%
  kable(digits = 2,
        booktabs = TRUE,
        escape = FALSE,
        col.names = c("Model", 
                      "Observed", "Predicted", "APE", 
                      "Observed", "Predicted", "APE",
                      "Observed", "Predicted", "APE",
                      "WAPE"),
        caption = "\\label{tab:ape-results}Predicted shares and average prediction errors (APE) by model (percentages)") %>%
  add_header_above(c("", "No Injury" = 3, "Injury" = 3, "Fatality" = 3, "")) %>% 
  kable_styling(font_size = 7) %>% 
  #column_spec(1, width = "12em") %>%
  pack_rows("In-sample (nowcasting using 2017 data set, i.e., estimation data set)", 1, 8) %>% 
  pack_rows("Out-of-sample (backcasting using 2016 data set)", 9, 15) %>%
  row_spec(c(0, 1, 3, 5, 6, 8, 9, 11, 13, 15), extra_latex_after = "\\rowcolor{gray!15}") %>%
  footnote(general = c("Model 1. Single-level/No opponent",
                       "Model 2. Single-level/Opponent attributes",
                       "Model 3. Hierarchical: Traffic unit",
                       "Model 4. Hierarchical: Opponent"))
```

## Outcome frequency based on predicted classes {#sec:outcomes-classes}

$APE$ and $WAPE$ are summary measures of the performance of models at the aggregated level. Aggregate-level predictions (i.e., shares of outcomes) are of interest from a population health perspective. In other cases, an analyst might be interested in the predicted outcomes at the individual level. In this section we examine the frequency of outcomes based on predicted classes, using the same two settings as above: nowcasting and backcasting.

The individual-level outcomes are examined using an array of verification statistics. Verification statistics are widely used in the evaluation of predictive approaches were the outcomes are categorical, and are often based on the analysis of _confusion matrices_ [e.g., @Provost1998glossary; @Begueria2006validation]. Confusion matrices are cross-tabulations of _observed_ and _predicted_ classes. In a two-by-two confusion matrix there are four possible combinations of observed to predicted classes: hits, misses, false alarms, and correct non-events, as shown in Table \ref{tab:confusion-matrix}. When the outcome has more than two classes, the confusion matrix is converted to a two-by-two table to calculate verification statistics.

```{r example-confusion-matrix, echo=FALSE}
data.frame(Predicted = c("Yes",
                        "No",
                        "Marginal Total"),
           Yes = c("Hit", "Miss", "Observed Yes"),
           No = c("False Alarm", "Correct Non-event", "Observed No"),
           Margin = c("Predicted Yes", "Predicted No", " ")) %>%
  kable(booktabs = TRUE,
        align = c("l", "c", "c", "c"),
        col.names = c("Predicted", "Yes", "No", "Marginal Total"),
        caption = "\\label{tab:confusion-matrix}Example of a two-by-two confusion matrix") %>%
  kable_styling(font_size = 7, latex_options =  c("striped", "hold_position")) %>%
  add_header_above(c(" " = 1, "Observed" = 2, " " = 1))
```

The statistics used in our assessment are summarized in Table \ref{tab:verification-statistics}, including brief descriptions of their interpretation. The statistics evaluate different aspects of the performance of a model. Some are concerned with the ability of the model to be right, others are concerned with the ability of the model to match the observed outcomes, and yet others measure the ability of the model to not be wrong. These verification statistics are discussed briefly next.

Percent correct and percent correct by class $PC$ and $PC_c$ are relatively simple statistics, and are calculated as the proportion of correct predictions (i.e., hits and correct non-events) relative to the number of events, for the whole table $PC$ or for one class only $PC_c$. 

Bias ($B$) measures for each outcome class the proportion of total predictions by class (e.g., hits as well as false alarms) relative to the total number of cases observed for that class. For this reason, it is possible for predictions to have low bias (values closer to 1) but still do poorly in terms of hits. 

Critical Success Index ($CSI$) evaluates forecasting skill while assuming that the number of correct non-events is inconsequential for demonstrating skill. Accordingly, the statistic is calculated as the proportion of hits relative to the sum of hits plus false alarms plus misses.

Probability of False Detection ($F$) is the proportion of false alarms relative to the total number of times that the event is not observed. This statistic measures the frequency with which the model incorrectly predicts an event, but not when it incorrectly misses it. The Probability of Detection ($POD$), in contrast, measures the frequency with which the model correctly predicts a class, relative to the number of cases of that class. 

The False Alarm Ratio ($FAR$) is the fraction of predictions by class that were false alarms evaluate a different way in which a model can make equivocal predictions. In this case, lower scores are better.

The last three verification statistics that we consider are skill scores that simultaneously consider different aspects of prediction, and are therefore overall indicators of prediction skill. Heidke's Skill Score ($HSS$) is the fraction of correct predictions above those that could be attributed to chance. Peirce's Skill Score ($PSS$) combines the Probability of Detection ($POD$) of a model and its Probability of False Detection ($F$) to measure the skill of a model to discriminate the classes of outcomes. Lastly, Gerrity Score ($GS$) is a measure of the model's skill predicting the correct classes that tends to reward correct forecasts of the least frequent class.

We discuss the results of calculating this battery of verification statistics, first for the nowcasting case (Table \ref{tab:nowcast-outcomes-assessment}) and subsequently for the backcasting case (Table \ref{tab:backcast-outcomes-assessment}).

```{r table-verification-statistics, echo=FALSE, cache=TRUE}
data.frame(Statistic = c("Percent Correct ($PC$)",
                         "Percent Correct by Class ($PC_c$)",
                         "Bias ($B$)",
                         "Critical Success Index ($CSI$)",
                         "Probability of False Detection ($F$)",
                         "Probability of Detection ($POD$)",
                         "False Alarm Ratio ($FAR$)",
                         "Heidke Skill Score ($HSS$)",
                         "Peirce Skill Score ($PSS$)",
                         "Gerrity Score ($GS$)"),
           Description = c("Total hits and correct non-events divided by number of cases",
                           "Same as Percent Correct but by category",
                           "Total predicted by category, divided by total observed by category",
                           "Total hits divided by total hits + false alarms + misses",
                           "Proportion of no events forecast as yes; sensitive to false alarms but ignores misses",
                           "Total hits divided by total observed by class",
                           "Total false alarms divided by total forecast yes by class; measures fraction of predicted yes that did not occur",
                           "Fraction of correct predictions after removing predictions attributable to chance; measures fractional improvement over random; tends to reward conservative forecasts",
                           "Combines $POD$ and $F$; measures ability to separate yes events from no events; tends to reward conservative forecasts",
                           "Measures accuracy of predicting the correct category, relative to random; tends to reward correct forecasts of less likely category"),
           Notes = c("Strongly influenced by most common category",
                     "Strongly influenced by most common category",
                     "$B>1$: class is overpredicted; $B<1$: class is underpredicted",
                     "$CSI = 1$: perfect score; $CSI = 0$: no skill",
                     "$F = 0$: perfect score",
                     "$POD = 1$: perfect score",
                     "$FAR = 0$: perfect score",
                     "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better",
                     "$PSS = 1$: perfect score; $PSS = 0$: no skill",
                     "$GS = 1$: perfect score; $GS = 0$: no skill")) %>%
  kable(booktabs = TRUE,
        escape = FALSE,
        caption = "\\label{tab:verification-statistics}Verification statistics") %>% 
  kable_styling(font_size = 7, latex_options =  c("striped", "scale_down")) %>%
  column_spec(2:3, width = "30em") %>%
  landscape()
```

### Nowcasting: verification statistics

At first glance, the results of the verification statistics (Table \ref{tab:nowcast-outcomes-assessment}) make it clear that no model under comparison is consistently a top performer from every aspect of prediction. Recalling Box's aphorism, all models are wrong but some are useful - in this case it just so happens that some models are more wrong than others in subtly different ways. That said, it is noticeable that the worst scores across the board tend to accrue to Model 1 in its full sample and ensemble versions. On the other hand, Model 2 (full sample) concentrates most of the best scores and second best scores of all the models, but also some of the worst scores for Fatality. Model 4, in contrast, has most of the second best scores and a few top scores, but not a single worst score.

Of all the models, Model 2 (full sample) performs best in terms of Percent Correct, followed by Model 4 (full sample). The worst performer from this perspective is Model 1 (full sample), with a $PC$ score several percentage points below the top models. The second score is Percent Correct by Class ($PC_c$). This score is calculated individually for each outcome class. Model 2 (full sample), has the best performance for outcomes No Injury and Injury, and the second best score for Fatality. Model 4 (full sample) has the best score for Fatality, and is second best for No Injury and Injury. Model 1 (full sample) has worst scores for No Injury and Injury whereas its ensemble version has the worst score for Fatality. It is important to note that $PC$ and $PC_c$ are heavily influenced by the most common category, something that can be particularly appreciated in the scores for Fatality. The scores for this class of outcome are generally high, despite the fact that the number of hits are relatively low; the high values of $PC_c$ in this case are due to the high occurrence of correct non-events elsewhere in the table. 

The models with the best performance in terms of $B$ are Model 1 (full sample) for No Injury and Injury, and Model 3 (ensemble) for Fatality. Model 4 (full sample) is the second best performer for No Injury and Injury, and Model 4 (ensemble) is second best performer for Fatality. Model 1 (ensemble) has the worst bias for No Injury and Injury, whereas Model 2 (full sample) has the worst bias for Fatality.

No model performs uniformly best from the perspective of Critical Success Index ($CSI$). Model 2 (full sample) has the best $CSI$ for No Injury, Model 2 (ensemble) has the best score for Injury, and Model 4 (ensemble) the best score for Fatality. On the other hand, Model 1 (ensemble) has the worst score for No Injury, Model 1 (full sample) the worst score for Injury, and Model 2 the worst score for Fatality. These scores indicates that the models are not particularly skilled at predicting the corresponding classes correctly, given the frequency with which they give false alarms or miss the class.

The lowest probability of false detection $F$ in the case of No Injury is 19.17% for Model 2 (ensemble), with every other model having values lower than 21%,  with the exception of Model 1 (full sample) that has a score of 26.46%. With respect to Injury, the lowest probabilities range 35.8% and 35.29% and 35.35% for Models 4 (full sample) and 2 (full sample). In contrast, the highest probability of false detection for Injury is 45.12% for Model 1 (ensemble). The scores for $F$ for Fatality are all extremely low as a consequence of the very low frequency of this class of outcome in the sample.

As with some other verification statistics, no model is consistently a best performer in terms of $POD$. Model 4 (full sample) has the highest probability of detection for No Injury (65.38%), followed by Model 2 (65.32%), whereas the worst probability of detection is by Model 1 (ensemble) with a score of 55.54%. In terms of Injury, all models have $POD$ higher than 79%, and the highest score is 80.67% for Model 2 (ensemble). The exception is Model 1 (full sample), which has a considerably lower $POD$ of Injury with a score of 73.36%. Lastly, in terms of Fatalities, all models have very low probabilities of detection, ranging from a high of 4.94% in the case of Model 4 (ensemble) to a worst score of 0.11% in the case of Model 2 (full sample). 

Model 2 (full sample) has the best $FAR$ statistic for No Injury, as only 25.05% of predictions for this class are false alarms. The next best score is by Model 4 (full sample), with only 25.23% of No Injury predictions being false alarms. The worst performance in this class is by Model 1 (ensemble), which produces almost a third of false alarms in its predictions of No Injury. In the case of Injury, the False Alarm Ratio ranges from a low of 29.15% by Model (ensemble), with every other model having scores lower than 30% except Model 1 (full sample), that gives almost 32% of false alarms. In terms of Fatality, the lowest $FAR$ is also for Model 4 (ensemble) with only 17.86% of false alarms, whereas the worst performance is by Model 2 (full sample), which produces over 95% of false alarms.

The skill scores help to remove some of the ambiguity regarding the overall performance of a model. In this way, we know that Model 2 (full sample) does not do particularly well with the class Fatality - however, of all models, it tends to have the best overall performance. Its $HSS$, for example, suggests that it achieves 44.74% of correct predictions after removing correct predictions attributable to chance. In contrast, the lowest score is for Model 1 (ensemble), which only achieves 36.26% correct predictions after removing those attributable to chance. Model 2 (full sample) also has the highest $PSS$ and the second highest $GS$. Model 4 (full sample) has the highest $GS$ and the second highest $HSS$ and $PSS$.

```{r nowcast-classes-model-1, include=FALSE, cache=TRUE}
# Nowcast the outcomes
P_ISEV_mod1 <- data.frame(P_ISEV_mod = predict(mod1, newdata = nowcast_data.df, type = "class"),
                          P_ISEV = nowcast_data.df$P_ISEV,
                          P1_USER = nowcast_data.df$P1_USER,
                          xLD = nowcast_data.df$xLD,
                          xLT = nowcast_data.df$xLT,
                          xHV = nowcast_data.df$xHV,
                          Model = "Model 1") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-1-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod1_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "class"),
                predict(mod1_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "class"),
                predict(mod1_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "class"),
                predict(mod1_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "class"),
                predict(mod1_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "class"),
                predict(mod1_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "class"),
                predict(mod1_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1, 
                                                                         C_RCFG != "Freeway Express Lane",
                                                                         C_RCFG != "Traffic circle",
                                                                         C_RSUR != "Muddy",
                                                                         C_RSUR != "Sand/Gravel/Dirt",
                                                                         C_WTHR != "Other",
                                                                         C_TRAF != "Warning sign",
                                                                         C_TRAF != "No passing zone sign",
                                                                         C_TRAF != "Markings on the road") %>% 
                          droplevels(), type = "class"),
                predict(mod1_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1), type = "class"),
                predict(mod1_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "class"),
                predict(mod1_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                predict(mod1_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                predict(mod1_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                predict(mod1_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                predict(mod1_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                                P1_SAFE != "Other",
                                                                                C_CONF != "Hit a stationary object",
                                                                                C_CONF != "Ran off left shoulder",
                                                                                C_CONF != "Ran off right shoulder",
                                                                                C_CONF != "Approaching side-swipe",
                                                                                C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                                                C_CONF != "Head-on collision",
                                                                                C_CONF != "Right turn, including turning conflicts",
                                                                                C_RCFG != "Bridge/Overpass/Viaduct",
                                                                                C_RCFG != "Unknown",
                                                                                C_TRAF != "Other",
                                                                                C_TRAF != "School guard") %>% 
                          droplevels(), type = "class"),
                #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod1_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                predict(mod1_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                predict(mod1_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                                                   P1_SAFE != "Safety Device",
                                                                                   C_CONF != "Unknown",
                                                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                                                   C_TRAF != "Markings on the road",
                                                                                   C_TRAF != "School guard",
                                                                                   C_WTHR != "Raining") %>% 
                          droplevels(), type = "class"))
P_ISEV_mod1_ensemble <- data.frame(P_ISEV_mod,
                                   rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLD == 1, 
                                                                    C_RCFG != "Freeway Express Lane",
                                                                    C_RCFG != "Traffic circle",
                                                                    C_RSUR != "Muddy",
                                                                    C_RSUR != "Sand/Gravel/Dirt",
                                                                    C_WTHR != "Other",
                                                                    C_TRAF != "Warning sign",
                                                                    C_TRAF != "No passing zone sign",
                                                                    C_TRAF != "Markings on the road") %>% 
                                           droplevels() %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                    P1_SAFE != "Other",
                                                                    C_CONF != "Hit a stationary object",
                                                                    C_CONF != "Ran off left shoulder",
                                                                    C_CONF != "Ran off right shoulder",
                                                                    C_CONF != "Approaching side-swipe",
                                                                    C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                                    C_CONF != "Head-on collision",
                                                                    C_CONF != "Right turn, including turning conflicts",
                                                                    C_RCFG != "Bridge/Overpass/Viaduct",
                                                                    C_RCFG != "Unknown",
                                                                    C_TRAF != "Other",
                                                                    C_TRAF != "School guard") %>% 
                                           droplevels() %>%
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                                    P1_SAFE != "Safety Device",
                                                                    C_CONF != "Unknown",
                                                                    C_RCFG != "Bridge/Overpass/Viaduct",
                                                                    C_TRAF != "Markings on the road",
                                                                    C_TRAF != "School guard",
                                                                    C_WTHR != "Raining") %>% 
                                           droplevels() %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 1 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-2, include=FALSE, cache=TRUE}
P_ISEV_mod2 = data.frame(P_ISEV_mod = predict(mod2, newdata = nowcast_data.df, type = "class"),
                         P_ISEV = nowcast_data.df$P_ISEV,
                         P1_USER = nowcast_data.df$P1_USER,
                         xLD = nowcast_data.df$xLD,
                         xLT = nowcast_data.df$xLT,
                         xHV = nowcast_data.df$xHV,
                         Model = "Model 2") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-2-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod2_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "class"),
                predict(mod2_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "class"),
                predict(mod2_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "class"),
                predict(mod2_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "class"),
                predict(mod2_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "class"),
                predict(mod2_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "class"),
                predict(mod2_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1,
                                                                         C_RCFG != "Traffic circle",
                                                                         C_RCFG != "Freeway Express Lane",
                                                                         C_WTHR != "Other",
                                                                         C_RSUR != "Sand/Gravel/Dirt",
                                                                         C_TRAF != "Markings on the road",
                                                                         C_TRAF != "Markings on the road",
                                                                         C_TRAF != "Warning sign") %>% 
                          droplevels(), type = "class"),
                predict(mod2_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1,
                                                                         C_CONF != "Ran off right shoulder") %>% 
                          droplevels(), type = "class"),
                predict(mod2_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "class"),
                predict(mod2_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                predict(mod2_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                predict(mod2_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                predict(mod2_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                predict(mod2_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                                P1_SAFE != "Other") %>% 
                          droplevels(), type = "class"),
                #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod2_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                predict(mod2_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), type = "class"),
                predict(mod2_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1,
                                                                                   P1_SAFE != "Safety Device",
                                                                                   P1_SAFE != "Other",
                                                                                   C_CONF != "Approaching side-swipe",
                                                                                   C_CONF != "Unknown",
                                                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                                                   C_RALN != "Top of hill or gradient",
                                                                                   C_TRAF != "Markings on the road") %>% 
                          droplevels(), type = "class"))

P_ISEV_mod2_ensemble <-  data.frame(P_ISEV_mod = P_ISEV_mod,
                                    rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxLD == 1,
                                                                     C_RCFG != "Traffic circle",
                                                                     C_RCFG != "Freeway Express Lane",
                                                                     C_WTHR != "Other",
                                                                     C_RSUR != "Sand/Gravel/Dirt",
                                                                     C_TRAF != "Markings on the road",
                                                                     C_TRAF != "Markings on the road",
                                                                     C_TRAF != "Warning sign") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxLT == 1,
                                                                     C_CONF != "Ran off right shoulder") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                     P1_SAFE != "Other") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1,
                                                                     P1_SAFE != "Safety Device",
                                                                     P1_SAFE != "Other",
                                                                     C_CONF != "Approaching side-swipe",
                                                                     C_CONF != "Unknown",
                                                                     C_RCFG != "Bridge/Overpass/Viaduct",
                                                                     C_RALN != "Top of hill or gradient",
                                                                     C_TRAF != "Markings on the road") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 2 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-3, include=FALSE, cache=TRUE}
P_ISEV_mod3 <- data.frame(P_ISEV_mod = predict(mod3, newdata = nowcast_data.df, type = "class"),
                          P_ISEV = nowcast_data.df$P_ISEV,
                          P1_USER = nowcast_data.df$P1_USER,
                          xLD = nowcast_data.df$xLD,
                          xLT = nowcast_data.df$xLT,
                          xHV = nowcast_data.df$xHV,
                          Model = "Model 3") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-3-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod3_LDxLD, 
                        newdata = nowcast_data.df %>% 
                          filter(LDxLD == 1), 
                        type = "class"),
                predict(mod3_LDxLT, 
                        newdata = nowcast_data.df %>% 
                          filter(LDxLT == 1), 
                        type = "class"),
                predict(mod3_LDxHV, 
                        newdata = nowcast_data.df %>% 
                          filter(LDxHV == 1), 
                        type = "class"),
                predict(mod3_LTxLD, 
                        newdata = nowcast_data.df %>% 
                          filter(LTxLD == 1), 
                        type = "class"),
                predict(mod3_LTxLT, 
                        newdata = nowcast_data.df %>% 
                          filter(LTxLT == 1), 
                        type = "class"),
                predict(mod3_LTxHV, 
                        newdata = nowcast_data.df %>% 
                          filter(LTxHV == 1), 
                        type = "class"),
                predict(mod3_HVxLD, 
                        newdata = nowcast_data.df %>% 
                          filter(HVxLD == 1,
                                 C_RCFG != "Traffic circle",
                                 C_RCFG != "Freeway Express Lane",
                                 C_WTHR != "Other",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "Warning sign") %>% 
                          droplevels(), 
                        type = "class"),
                predict(mod3_HVxLT, 
                        newdata = nowcast_data.df %>% 
                          filter(HVxLT == 1,
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Ran off right shoulder"), 
                        type = "class"),
                predict(mod3_HVxHV, 
                        newdata = nowcast_data.df %>% 
                          filter(HVxHV == 1), 
                        type = "class"),
                predict(mod3_PEDESTRIANxLD, 
                        newdata = nowcast_data.df %>% 
                          filter(PEDESTRIANxLD == 1), 
                        type = "class"),
                predict(mod3_PEDESTRIANxLT, 
                        newdata = nowcast_data.df %>% 
                          filter(PEDESTRIANxLT == 1), 
                        type = "class"),
                predict(mod3_PEDESTRIANxHV, 
                        newdata = nowcast_data.df %>% 
                          filter(PEDESTRIANxHV == 1), 
                        type = "class"),
                predict(mod3_BICYCLISTxLD, 
                        newdata = nowcast_data.df %>% 
                          filter(BICYCLISTxLD == 1), 
                        type = "class"),
                predict(mod3_BICYCLISTxLT, 
                        newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                             P1_SAFE != "Other") %>% 
                          droplevels(), 
                        type = "class"),
                #predict(mod3_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod3_MOTORCYCLISTxLD, 
                        newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), 
                        type = "class"),
                predict(mod3_MOTORCYCLISTxLT, 
                        newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1), 
                        type = "class"),
                predict(mod3_MOTORCYCLISTxHV, 
                        newdata = nowcast_data.df %>% 
                          filter(MOTORCYCLISTxHV == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Approaching side-swipe",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "School guard",
                                 C_TRAF != "Markings on the road") %>% 
                          droplevels(), 
                        type = "class")) 

P_ISEV_mod3_ensemble <-  data.frame(P_ISEV_mod,
                                    rbind(nowcast_data.df %>% 
                                            filter(LDxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(LDxLT == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(LDxHV == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(LTxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(LTxLT == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(LTxHV == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(HVxLD == 1,
                                                   C_RCFG != "Traffic circle",
                                                   C_RCFG != "Freeway Express Lane",
                                                   C_WTHR != "Other",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_TRAF != "No passing zone sign",
                                                   C_TRAF != "Markings on the road",
                                                   C_TRAF != "Warning sign") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(HVxLT == 1,
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Ran off right shoulder") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(HVxHV == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(PEDESTRIANxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(PEDESTRIANxLT == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(PEDESTRIANxHV == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(BICYCLISTxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                     P1_SAFE != "Other") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(MOTORCYCLISTxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(MOTORCYCLISTxLT == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% 
                                            filter(MOTORCYCLISTxHV == 1,
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Approaching side-swipe",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_TRAF != "School guard",
                                                   C_TRAF != "Markings on the road") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 3 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-4, include=FALSE, cache=TRUE}
P_ISEV_mod4 <- data.frame(P_ISEV_mod = predict(mod4, newdata = nowcast_data.df, type = "class"),
                          P_ISEV = nowcast_data.df$P_ISEV,
                          P1_USER = nowcast_data.df$P1_USER,
                          xLD = nowcast_data.df$xLD,
                          xLT = nowcast_data.df$xLT,
                          xHV = nowcast_data.df$xHV,
                          Model = "Model 4") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-model-4-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod4_LDxLD, newdata = nowcast_data.df %>% filter(LDxLD == 1), type = "class"),
                predict(mod4_LDxLT, newdata = nowcast_data.df %>% filter(LDxLT == 1), type = "class"),
                predict(mod4_LDxHV, newdata = nowcast_data.df %>% filter(LDxHV == 1), type = "class"),
                predict(mod4_LTxLD, newdata = nowcast_data.df %>% filter(LTxLD == 1), type = "class"),
                predict(mod4_LTxLT, newdata = nowcast_data.df %>% filter(LTxLT == 1), type = "class"),
                predict(mod4_LTxHV, newdata = nowcast_data.df %>% filter(LTxHV == 1), type = "class"),
                predict(mod4_HVxLD, newdata = nowcast_data.df %>% filter(HVxLD == 1,
                                                                         C_RCFG != "Traffic circle",
                                                                         C_RCFG != "Freeway Express Lane",
                                                                         C_WTHR != "Other",
                                                                         C_RSUR != "Sand/Gravel/Dirt",
                                                                         C_TRAF != "No passing zone sign",
                                                                         C_TRAF != "Warning sign") %>% 
                          droplevels(), type = "class"),
                predict(mod4_HVxLT, newdata = nowcast_data.df %>% filter(HVxLT == 1,
                                                                         C_CONF != "Ran off right shoulder",
                                                                         C_CONF != "Other Single Vehicle",
                                                                         C_CONF != "Side swipe") %>% 
                          droplevels(), type = "class"),
                predict(mod4_HVxHV, newdata = nowcast_data.df %>% filter(HVxHV == 1), type = "class"),
                predict(mod4_PEDESTRIANxLD, newdata = nowcast_data.df %>% filter(PEDESTRIANxLD == 1), type = "class"),
                predict(mod4_PEDESTRIANxLT, newdata = nowcast_data.df %>% filter(PEDESTRIANxLT == 1), type = "class"),
                predict(mod4_PEDESTRIANxHV, newdata = nowcast_data.df %>% filter(PEDESTRIANxHV == 1), type = "class"),
                predict(mod4_BICYCLISTxLD, newdata = nowcast_data.df %>% filter(BICYCLISTxLD == 1), type = "class"),
                predict(mod4_BICYCLISTxLT, newdata = nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                                P1_SAFE != "Other",
                                                                                C_CONF != "Ran off left shoulder",
                                                                                C_CONF != "Ran off right shoulder",
                                                                                C_WTHR != "Visibility limitation") %>% 
                          droplevels(), type = "class"),
                #predict(mod1_BICYCLISTxHV, newdata = nowcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod4_MOTORCYCLISTxLD, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1), type = "class"),
                predict(mod4_MOTORCYCLISTxLT, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1,
                                                                                   P1_SAFE != "Vehicle not Equiped",
                                                                                   P1_SAFE != "Other",
                                                                                   C_CONF != "Ran off right shoulder",
                                                                                   C_CONF != "Right turn, including turning conflicts",
                                                                                   C_CONF != "Other Single Vehicle",
                                                                                   C_CONF != "Side swipe",
                                                                                   C_RCFG != "Ramp",
                                                                                   C_RCFG != "Unknown",
                                                                                   C_RCFG != "Other",
                                                                                   C_TRAF != "Yield sign") %>% 
                          droplevels(), type = "class"),
                predict(mod4_MOTORCYCLISTxHV, newdata = nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                                                   P1_SAFE != "Safety Device",
                                                                                   C_CONF != "Approaching side-swipe",
                                                                                   C_RCFG != "Bridge/Overpass/Viaduct") %>% 
                          droplevels(), type = "class"))
P_ISEV_mod4_ensemble <-  data.frame(P_ISEV_mod,
                                    rbind(nowcast_data.df %>% filter(LDxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LDxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LDxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(LTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxLD == 1,
                                                                     C_RCFG != "Traffic circle",
                                                                     C_RCFG != "Freeway Express Lane",
                                                                     C_WTHR != "Other",
                                                                     C_RSUR != "Sand/Gravel/Dirt",
                                                                     C_TRAF != "No passing zone sign",
                                                                     C_TRAF != "Warning sign") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxLT == 1,
                                                                     C_CONF != "Ran off right shoulder",
                                                                     C_CONF != "Other Single Vehicle",
                                                                     C_CONF != "Side swipe") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(HVxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxLT == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(PEDESTRIANxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(BICYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                     P1_SAFE != "Other",
                                                                     C_CONF != "Ran off left shoulder",
                                                                     C_CONF != "Ran off right shoulder",
                                                                     C_WTHR != "Visibility limitation") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #nowcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxLD == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxLT == 1,
                                                                     P1_SAFE != "Vehicle not Equiped",
                                                                     P1_SAFE != "Other",
                                                                     C_CONF != "Ran off right shoulder",
                                                                     C_CONF != "Right turn, including turning conflicts",
                                                                     C_CONF != "Other Single Vehicle",
                                                                     C_CONF != "Side swipe",
                                                                     C_RCFG != "Ramp",
                                                                     C_RCFG != "Unknown",
                                                                     C_RCFG != "Other",
                                                                     C_TRAF != "Yield sign") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          nowcast_data.df %>% filter(MOTORCYCLISTxHV == 1, 
                                                                     P1_SAFE != "Safety Device",
                                                                     C_CONF != "Approaching side-swipe",
                                                                     C_RCFG != "Bridge/Overpass/Viaduct") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 4 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r nowcast-classes-collect-results, include=FALSE}
nowcast.preds <- rbind(P_ISEV_mod1,
                       P_ISEV_mod2,
                       P_ISEV_mod3,
                       P_ISEV_mod4,
                       P_ISEV_mod1_ensemble,
                       P_ISEV_mod2_ensemble,
                       P_ISEV_mod3_ensemble,
                       P_ISEV_mod4_ensemble) %>%
  mutate(Model = factor(Model,
                        levels = c("Model 1", "Model 2", "Model 3", "Model 4", 
                                   "Model 1 Ensemble", "Model 2 Ensemble", "Model 3 Ensemble", "Model 4 Ensemble"),
                        labels = c("Model 1", "Model 2", "Model 3", "Model 4", 
                                   "Model 1 Ensemble", "Model 2 Ensemble", "Model 3 Ensemble", "Model 4 Ensemble")))
```

```{r nowcast-outcomes-assessment, echo=FALSE, cache=TRUE}
nowcast_verification <- rbind(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")),
                              xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble"))) %>%
  data.frame(pc = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc * 100 + 0.01, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$pc * 100, 3)),
             pc2 = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$pc2 * 100),
             bias = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$bias),
             ts = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$ts),
             f = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$f),
             h = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$h),
             FAR = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$false.alarm.ratio),
             hss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$hss, 3)),
             pss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$pss, 3)),
             gs = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 1 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 2 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 3 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = nowcast.preds %>% filter(Model == "Model 4 Ensemble")))$gs, 3))) %>%
  rownames_to_column() %>%
  remove_rownames() %>%
  rename(Outcome = rowname) %>%
  mutate(Outcome = rep(c("No Injury", "Injury", "Fatality"), 8) %>% 
           factor(levels = c("No Injury", "Injury", "Fatality"),
                  labels = c("No Injury", "Injury", "Fatality"),
                  ordered = TRUE))


# Find best, second best, worst scores for all the verification statistics

# First, set the following option so that summarize does not round by significant digits in the next few lines of code
options(pillar.sigfig = 10)

# Find the scores for percentage correct (pc)
max_pc <- nowcast_verification %>% arrange(pc) %>% slice(24) %>% select(pc)
second_pc <- nowcast_verification %>% arrange(pc) %>% slice(21) %>% select(pc)
min_pc <- nowcast_verification %>% arrange(pc) %>% slice(1) %>% select(pc)

# Find the scores for percentage correct by class (pc2)
max_pc2 <- nowcast_verification %>% arrange(Outcome, pc2) %>% slice(c(8, 16, 24)) %>% select(pc2)
second_pc2 <- nowcast_verification %>% arrange(Outcome, pc2) %>% slice(c(7, 15, 23)) %>% select(pc2)
min_pc2 <- nowcast_verification %>% arrange(Outcome, pc2) %>% slice(c(1, 9, 17)) %>% select(pc2)

# Find the scores for bias (bias)
max_bias <- nowcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(8, 16, 24)) %>% select(bias)
second_bias <- nowcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(2, 10, 18)) %>% select(bias)
min_bias <- nowcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(1, 9, 17)) %>% select(bias)

# Find the scores for critical success index (ts)
max_ts <- nowcast_verification %>% arrange(Outcome, ts) %>% slice(c(8, 16, 24)) %>% select(ts)
second_ts <- nowcast_verification %>% arrange(Outcome, ts) %>% slice(c(7, 15, 23)) %>% select(ts)
min_ts <- nowcast_verification %>% arrange(Outcome, ts) %>% slice(c(1, 9, 17)) %>% select(ts)

# Find the scores for probability of false detection (f)
max_f <- nowcast_verification %>% arrange(Outcome, f) %>% slice(c(8, 16, 24)) %>% select(f)
second_f <- nowcast_verification %>% arrange(Outcome, f) %>% slice(c(2, 10, 18)) %>% select(f)
min_f <- nowcast_verification %>% arrange(Outcome, f) %>% slice(c(1, 9, 17)) %>% select(f)

# Find the scores for probability of detection (h)
max_h <- nowcast_verification %>% arrange(Outcome, h) %>% slice(c(8, 16, 24)) %>% select(h)
second_h <- nowcast_verification %>% arrange(Outcome, h) %>% slice(c(7, 15, 23)) %>% select(h)
min_h <- nowcast_verification %>% arrange(Outcome, h) %>% slice(c(1, 9, 17)) %>% select(h)

# Find the scores for false alarm ratio (FAR)
max_FAR <- nowcast_verification %>% arrange(Outcome, FAR) %>% slice(c(8, 16, 24)) %>% select(FAR)
second_FAR <- nowcast_verification %>% arrange(Outcome, FAR) %>% slice(c(2, 10, 18)) %>% select(FAR)
min_FAR <- nowcast_verification %>% arrange(Outcome, FAR) %>% slice(c(1, 9, 17)) %>% select(FAR)

# Find the scores for Heidke skill score (hss)
max_hss <- nowcast_verification %>% arrange(hss) %>% slice(24) %>% select(hss)
second_hss <- nowcast_verification %>% arrange(hss) %>% slice(21) %>% select(hss)
min_hss <- nowcast_verification %>% arrange(hss) %>% slice(1) %>% select(hss)

# Find the scores for Peirce skill score (pss)
max_pss <- nowcast_verification %>% arrange(pss) %>% slice(24) %>% select(pss)
second_pss <- nowcast_verification %>% arrange(pss) %>% slice(21) %>% select(pss)
min_pss <- nowcast_verification %>% arrange(pss) %>% slice(1) %>% select(pss)

# Find the scores for Gerrity score (gs)
max_gs <- nowcast_verification %>% arrange(gs) %>% slice(24) %>% select(gs)
second_gs <- nowcast_verification %>% arrange(gs) %>% slice(21) %>% select(gs)
min_gs <- nowcast_verification %>% arrange(gs) %>% slice(1) %>% select(gs)

nowcast_verification %>%
  mutate(pc = cell_spec(round(pc, digits = 2),
                        "latex", 
                        bold = ifelse(pc == max_pc[1,1], TRUE, FALSE),
                        underline = ifelse(pc == second_pc[1,1], TRUE, FALSE),
                        color = ifelse(pc == min_pc[1,1], "red", "black")),
         pc2 = cell_spec(round(pc2, digits = 2),
                         "latex",
                         bold = ifelse(pc2 %in% max_pc2[,1], TRUE, FALSE),
                         underline = ifelse(pc2 %in% second_pc2[,1], TRUE, FALSE),
                         color = ifelse(pc2 %in% min_pc2[,1], "red", "black")),
         bias = cell_spec(round(bias, digits = 4),
                          "latex",
                          bold = ifelse(bias %in% min_bias[,1], TRUE, FALSE),
                          underline = ifelse(bias %in% second_bias[,1], TRUE, FALSE),
                          color = ifelse(bias %in% max_bias[,1], "red", "black")),
         ts = cell_spec(round(ts, digits = 4),
                        "latex",
                        bold = ifelse(ts %in% max_ts[,1], TRUE, FALSE),
                        underline = ifelse(ts %in% second_ts[,1], TRUE, FALSE),
                        color = ifelse(ts %in% min_ts[,1], "red", "black")),
         f = cell_spec(round(f, digits = 4),
                       "latex",
                       bold = ifelse(f %in% min_f[,1], TRUE, FALSE),
                       underline = ifelse(f %in% second_f[,1], TRUE, FALSE),
                       color = ifelse(f %in% max_f[,1], "red", "black")),
         h = cell_spec(round(h, digits = 4),
                       "latex",
                       bold = ifelse(h %in% max_h[,1], TRUE, FALSE),
                       underline = ifelse(h %in% second_h[,1], TRUE, FALSE),
                       color = ifelse(h %in% min_h[,1], "red", "black")),
         FAR = cell_spec(round(FAR, digits = 4),
                         "latex",
                         bold = ifelse(FAR %in% min_FAR[,1], TRUE, FALSE),
                         underline = ifelse(FAR %in% second_FAR[,1], TRUE, FALSE),
                         color = ifelse(FAR %in% max_FAR[,1], "red", "black")),
         hss = cell_spec(round(hss, digits = 4),
                         "latex", 
                         bold = ifelse(hss == max_hss[1,1], TRUE, FALSE),
                         underline = ifelse(hss == second_hss[1,1], TRUE, FALSE),
                         color = ifelse(hss == min_hss[1,1], "red", "black")),
         pss = cell_spec(round(pss, digits = 4),
                         "latex", 
                         bold = ifelse(pss == max_pss[1,1], TRUE, FALSE),
                         underline = ifelse(pss == second_pss[1,1], TRUE, FALSE),
                         color = ifelse(pss == min_pss[1,1], "red", "black")),
         gs = cell_spec(round(gs, digits = 4),
                        "latex", 
                        bold = ifelse(gs == max_gs[1,1], TRUE, FALSE),
                        underline = ifelse(gs == second_gs[1,1], TRUE, FALSE),
                        color = ifelse(gs == min_gs[1,1], "red", "black"))) %>%
  kable(digits = 4,
        booktabs = TRUE,
        escape = FALSE,
        col.names = linebreak(c("Outcome",
                                "No Injury",
                                "Injury",
                                "Fatality",
                                "Percent\nCorrect",
                                "Percent\nCorrect\nby Class",
                                "Bias$^1$",
                                "Critical\nSuccess\nIndex$^2$",
                                "Probability of\nFalse\nDetection$^3$",
                                "Probability\nof\nDetection$^4$",
                                "False\nAlarm\nRatio$^5$",
                                "Heidke\nSkill\nScore$^6$",
                                "Peirce\nSkill\nScore$^7$",
                                "Gerrity\nScore$^8$")),
        caption = "\\label{tab:nowcast-outcomes-assessment}Assessment of in-sample outcomes (nowcasting using 2017 data set, i.e., estimation data set)") %>%
  add_header_above(c("Predicted" = 1, "Observed Outcome" = 3, "Verification Statistics" = 10)) %>%
  collapse_rows(columns = c(5, 12:14), latex_hline = "major", valign = "middle") %>%
  pack_rows("Model 1. Single-level/No opponent", 1, 3) %>% 
  pack_rows("Model 2. Single-level/Opponent attributes", 4, 6) %>%
  pack_rows("Model 3. Hierarchical: Traffic unit", 7, 9) %>%
  pack_rows("Model 4. Hierarchical: Opponent", 10, 12) %>%
  pack_rows("Model 1 Ensemble. Single-level/No opponent", 13, 15) %>%
  pack_rows("Model 2 Ensemble. Single-level/Opponent attributes", 16, 18) %>%
  pack_rows("Model 3 Ensemble. Hierarchical: Traffic unit", 19, 21) %>% 
  pack_rows("Model 4 Ensemble. Hierarchical: Opponent", 22, 24) %>% 
  kable_styling(font_size = 7, latex_options = c("scale_down")) %>%
  footnote(general = "Bold numbers: best scores; underlined numbers: second best scores; red numbers: worst scores",
           number = c("$B>1$: class is overpredicted; $B<1$: class is underpredicted; ",
                      "$CSI = 1$: perfect score; $CSI = 0$: no skill; ",
                      "$F = 0$: perfect score; ",
                      "$POD = 1$: perfect score; ",
                      "$FAR = 0$: perfect score; ",
                      "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better; ",
                      "$PSS = 1$: perfect score; $PSS = 0$: no skill; ",
                      "$GS = 1$: perfect score; $GS = 0$: no skill."),
           escape = FALSE)
```

### Backcasting: verification statistics

Table \ref{tab:backcast-outcomes-assessment} presents the results of the verification exercise for the case of our out-of-sample predictions (i.e., backasting). Qualitatively, the results are similar to those of the nowcasting experiments, but with a somewhat weaker performance of the ensemble models. This, again, supports the idea that these models might be overfitting the process, as discussed in reference to the aggregate forecasts (see Section \ref{sec:outcomes-shares}). Models 2 (full sample) and 4 (full sample) are again identified as the best overall performers, and particularly Model 2 (full sample) performs somewhat more adroitly with respect to Fatality in backcasting than it did in nowcasting.

```{r backcast-classes-model-1, include=FALSE, cache=TRUE}
# Backcast the outcomes
P_ISEV_mod1 <- data.frame(P_ISEV_mod = predict(mod1, newdata = backcast_data.df, type = "class"),
                          P_ISEV = backcast_data.df$P_ISEV,
                          P1_USER = backcast_data.df$P1_USER,
                          xLD = backcast_data.df$xLD,
                          xLT = backcast_data.df$xLT,
                          xHV = backcast_data.df$xHV,
                          Model = "Model 1") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-1-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod1_LDxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLD == 1), 
                        type = "class"),
                predict(mod1_LDxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLT == 1,
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                predict(mod1_LDxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LDxHV == 1,
                                 C_CONF != "Rollover on roadway",
                                 C_RSUR != "Oil",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only"),
                        type = "class"),
                predict(mod1_LTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLD == 1,
                                 P1_SAFE != "Helmet",
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"),
                        type = "class"),
                predict(mod1_LTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLT == 1,
                                 C_WTHR != "Unknown",
                                 C_RALN != "Unknown"),
                        type = "class"),
                predict(mod1_LTxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LTxHV == 1,
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                        type = "class"),
                predict(mod1_HVxLD, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLD == 1, 
                                 C_RCFG != "Freeway Express Lane",
                                 C_RCFG != "Traffic circle",
                                 C_RSUR != "Muddy",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RSUR != "Oil",
                                 C_WTHR != "Other",
                                 C_TRAF != "Warning sign",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only",
                                 C_TRAF != "Control device not specified") %>% 
                          droplevels(), 
                        type = "class"),
                predict(mod1_HVxLT, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLT == 1,
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"),
                        type = "class"),
                predict(mod1_HVxHV, 
                        newdata = backcast_data.df %>% 
                          filter(HVxHV == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Other",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                predict(mod1_PEDESTRIANxLD, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLD == 1,
                                 C_RCFG != "Tunnel/Underpass"),
                        type = "class"),
                predict(mod1_PEDESTRIANxLT, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLT == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Side swipe",
                                 C_WTHR != "Strong wind",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "Flashing Traffic"),
                        type = "class"),
                predict(mod1_PEDESTRIANxHV, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxHV == 1,
                                 C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing",
                                 C_TRAF != "Control device not specified"),
                        type = "class"),
                predict(mod1_BICYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLD == 1,
                                 C_CONF != "Ran off left shoulder",
                                 C_TRAF != "No passing zone sign", 
                                 C_TRAF != "Control device not specified"),
                        type = "class"),
                predict(mod1_BICYCLISTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLT == 1,
                                 P1_SAFE != "Other",
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Hit a stationary object",
                                 C_CONF != "Ran off left shoulder",
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Approaching side-swipe",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_CONF != "Head-on collision",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RCFG != "Unknown",
                                 C_TRAF != "Other",
                                 C_TRAF != "School guard",
                                 C_WTHR != "Unknown",
                                 C_RALN != "Curved and level") %>% 
                          droplevels(), 
                        type = "class"),
                #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod1_MOTORCYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLD == 1,
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_WTHR != "Freezing rain, sleet, hail", 
                                 C_WTHR != "Strong wind"),
                        type = "class"),
                predict(mod1_MOTORCYCLISTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLT == 1,
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_MNTH != "December"), 
                        type = "class"),
                predict(mod1_MOTORCYCLISTxHV, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxHV == 1, 
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Unknown",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RCFG != "Intersection with Entrance",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "School guard",
                                 C_WTHR != "Raining",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_MNTH != "November") %>% 
                          droplevels(), 
                        type = "class"))
P_ISEV_mod1_ensemble <-  data.frame(P_ISEV_mod,
                                    rbind(backcast_data.df %>% 
                                            filter(LDxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LDxLT == 1,
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LDxHV == 1,
                                                   C_CONF != "Rollover on roadway",
                                                   C_RSUR != "Oil",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxLD == 1,
                                                   P1_SAFE != "Helmet",
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxLT == 1,
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Unknown") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxHV == 1,
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxLD == 1, 
                                                   C_RCFG != "Freeway Express Lane",
                                                   C_RCFG != "Traffic circle",
                                                   C_RSUR != "Muddy",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RSUR != "Oil",
                                                   C_WTHR != "Other",
                                                   C_TRAF != "Warning sign",
                                                   C_TRAF != "No passing zone sign",
                                                   C_TRAF != "Markings on the road",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only",
                                                   C_TRAF != "Control device not specified") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxLT == 1,
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxHV == 1,
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_WTHR != "Other",
                                                   C_TRAF != "Flashing Traffic") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLD == 1,
                                                   C_RCFG != "Tunnel/Underpass") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLT == 1,
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Side swipe",
                                                   C_WTHR != "Strong wind",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_TRAF != "Flashing Traffic") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxHV == 1,
                                                   C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing",
                                                   C_TRAF != "Control device not specified") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLD == 1,
                                                   C_CONF != "Ran off left shoulder",
                                                   C_TRAF != "No passing zone sign", 
                                                   C_TRAF != "Control device not specified") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLT == 1,
                                                   P1_SAFE != "Other",
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Hit a stationary object",
                                                   C_CONF != "Ran off left shoulder",
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Approaching side-swipe",
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_CONF != "Head-on collision",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RCFG != "Unknown",
                                                   C_TRAF != "Other",
                                                   C_TRAF != "School guard",
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Curved and level") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLD == 1,
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_WTHR != "Freezing rain, sleet, hail", 
                                                   C_WTHR != "Strong wind") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLT == 1,
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_MNTH != "December") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxHV == 1, 
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Unknown",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RCFG != "Intersection with Entrance",
                                                   C_TRAF != "Markings on the road",
                                                   C_TRAF != "School guard",
                                                   C_WTHR != "Raining",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_MNTH != "November") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 1 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-2, include=FALSE, cache=TRUE}
P_ISEV_mod2 = data.frame(P_ISEV_mod = predict(mod2, newdata = backcast_data.df, type = "class"),
                         P_ISEV = backcast_data.df$P_ISEV,
                         P1_USER = backcast_data.df$P1_USER,
                         xLD = backcast_data.df$xLD,
                         xLT = backcast_data.df$xLT,
                         xHV = backcast_data.df$xHV,
                         Model = "Model 2") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-2-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod2_LDxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLD == 1), 
                        type = "class"),
                predict(mod2_LDxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLT == 1,
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                predict(mod2_LDxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LDxHV == 1,
                                 C_CONF != "Rollover on roadway",
                                 C_RSUR != "Oil",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only"), 
                        type = "class"),
                predict(mod2_LTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLD == 1,
                                 P1_SAFE != "Helmet",
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"),
                        type = "class"),
                predict(mod2_LTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLT == 1,
                                 C_WTHR != "Unknown",
                                 C_RALN != "Unknown"), 
                        type = "class"),
                predict(mod2_LTxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LTxHV == 1,
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"),
                        type = "class"),
                predict(mod2_HVxLD, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLD == 1,
                                 C_RCFG != "Traffic circle",
                                 C_RCFG != "Freeway Express Lane",
                                 C_WTHR != "Other",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RSUR != "Oil",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "Warning sign",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only",
                                 C_TRAF != "Control device not specified") %>% 
                          droplevels(), 
                        type = "class"),
                predict(mod2_HVxLT, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLT == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                          droplevels(), 
                        type = "class"),
                predict(mod2_HVxHV, 
                        newdata = backcast_data.df %>% 
                          filter(HVxHV == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Other",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                predict(mod2_PEDESTRIANxLD, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLD == 1,
                                 C_RCFG != "Tunnel/Underpass"),
                        type = "class"),
                predict(mod2_PEDESTRIANxLT, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLT == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Side swipe",
                                 C_WTHR != "Strong wind",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                predict(mod2_PEDESTRIANxHV, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxHV == 1,
                                 C_CONF != "One vehicle passing to the right of the other, or right turn conflict", 
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing",
                                 C_TRAF != "Control device not specified"), 
                        type = "class"),
                predict(mod2_BICYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLD == 1,
                                 C_CONF != "Ran off left shoulder",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Control device not specified"), 
                        type = "class"),
                predict(mod2_BICYCLISTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLT == 1,
                                 P1_SAFE != "Other",
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_WTHR != "Unknown",
                                 C_RALN != "Curved and level") %>% 
                          droplevels(), 
                        type = "class"),
                #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                predict(mod2_MOTORCYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLD == 1,
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_WTHR != "Freezing rain, sleet, hail",
                                 C_WTHR != "Strong wind"), 
                        type = "class"),
                predict(mod2_MOTORCYCLISTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLT == 1,
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_MNTH != "December"),
                        type = "class"),
                predict(mod2_MOTORCYCLISTxHV, 
                        newdata = backcast_data.df %>% filter(MOTORCYCLISTxHV == 1,
                                                              P1_SAFE != "Safety Device",
                                                              P1_SAFE != "Other",
                                                              C_CONF != "Approaching side-swipe",
                                                              C_CONF != "Unknown",
                                                              C_CONF != "Right turn, including turning conflicts",
                                                              C_RCFG != "Bridge/Overpass/Viaduct",
                                                              C_RCFG != "Intersection with Entrance",
                                                              C_RALN != "Top of hill or gradient",
                                                              C_TRAF != "Markings on the road",
                                                              C_RSUR != "Sand/Gravel/Dirt",
                                                              C_MNTH != "November") %>% 
                          droplevels(), 
                        type = "class"))
P_ISEV_mod2_ensemble <-  data.frame(P_ISEV_mod, 
                                    rbind(backcast_data.df %>% 
                                            filter(LDxLD == 1) %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LDxLT == 1,
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LDxHV == 1,
                                                   C_CONF != "Rollover on roadway",
                                                   C_RSUR != "Oil",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxLD == 1,
                                                   P1_SAFE != "Helmet",
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxLT == 1,
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Unknown") %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(LTxHV == 1,
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxLD == 1,
                                                   C_RCFG != "Traffic circle",
                                                   C_RCFG != "Freeway Express Lane",
                                                   C_WTHR != "Other",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RSUR != "Oil",
                                                   C_TRAF != "Markings on the road",
                                                   C_TRAF != "Markings on the road",
                                                   C_TRAF != "Warning sign",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only",
                                                   C_TRAF != "Control device not specified") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxLT == 1,
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(HVxHV == 1,
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_WTHR != "Other",
                                                   C_TRAF != "Flashing Traffic") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLD == 1,
                                                   C_RCFG != "Tunnel/Underpass") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLT == 1,
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Side swipe",
                                                   C_WTHR != "Strong wind",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_TRAF != "Flashing Traffic") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxHV == 1,
                                                   C_CONF != "One vehicle passing to the right of the other, or right turn conflict", 
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing",
                                                   C_TRAF != "Control device not specified") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLD == 1,
                                                   C_CONF != "Ran off left shoulder",
                                                   C_TRAF != "No passing zone sign",
                                                   C_TRAF != "Control device not specified") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLT == 1,
                                                   P1_SAFE != "Other",
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Curved and level") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLD == 1,
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_WTHR != "Freezing rain, sleet, hail",
                                                   C_WTHR != "Strong wind") %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLT == 1,
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_MNTH != "December") %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxHV == 1,
                                                   P1_SAFE != "Safety Device",
                                                   P1_SAFE != "Other",
                                                   C_CONF != "Approaching side-swipe",
                                                   C_CONF != "Unknown",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RCFG != "Intersection with Entrance",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_TRAF != "Markings on the road",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_MNTH != "November") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 2 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-3, include=FALSE, cache=TRUE}
P_ISEV_mod3 <- data.frame(P_ISEV_mod = predict(mod3, newdata = backcast_data.df, type = "class"),
                          P_ISEV = backcast_data.df$P_ISEV,
                          P1_USER = backcast_data.df$P1_USER,
                          xLD = backcast_data.df$xLD,
                          xLT = backcast_data.df$xLT,
                          xHV = backcast_data.df$xHV,
                          Model = "Model 3") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-3-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod3_LDxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLD == 1), 
                        type = "class"),
                #**********************************#
                predict(mod3_LDxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LDxLT == 1,
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                #**********************************#
                predict(mod3_LDxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LDxHV == 1,
                                 C_CONF != "Rollover on roadway",
                                 C_RSUR != "Oil",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only"), 
                        type = "class"),
                #**********************************#
                predict(mod3_LTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLD == 1,
                                 P1_SAFE != "Helmet",
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                #**********************************#
                predict(mod3_LTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(LTxLT == 1,
                                 C_WTHR != "Unknown",
                                 C_RALN != "Unknown"), 
                        type = "class"),
                #**********************************#
                predict(mod3_LTxHV, 
                        newdata = backcast_data.df %>% 
                          filter(LTxHV == 1,
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                        type = "class"),
                #**********************************#
                predict(mod3_HVxLD, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLD == 1,
                                 C_RCFG != "Traffic circle",
                                 C_RCFG != "Freeway Express Lane",
                                 C_WTHR != "Other",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RSUR != "Oil",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Markings on the road",
                                 C_TRAF != "Warning sign",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only",
                                 C_TRAF != "Control device not specified") %>% 
                          droplevels(), 
                        type = "class"),
                #**********************************#
                predict(mod3_HVxLT, 
                        newdata = backcast_data.df %>% 
                          filter(HVxLT == 1,
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                        type = "class"),
                #**********************************#
                predict(mod3_HVxHV, 
                        newdata = backcast_data.df %>% 
                          filter(HVxHV == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Other",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                #**********************************#
                predict(mod3_PEDESTRIANxLD, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLD == 1,
                                 C_RCFG != "Tunnel/Underpass"), 
                        type = "class"),
                #**********************************#
                predict(mod3_PEDESTRIANxLT, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLT == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Side swipe",
                                 C_WTHR != "Strong wind",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                #**********************************#
                predict(mod3_PEDESTRIANxHV, 
                        newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxHV == 1,
                                 C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing",
                                 C_TRAF != "Control device not specified"), 
                        type = "class"),
                #**********************************#
                predict(mod3_BICYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLD == 1,
                                 C_CONF != "Ran off left shoulder",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Control device not specified"), 
                        type = "class"),
                #**********************************#
                predict(mod3_BICYCLISTxLT, 
                        newdata = backcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                              P1_SAFE != "Other",
                                                              P1_SAFE != "Safety Device",
                                                              C_CONF != "Other Single Vehicle",
                                                              C_CONF != "Hit a parked motor vehicle",
                                                              C_WTHR != "Unknown",
                                                              C_RALN != "Curved and level") %>% 
                          droplevels(), 
                        type = "class"),
                #**********************************#
                #predict(mod3_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                #**********************************#
                predict(mod3_MOTORCYCLISTxLD, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLD == 1,
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_WTHR != "Freezing rain, sleet, hail",
                                 C_WTHR != "Strong wind"), 
                        type = "class"),
                #**********************************#
                predict(mod3_MOTORCYCLISTxLT, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLT == 1,
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_MNTH != "December"), 
                        type = "class"),
                #**********************************#
                predict(mod3_MOTORCYCLISTxHV, 
                        newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxHV == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Approaching side-swipe",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RCFG != "Intersection with Entrance",
                                 C_RCFG != "Other",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "School guard",
                                 C_TRAF != "Markings on the road",
                                 C_WTHR != "Strong wind",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_MNTH != "November") %>% 
                          droplevels(), 
                        type = "class"))
#********************************#
P_ISEV_mod3_ensemble <- data.frame(P_ISEV_mod,
                                   rbind(backcast_data.df %>% 
                                           filter(LDxLD == 1) %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(LDxLT == 1,
                                                  C_CONF != "Hit a stationary object",
                                                  C_RSUR != "Sand/Gravel/Dirt",
                                                  C_RALN != "Other",
                                                  C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(LDxHV == 1,
                                                  C_CONF != "Rollover on roadway",
                                                  C_RSUR != "Oil",
                                                  C_TRAF != "School crossing",
                                                  C_TRAF != "Railway crossing with signals, or signals and gates",
                                                  C_TRAF != "Railway crossing with signs only") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(LTxLD == 1,
                                                  P1_SAFE != "Helmet",
                                                  C_CONF != "Hit a stationary object",
                                                  C_RSUR != "Sand/Gravel/Dirt",
                                                  C_RALN != "Other",
                                                  C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(LTxLT == 1,
                                                  C_WTHR != "Unknown",
                                                  C_RALN != "Unknown") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(LTxHV == 1,
                                                  C_CONF != "Hit a parked motor vehicle",
                                                  C_RSUR != "Other",
                                                  C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(HVxLD == 1,
                                                  C_RCFG != "Traffic circle",
                                                  C_RCFG != "Freeway Express Lane",
                                                  C_WTHR != "Other",
                                                  C_RSUR != "Sand/Gravel/Dirt",
                                                  C_RSUR != "Oil",
                                                  C_TRAF != "No passing zone sign",
                                                  C_TRAF != "Markings on the road",
                                                  C_TRAF != "Warning sign",
                                                  C_TRAF != "School crossing",
                                                  C_TRAF != "Railway crossing with signals, or signals and gates",
                                                  C_TRAF != "Railway crossing with signs only",
                                                  C_TRAF != "Control device not specified") %>% 
                                           droplevels() %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(HVxLT == 1,
                                                  C_CONF != "Other Single Vehicle",
                                                  C_CONF != "Ran off right shoulder",
                                                  C_CONF != "Hit a parked motor vehicle",
                                                  C_RCFG != "Bridge/Overpass/Viaduct",
                                                  C_RSUR != "Other",
                                                  C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(HVxHV == 1,
                                                  C_CONF != "Ran off right shoulder",
                                                  C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                  C_WTHR != "Other",
                                                  C_TRAF != "Flashing Traffic") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(PEDESTRIANxLD == 1,
                                                  C_RCFG != "Tunnel/Underpass") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(PEDESTRIANxLT == 1,
                                                  P1_SAFE != "Safety Device",
                                                  C_CONF != "Side swipe",
                                                  C_WTHR != "Strong wind",
                                                  C_RALN != "Top of hill or gradient",
                                                  C_TRAF != "Flashing Traffic") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(PEDESTRIANxHV == 1,
                                                  C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                                  C_CONF != "Right turn, including turning conflicts",
                                                  C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                                  C_TRAF != "School bus stopped with school bus signal lights flashing",
                                                  C_TRAF != "Control device not specified") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(BICYCLISTxLD == 1,
                                                  C_CONF != "Ran off left shoulder",
                                                  C_TRAF != "No passing zone sign",
                                                  C_TRAF != "Control device not specified") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% filter(BICYCLISTxLT == 1,
                                                                     P1_SAFE != "Other",
                                                                     P1_SAFE != "Safety Device",
                                                                     C_CONF != "Other Single Vehicle",
                                                                     C_CONF != "Hit a parked motor vehicle",
                                                                     C_WTHR != "Unknown",
                                                                     C_RALN != "Curved and level") %>% 
                                           droplevels() %>%
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(MOTORCYCLISTxLD == 1,
                                                  C_WTHR != "Snowing, not including drifting snow",
                                                  C_WTHR != "Freezing rain, sleet, hail",
                                                  C_WTHR != "Strong wind") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(MOTORCYCLISTxLT == 1,
                                                  C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                  C_WTHR != "Snowing, not including drifting snow",
                                                  C_MNTH != "December") %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                         #********************************#
                                         backcast_data.df %>% 
                                           filter(MOTORCYCLISTxHV == 1,
                                                  P1_SAFE != "Safety Device",
                                                  C_CONF != "Approaching side-swipe",
                                                  C_CONF != "Right turn, including turning conflicts",
                                                  C_RCFG != "Bridge/Overpass/Viaduct",
                                                  C_RCFG != "Intersection with Entrance",
                                                  C_RCFG != "Other",
                                                  C_RALN != "Top of hill or gradient",
                                                  C_TRAF != "School guard",
                                                  C_TRAF != "Markings on the road",
                                                  C_WTHR != "Strong wind",
                                                  C_RSUR != "Sand/Gravel/Dirt",
                                                  C_MNTH != "November") %>% 
                                           droplevels() %>% 
                                           dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                   Model = "Model 3 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-4, include=FALSE, cache=TRUE}
P_ISEV_mod4 <- data.frame(P_ISEV_mod = predict(mod4, newdata = backcast_data.df, type = "class"),
                          P_ISEV = backcast_data.df$P_ISEV,
                          P1_USER = backcast_data.df$P1_USER,
                          xLD = backcast_data.df$xLD,
                          xLT = backcast_data.df$xLT,
                          xHV = backcast_data.df$xHV,
                          Model = "Model 4") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("No Injury", "Injury", "Fatality"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-model-4-ensemble, include=FALSE, cache=TRUE}
P_ISEV_mod <- c(predict(mod4_LDxLD, newdata = backcast_data.df %>% 
                          filter(LDxLD == 1), type = "class"),
                #**********************************#
                predict(mod4_LDxLT, newdata = backcast_data.df %>% 
                          filter(LDxLT == 1,
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                #**********************************#
                predict(mod4_LDxHV, newdata = backcast_data.df %>% 
                          filter(LDxHV == 1,
                                 C_CONF != "Rollover on roadway",
                                 C_RSUR != "Oil",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only"),
                        type = "class"),
                #**********************************#
                predict(mod4_LTxLD, newdata = backcast_data.df %>% 
                          filter(LTxLD == 1,
                                 P1_SAFE != "Helmet",
                                 C_CONF != "Hit a stationary object",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RALN != "Other",
                                 C_TRAF != "Railway crossing with signals, or signals and gates"), 
                        type = "class"),
                #**********************************#
                predict(mod4_LTxLT, newdata = backcast_data.df %>% 
                          filter(LTxLT == 1,
                                 C_WTHR != "Unknown",
                                 C_RALN != "Unknown"), 
                        type = "class"),
                #**********************************#
                predict(mod4_LTxHV, newdata = backcast_data.df %>% 
                          filter(LTxHV == 1,
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing"), 
                        type = "class"),
                #**********************************#
                predict(mod4_HVxLD, newdata = backcast_data.df %>% 
                          filter(HVxLD == 1,
                                 C_RCFG != "Traffic circle",
                                 C_RCFG != "Freeway Express Lane",
                                 C_WTHR != "Other",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_RSUR != "Oil",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Warning sign",
                                 C_TRAF != "School crossing",
                                 C_TRAF != "Railway crossing with signals, or signals and gates",
                                 C_TRAF != "Railway crossing with signs only",
                                 C_TRAF != "Control device not specified") %>% 
                          droplevels(), type = "class"),
                #**********************************#
                predict(mod4_HVxLT, newdata = backcast_data.df %>% 
                          filter(HVxLT == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Side swipe",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RSUR != "Other",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                          droplevels(), type = "class"),
                #**********************************#
                predict(mod4_HVxHV, newdata = backcast_data.df %>% 
                          filter(HVxHV == 1,
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_WTHR != "Other",
                                 C_TRAF != "Flashing Traffic"), 
                        type = "class"),
                #**********************************#
                predict(mod4_PEDESTRIANxLD, newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLD == 1,
                                 C_RCFG != "Tunnel/Underpass"), 
                        type = "class"),
                #**********************************#
                predict(mod4_PEDESTRIANxLT, newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxLT == 1,
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Side swipe",
                                 C_WTHR != "Strong wind",
                                 C_RALN != "Top of hill or gradient",
                                 C_TRAF != "Flashing Traffic"),
                        type = "class"),
                #**********************************#
                predict(mod4_PEDESTRIANxHV, newdata = backcast_data.df %>% 
                          filter(PEDESTRIANxHV == 1,
                                 C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                 C_TRAF != "School bus stopped with school bus signal lights flashing",
                                 C_TRAF != "Control device not specified"), 
                        type = "class"),
                #**********************************#
                predict(mod4_BICYCLISTxLD, newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLD == 1,
                                 C_CONF != "Ran off left shoulder",
                                 C_TRAF != "No passing zone sign",
                                 C_TRAF != "Control device not specified"),
                        type = "class"),
                #**********************************#
                predict(mod4_BICYCLISTxLT, newdata = backcast_data.df %>% 
                          filter(BICYCLISTxLT == 1,
                                 P1_SAFE != "Other",
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Ran off left shoulder",
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Hit a parked motor vehicle",
                                 C_WTHR != "Visibility limitation",
                                 C_WTHR != "Unknown",
                                 C_RALN != "Curved and level") %>% 
                          droplevels(), type = "class"),
                #**********************************#
                #predict(mod1_BICYCLISTxHV, newdata = backcast_data.df %>% filter(BICYCLISTxHV == 1), type = "class"),
                #**********************************#
                predict(mod4_MOTORCYCLISTxLD, newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLD == 1,
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_WTHR != "Freezing rain, sleet, hail",
                                 C_WTHR != "Strong wind"),
                        type = "class"),
                #**********************************#
                predict(mod4_MOTORCYCLISTxLT, newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxLT == 1,
                                 P1_SAFE != "Vehicle not Equiped",
                                 P1_SAFE != "Other",
                                 C_CONF != "Ran off right shoulder",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_CONF != "Other Single Vehicle",
                                 C_CONF != "Side swipe",
                                 C_CONF != "Any other two vehicle - same direction of travel configuration",
                                 C_RCFG != "Ramp",
                                 C_RCFG != "Unknown",
                                 C_RCFG != "Other",
                                 C_TRAF != "Yield sign",
                                 C_WTHR != "Snowing, not including drifting snow",
                                 C_RALN != "Top of hill or gradient",
                                 C_MNTH != "December") %>% 
                          droplevels(), type = "class"),
                #**********************************#
                predict(mod4_MOTORCYCLISTxHV, newdata = backcast_data.df %>% 
                          filter(MOTORCYCLISTxHV == 1, 
                                 P1_SAFE != "Safety Device",
                                 C_CONF != "Approaching side-swipe",
                                 C_CONF != "Right turn, including turning conflicts",
                                 C_RCFG != "Bridge/Overpass/Viaduct",
                                 C_RCFG != "Intersection with Entrance",
                                 C_RCFG != "Other",
                                 C_WTHR != "Strong wind",
                                 C_RSUR != "Sand/Gravel/Dirt",
                                 C_MNTH != "November") %>% 
                          droplevels(), type = "class"))

#**********************************#
P_ISEV_mod4_ensemble <-  data.frame(P_ISEV_mod,
                                    rbind(backcast_data.df %>% 
                                            filter(LDxLD == 1) %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(LDxLT == 1,
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(LDxHV == 1,
                                                   C_CONF != "Rollover on roadway",
                                                   C_RSUR != "Oil",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(LTxLD == 1,
                                                   P1_SAFE != "Helmet",
                                                   C_CONF != "Hit a stationary object",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RALN != "Other",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(LTxLT == 1,
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Unknown") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(LTxHV == 1,
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(HVxLD == 1,
                                                   C_RCFG != "Traffic circle",
                                                   C_RCFG != "Freeway Express Lane",
                                                   C_WTHR != "Other",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_RSUR != "Oil",
                                                   C_TRAF != "No passing zone sign",
                                                   C_TRAF != "Warning sign",
                                                   C_TRAF != "School crossing",
                                                   C_TRAF != "Railway crossing with signals, or signals and gates",
                                                   C_TRAF != "Railway crossing with signs only",
                                                   C_TRAF != "Control device not specified") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(HVxLT == 1,
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Side swipe",
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RSUR != "Other",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing") %>% 
                                            droplevels() %>%
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(HVxHV == 1,
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_WTHR != "Other",
                                                   C_TRAF != "Flashing Traffic") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLD == 1,
                                                   C_RCFG != "Tunnel/Underpass") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxLT == 1,
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Side swipe",
                                                   C_WTHR != "Strong wind",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_TRAF != "Flashing Traffic") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(PEDESTRIANxHV == 1,
                                                   C_CONF != "One vehicle passing to the right of the other, or right turn conflict",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_CONF != "Any other two-vehicle - different direction of travel configuration",
                                                   C_TRAF != "School bus stopped with school bus signal lights flashing",
                                                   C_TRAF != "Control device not specified") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLD == 1,
                                                   C_CONF != "Ran off left shoulder",
                                                   C_TRAF != "No passing zone sign",
                                                   C_TRAF != "Control device not specified") %>%
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(BICYCLISTxLT == 1,
                                                   P1_SAFE != "Other",
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Ran off left shoulder",
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Hit a parked motor vehicle",
                                                   C_WTHR != "Visibility limitation",
                                                   C_WTHR != "Unknown",
                                                   C_RALN != "Curved and level") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          #backcast_data.df %>% filter(BICYCLISTxHV == 1) %>% dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLD == 1,
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_WTHR != "Freezing rain, sleet, hail",
                                                   C_WTHR != "Strong wind") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxLT == 1,
                                                   P1_SAFE != "Vehicle not Equiped",
                                                   P1_SAFE != "Other",
                                                   C_CONF != "Ran off right shoulder",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_CONF != "Other Single Vehicle",
                                                   C_CONF != "Side swipe",
                                                   C_CONF != "Any other two vehicle - same direction of travel configuration",
                                                   C_RCFG != "Ramp",
                                                   C_RCFG != "Unknown",
                                                   C_RCFG != "Other",
                                                   C_TRAF != "Yield sign",
                                                   C_WTHR != "Snowing, not including drifting snow",
                                                   C_RALN != "Top of hill or gradient",
                                                   C_MNTH != "December") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV),
                                          #**********************************#
                                          backcast_data.df %>% 
                                            filter(MOTORCYCLISTxHV == 1, 
                                                   P1_SAFE != "Safety Device",
                                                   C_CONF != "Approaching side-swipe",
                                                   C_CONF != "Right turn, including turning conflicts",
                                                   C_RCFG != "Bridge/Overpass/Viaduct",
                                                   C_RCFG != "Intersection with Entrance",
                                                   C_RCFG != "Other",
                                                   C_WTHR != "Strong wind",
                                                   C_RSUR != "Sand/Gravel/Dirt",
                                                   C_MNTH != "November") %>% 
                                            droplevels() %>% 
                                            dplyr::select(P_ISEV, P1_USER, xLD, xLT, xHV)),
                                    Model = "Model 4 Ensemble") %>%
  mutate(P_ISEV_mod = factor(P_ISEV_mod,
                             levels = c("1", "2", "3"),
                             labels = c("No Injury", "Injury", "Fatality"),
                             ordered = TRUE))
```

```{r backcast-classes-collect-results, include=FALSE}
backcast.preds <- rbind(P_ISEV_mod1,
                        P_ISEV_mod2,
                        P_ISEV_mod3,
                        P_ISEV_mod4,
                        P_ISEV_mod1_ensemble,
                        P_ISEV_mod3_ensemble,
                        P_ISEV_mod2_ensemble,
                        P_ISEV_mod4_ensemble) %>%
  mutate(Model = factor(Model,
                        levels = c("Model 1", "Model 2", "Model 3", "Model 4", 
                                   "Model 1 Ensemble", "Model 2 Ensemble", "Model 3 Ensemble", "Model 4 Ensemble"),
                        labels = c("Model 1", "Model 2", "Model 3", "Model 4", 
                                   "Model 1 Ensemble", "Model 2 Ensemble", "Model 3 Ensemble", "Model 4 Ensemble")))
```

```{r backcast-outcomes-assessment, echo=FALSE, cache=TRUE}
backcast_verification <- rbind(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")),
      xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble"))) %>%
  data.frame(pc = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$pc * 100, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$pc * 100, 3)),
             pc2 = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$pc2 * 100,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$pc2 * 100),
             bias = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$bias,
                      multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$bias),
             ts = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$ts,
                    multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$ts),
             f = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$f,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$f),
             h = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$h,
                   multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$h),
             FAR = c(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$false.alarm.ratio,
                     multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$false.alarm.ratio),
             hss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$hss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$hss, 3)),
             pss = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$pss, 3),
                     rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$pss, 3)),
             gs = c(rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 1 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 2 Ensemble")))$gs, 3),
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 3 Ensemble")))$gs, 3) - 0.0001,#small adjustment for presentation in table
                    rep(multi.cont(xtabs(~ P_ISEV_mod + P_ISEV, data = backcast.preds %>% filter(Model == "Model 4 Ensemble")))$gs, 3))) %>%
  rownames_to_column() %>%
  remove_rownames() %>%
  rename(Outcome = rowname) %>%
  mutate(Outcome = rep(c("No Injury", "Injury", "Fatality"), 8) %>% 
           factor(levels = c("No Injury", "Injury", "Fatality"),
                  labels = c("No Injury", "Injury", "Fatality"),
                  ordered = TRUE))
  

# Find best, second best, worst scores for all the verification statistics

# First, set the following option so that summarize does not round by significant digits in the next few lines of code
options(pillar.sigfig = 10)

# Find the scores for percentage correct (pc)
max_pc <- backcast_verification %>% arrange(pc) %>% slice(24) %>% select(pc)
second_pc <- backcast_verification %>% arrange(pc) %>% slice(21) %>% select(pc)
min_pc <- backcast_verification %>% arrange(pc) %>% slice(1) %>% select(pc)

# Find the scores for percentage correct by class (pc2)
max_pc2 <- backcast_verification %>% arrange(Outcome, pc2) %>% slice(c(8, 16, 24)) %>% select(pc2)
second_pc2 <- backcast_verification %>% arrange(Outcome, pc2) %>% slice(c(7, 15, 23)) %>% select(pc2)
min_pc2 <- backcast_verification %>% arrange(Outcome, pc2) %>% slice(c(1, 9, 17)) %>% select(pc2)

# Find the scores for bias (bias)
max_bias <- backcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(8, 16, 24)) %>% select(bias)
second_bias <- backcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(2, 10, 18)) %>% select(bias)
min_bias <- backcast_verification %>% mutate(bias2 = abs(bias - 1)) %>% arrange(Outcome, bias2) %>% slice(c(1, 9, 17)) %>% select(bias)

# Find the scores for critical success index (ts)
max_ts <- backcast_verification %>% arrange(Outcome, ts) %>% slice(c(8, 16, 24)) %>% select(ts)
second_ts <- backcast_verification %>% arrange(Outcome, ts) %>% slice(c(7, 15, 23)) %>% select(ts)
min_ts <- backcast_verification %>% arrange(Outcome, ts) %>% slice(c(1, 9, 17)) %>% select(ts)

# Find the scores for probability of false detection (f)
max_f <- backcast_verification %>% arrange(Outcome, f) %>% slice(c(8, 16, 24)) %>% select(f)
second_f <- backcast_verification %>% arrange(Outcome, f) %>% slice(c(2, 10, 18)) %>% select(f)
min_f <- backcast_verification %>% arrange(Outcome, f) %>% slice(c(1, 9, 17)) %>% select(f)

# Find the scores for probability of detection (h)
max_h <- backcast_verification %>% arrange(Outcome, h) %>% slice(c(8, 16, 24)) %>% select(h)
second_h <- backcast_verification %>% arrange(Outcome, h) %>% slice(c(7, 15, 23)) %>% select(h)
min_h <- backcast_verification %>% arrange(Outcome, h) %>% slice(c(1, 9, 17)) %>% select(h)

# Find the scores for false alarm ratio (FAR)
max_FAR <- backcast_verification %>% arrange(Outcome, FAR) %>% slice(c(8, 16, 24)) %>% select(FAR)
second_FAR <- backcast_verification %>% arrange(Outcome, FAR) %>% slice(c(2, 10, 18)) %>% select(FAR)
min_FAR <- backcast_verification %>% arrange(Outcome, FAR) %>% slice(c(1, 9, 17)) %>% select(FAR)

# Find the scores for Heidke skill score (hss)
max_hss <- backcast_verification %>% arrange(hss) %>% slice(24) %>% select(hss)
second_hss <- backcast_verification %>% arrange(hss) %>% slice(21) %>% select(hss)
min_hss <- backcast_verification %>% arrange(hss) %>% slice(1) %>% select(hss)

# Find the scores for Peirce skill score (pss)
max_pss <- backcast_verification %>% arrange(pss) %>% slice(24) %>% select(pss)
second_pss <- backcast_verification %>% arrange(pss) %>% slice(21) %>% select(pss)
min_pss <- backcast_verification %>% arrange(pss) %>% slice(1) %>% select(pss)

# Find the scores for Gerrity score (gs)
max_gs <- backcast_verification %>% arrange(gs) %>% slice(24) %>% select(gs)
second_gs <- backcast_verification %>% arrange(gs) %>% slice(21) %>% select(gs)
min_gs <- backcast_verification %>% arrange(gs) %>% slice(1) %>% select(gs)

backcast_verification %>%
  mutate(pc = cell_spec(round(pc, digits = 2),
                        "latex", 
                        bold = ifelse(pc == max_pc[1,1], TRUE, FALSE),
                        underline = ifelse(pc == second_pc[1,1], TRUE, FALSE),
                        color = ifelse(pc == min_pc[1,1], "red", "black")),
         pc2 = cell_spec(round(pc2, digits = 2),
                         "latex",
                         bold = ifelse(pc2 %in% max_pc2[,1], TRUE, FALSE),
                         underline = ifelse(pc2 %in% second_pc2[,1], TRUE, FALSE),
                         color = ifelse(pc2 %in% min_pc2[,1], "red", "black")),
         bias = cell_spec(round(bias, digits = 4),
                         "latex",
                         bold = ifelse(bias %in% min_bias[,1], TRUE, FALSE),
                         underline = ifelse(bias %in% second_bias[,1], TRUE, FALSE),
                         color = ifelse(bias %in% max_bias[,1], "red", "black")),
         ts = cell_spec(round(ts, digits = 4),
                         "latex",
                         bold = ifelse(ts %in% max_ts[,1], TRUE, FALSE),
                         underline = ifelse(ts %in% second_ts[,1], TRUE, FALSE),
                         color = ifelse(ts %in% min_ts[,1], "red", "black")),
         f = cell_spec(round(f, digits = 4),
                         "latex",
                         bold = ifelse(f %in% min_f[,1], TRUE, FALSE),
                         underline = ifelse(f %in% second_f[,1], TRUE, FALSE),
                         color = ifelse(f %in% max_f[,1], "red", "black")),
         h = cell_spec(round(h, digits = 4),
                         "latex",
                         bold = ifelse(h %in% max_h[,1], TRUE, FALSE),
                         underline = ifelse(h %in% second_h[,1], TRUE, FALSE),
                         color = ifelse(h %in% min_h[,1], "red", "black")),
         FAR = cell_spec(round(FAR, digits = 4),
                         "latex",
                         bold = ifelse(FAR %in% min_FAR[,1], TRUE, FALSE),
                         underline = ifelse(FAR %in% second_FAR[,1], TRUE, FALSE),
                         color = ifelse(FAR %in% max_FAR[,1], "red", "black")),
         hss = cell_spec(round(hss, digits = 4),
                        "latex", 
                        bold = ifelse(hss == max_hss[1,1], TRUE, FALSE),
                        underline = ifelse(hss == second_hss[1,1], TRUE, FALSE),
                        color = ifelse(hss == min_hss[1,1], "red", "black")),
         pss = cell_spec(round(pss, digits = 4),
                        "latex", 
                        bold = ifelse(pss == max_pss[1,1], TRUE, FALSE),
                        underline = ifelse(pss == second_pss[1,1], TRUE, FALSE),
                        color = ifelse(pss == min_pss[1,1], "red", "black")),
         gs = cell_spec(round(gs, digits = 4),
                        "latex", 
                        bold = ifelse(gs == max_gs[1,1], TRUE, FALSE),
                        underline = ifelse(gs == second_gs[1,1], TRUE, FALSE),
                        color = ifelse(gs == min_gs[1,1], "red", "black"))) %>%
  kable(digits = 4,
        booktabs = TRUE,
        escape = FALSE,
        col.names = linebreak(c("Outcome",
                                "No Injury",
                                "Injury",
                                "Fatality",
                                "Percent\nCorrect",
                                "Percent\nCorrect\nby Class",
                                "Bias$^1$",
                                "Critical\nSuccess\nIndex$^2$",
                                "Probability of\nFalse\nDetection$^3$",
                                "Probability\nof\nDetection$^4$",
                                "False\nAlarm\nRatio$^5$",
                                "Heidke\nSkill\nScore$^6$",
                                "Peirce\nSkill\nScore$^7$",
                                "Gerrity\nScore$^8$")),
        caption = "\\label{tab:backcast-outcomes-assessment}Assessment of out-of-sample outcomes (backcasting using 2016 data set)") %>%
  kable_styling(font_size = 7, latex_options = c("scale_down")) %>%
  add_header_above(c("Predicted" = 1, "Observed Outcome" = 3, "Verification Statistics" = 10)) %>%
  collapse_rows(columns = c(5, 12:14), latex_hline = "major", valign = "middle") %>%
  pack_rows("Model 1. Single-level/No opponent", 1, 3) %>% 
  pack_rows("Model 2. Single-level/Opponent attributes", 4, 6) %>%
  pack_rows("Model 3. Hierarchical: Traffic unit", 7, 9) %>%
  pack_rows("Model 4. Hierarchical: Opponent", 10, 12) %>%
  pack_rows("Model 1 Ensemble. Single-level/No opponent", 13, 15) %>%
  pack_rows("Model 2 Ensemble. Single-level/Opponent attributes", 16, 18) %>%
  pack_rows("Model 3 Ensemble. Hierarchical: Traffic unit", 19, 21) %>% 
  pack_rows("Model 4 Ensemble. Hierarchical: Opponent", 22, 24) %>% 
  kable_styling(latex_options = c("scale_down")) %>%
  footnote(general = "Bold numbers: best scores; underlined numbers: second best scores; red numbers: worst scores",
           number = c("$B>1$: class is overpredicted; $B<1$: class is underpredicted; ",
                      "$CSI = 1$: perfect score; $CSI = 0$: no skill; ",
                      "$F = 0$: perfect score; ",
                      "$POD = 1$: perfect score; ",
                      "$FAR = 0$: perfect score; ",
                      "$HSS = 1$: perfect score; $HSS = 0$: no skill; $HSS < 0$: random is better; ",
                      "$PSS = 1$: perfect score; $PSS = 0$: no skill; ",
                      "$GS = 1$: perfect score; $GS = 0$: no skill."),
           escape = FALSE)
```

<!---
Best model {#sec:insights}
============

Create a table with the results of Model 2.
```{r model-2-output, echo=FALSE, cache=TRUE, eval=FALSE}

data.frame(coef(summary(mod2)), 
           pval = pnorm(abs(coef(summary(mod2))[, "t value"]), lower.tail = FALSE) * 2) %>%
  rownames_to_column(var = "Variable") %>%
  mutate(Variable = c("Age of person",
                      "Age of person (squared)",
                      "Sex of person: Male",
                      "Use of safety devices: Safety device used (ref:No safety device)",
                      "Use of safety devices: Helmet (ref:No safety device)",
                      "Use of safety devices: Reflective clothing (ref:No safety device)",
                      "Use of safety devices: Other (ref:No safety device)",
                      "Use of safety devices: Vehicle not equipped (ref:No safety device)",
                      "Use of safety devices: Not applicable (ref:No safety device)",
                      "Use of safety devices: Unknown (ref:No safety device)",
                      "Passenger (ref:Driver)",
                      "Pedestrian (ref:Driver)",
                      "Bicyclist (ref:Driver)",
                      "Motorcyclist (ref:Driver)",
                      "Vehicle Type: Light truck (ref:Light duty vehicle)",
                      "Vehicle Type: Heavy vehicle (ref:Light duty vehicle)",
                      "Age of opponent",
                      "Age of opponent (squared)",
                      "Sex of opponent: Male",
                      "Opponent: Light duty vehicle (ref:Pedestrian/Bicyclist/Motorcyclist)",
                      "Opponent: Light truck (ref:Pedestrian/Bicyclist/Motorcyclist)",
                      "Opponent: Heavy vehicle (ref:Pedestrian/Bicyclist/Motorcyclist)",
                      "Hit a stationary object",
                      "Ran off left shoulder",
                      "Ran off right shoulder",
                      "Rollover on roadway",
                      "Single vehicle",
                      "Rear-end collision",
                      "Side swipe",
                      "Passing to the left or left turn conflict",
                      "Passing to the right or right turn conflict",
                      "Any other two-vehicle, same direction of travel",
                      "Head-on collision",
                      "Approaching side swipe",
                      "Left turn across opposing traffic",
                      "Right turn, including turning conflicts",
                      "Right angle collision",
                      "Any other two-vehicle, different direction of travel",
                      "Hit a parked motor vehicle",
                      "Other",
                      "Unknown",
                      "Intersection",
                      "Intersection with entrance",
                      "Railroad level crossing",
                      "Bridge/Overpass/Viaduct",
                      "Tunnel/Underpass",
                      "Passing or climbing lane",
                      "Ramp",
                      "Traffic circle",
                      "Freeway express lane",
                      "Other",
                      "Unknown",
                      "Overcast, cloudy, no precipitation",
                      "Raining",
                      "Snowing, not including drifting snow",
                      "Freezing rain, sleet, hail",
                      "Visibility limitation",
                      "Strong wind",
                      "Other",
                      "Unknown",
                      "Wet",
                      "Fresh loose snow",
                      "Slush/Wet snow",
                      "Icy",
                      "Sand/Gravel/Dirt",
                      "Muddy",
                      "Oil",
                      "Flooded",
                      "Other",
                      "Unknown",
                      "Straight with gradient",
                      "Curved and level",
                      "Curved with gradient",
                      "Top of hill or gradient",
                      "Bottom of hill or gradient",
                      "Other",
                      "Unknown",
                      "Flashing Traffic",
                      "Stop sign",
                      "Yield sign",
                      "Warning sign",
                      "Pedestrian crosswalk",
                      "Police officer",
                      "School guard",
                      "School crossing",
                      "Reduced speed zone",
                      "No passing zone sign",
                      "Markings on the road",
                      "School bus stopped flashing lights",
                      "Railway crossing with signals or signals and gates",
                      "Railway crossing with signs only",
                      "Control device not specified",
                      "No control present",
                      "Other",
                      "Unknown",
                      "February",
                      "March",
                      "April",
                      "May",
                      "June",
                      "July",
                      "August",
                      "September",
                      "October",
                      "November",
                      "December",
                      "Threshold: No Injury | Injury",
                      "Threshold: Injury | Fatality")) %>%
  filter(pval <= 0.1) %>%
  mutate(pval = ifelse(pval < 0.0001, "< 0.0001", format(round(pval, digits = 4), scientific = FALSE))) %>%
  kable(booktabs = TRUE,
        digits = 4,
        longtable = TRUE,
        escape = FALSE,
        col.names = c("Variable", "Coefficient", "Std Error", "t-value", "p-value"),
        caption = "\\label{tab:best-model}Best model: Model 2 (table omits coefficients with p > 0.10)") %>%
  kable_styling(font_size = 7, latex_options = c("striped")) %>%
  pack_rows("Individual-level variables", 1, 13) %>%
  pack_rows("Opponent variables", 14, 19) %>%
  pack_rows("Collision-level variables: Crash configuration (ref:Hit a moving object)", 20, 37) %>%
  pack_rows("Collision-level variables: Road configuration (ref:Non-intersection)", 38, 42) %>%
  pack_rows("Collision-level variables: Weather (ref:Clear and sunny)", 43, 47) %>%
  pack_rows("Collision-level variables: Surface (ref:Dry)", 48, 50)  %>%
  pack_rows("Collision-level variables: Road alignment (ref:Straight and level)", 51, 52) %>%
  pack_rows("Collision-level variables: Traffic controls (ref:Operational traffic signals)", 53, 59) %>%
  pack_rows("Thresholds", 60, 61)
```

--->

Further considerations {#sec:further-considerations}
============

As discussed in Section \ref{sec:methods}, there is a rich selection of modelling approaches that are applicable to crash severity analysis. Based on the literature, we limited our empirical assessment of modelling strategies to only one model, namely the ordinal logit. On the other hand, since the modelling strategies discussed here all relate to the specification of the latent function and data subsetting, it is a relatively simple matter to extend them to other modelling approaches. For example, take Expression \ref{eq:latent-function-with-opponent-variables} and add a random component $\mu_{k}$ as follows:

\begin{equation}
\label{eq:latent-function-with-opponent-variables-and-random-component}
y_{itk}^*=\sum_{l=1}^L\alpha_lp_{itkl} + \sum_{m=1}^M\beta_mu_{tkm} + \sum_{q=1}^Q\kappa_qc_{kq} + \sum_{r=1}^R\delta_ro_{jvkr} + \mu_{k} + \epsilon_{itk}
\end{equation}

The addition of the random component in this fashion would help to capture, when appropriate, unobserved heterogeneity at the level of the crash [this is similar to the random intercepts approach in multi-level modelling; also see @Mannering2016unobserved]. As a second example, take Expressions \ref{eq:latent-function-with-hierarchical-traffic-unit} to \ref{eq:hierarchical-traffic-unit-coefficients} and add a random component to a hierarchical coefficient, to obtain:

\begin{equation}
\label{eq:hierarchical-traffic-unit-coefficients-with-random-component}
\begin{array}{rcl}\
\beta_{m}u_{tkm} &=& \big( \beta_{m1} + \beta_{m2}p_{itk2} + \cdots + \beta_{mL}p_{itkL} + \mu_{mk}\big)u_{tkm}\\ 
&=& \beta_{m1}u_{tkm} + \beta_{m2}p_{itk2}u_{tkm} + \cdots + \beta_{mL}p_{itkL}u_{tkm} + \mu_{mk}u_{tkm}
\end{array}
\end{equation}

This is similar to the random slopes strategy in multi-level modelling.

We do not report results regarding other modelling strategies. On the one hand, more sophisticated modelling frameworks are generally capable of improving the performance of a model. On the other hand, there are well-known challenges in the estimation of more sophisticated models [see @Lenguerrand2006modelling, p. 47, for a discussion of convergence issues in models with mixed effects; @Mannering2016unobserved, p.13, for some considerations regarding the complexity and cost of estimating more complex models; and @Bogue2017modified, p. 27, on computational demands of models with random components]. The additional cost and complexity of more sophisticated modelling approaches would, in our view, have greatly complicated our empirical assessment, particularly considering the large size of the sample involved in this research (a data set with over 164,000 records in the case of the full sample models). That said, we experimented with a model with random components using monthly subsets of data to find that, indeed, estimation takes considerably longer, is more demanding in terms of fixing potential estimation quirks, and in the end resulted in variance components that could not be reliably estimated as different from zero (results can be consulted in the source R Notebook). For this reason, we choose to leave the application of more sophisticated models as a matter for future research.

<!--
model with random coefficients

This is a test of the `ordinal` package. Hierarchical or mixed models do not work well with large samples. I can subsample based on month? What is the distribution of crashes by month?
```{r eval=FALSE}
ggplot(data = crash_data.df, aes(x = C_MNTH)) + geom_bar()
```

Estimate the model as follows, filtering by month:
```{r cache = TRUE, eval=FALSE}
mod_2_rand <- clmm2(location = P_ISEV ~
                                  # INDIVIDUAL-LEVEL VARIABLES
                                  P1_AGE + 
                                  P1_AGE2 + 
                                  P1_SEX + 
                                  P1_SAFE +
                                  # TRAFFIC UNIT-LEVEL VARIABLES
                                  PASSENGER1 + 
                                  PEDESTRIAN1 +
                                  BICYCLIST1 +
                                  MOTORCYCLIST1 +
                                  LT +
                                  HV +
                                  # OPPONENT ATTRIBUTES
                                  P2_AGE + 
                                  P2_AGE2 +
                                  P2_SEX +
                                  xLD +
                                  xLT +
                                  xHV +
                                  # CASE-LEVEL VARIABLES
                                  C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF,
                    random = C_CASE,
                                data = filter(crash_data.df, C_MNTH == "January"),
                                Hess = TRUE,
                                link = "logistic")
```

Take a peek at the model:
```{r eval=FALSE}
summary(mod_2_rand)
```

Another model: create a dataframe with the variables needed for estimation of the initial model. Notice that I wish to use age by role of participant 1:
```{r eval=FALSE}
crash_data.df <- ncdb_2017_paired_records %>%
  transmute(P_ISEV,
            # AGE
            DRIVER1_AGE = P1_AGE * (P1_USER == "Driver"),
            PASSENGER1_AGE = P1_AGE * (P1_USER == "Passenger"),
            PEDESTRIAN1_AGE = P1_AGE * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE = P1_AGE * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE = P1_AGE * (P1_USER == "Motorcyclist"),
            DRIVER1_AGE2 = P1_AGE^2 * (P1_USER == "Driver"),
            PASSENGER1_AGE2 = P1_AGE^2 * (P1_USER == "Passenger"),
            PEDESTRIAN1_AGE2 = P1_AGE^2 * (P1_USER == "Pedestrian"),
            BICYCLIST1_AGE2 = P1_AGE^2 * (P1_USER == "Bicyclist"),
            MOTORCYCLIST1_AGE2 = P1_AGE^2 * (P1_USER == "Motorcyclist"),
            # DRIVER: VEHICLE TYPE
            DRIVER1_VEHICLE_LT = P1_TYPE == "Driver: Light Truck",
            DRIVER1_VEHICLE_HV = P1_TYPE == "Driver: Heavy Vehicle",
            # PASSENGER: VEHICLE TYPE
            PASSENGER1_VEHICLE_LT = P1_TYPE == "Passenger: Light Truck",
            PASSENGER1_VEHICLE_HV = P1_TYPE == "Passenger: Heavy Vehicle",
            # CRASH-LEVEL VARIABLES
            C_CONF,
            C_RCFG,
            C_WTHR,
            C_RSUR,
            C_RALN,
            C_TRAF,
            C_MNTH,
            C_CASE)
```

Estimate initial model after filtering by month:
```{r eval=FALSE}
mod0 <- clmm2(P_ISEV ~ 
                DRIVER1_AGE + DRIVER1_AGE2 +
                PEDESTRIAN1_AGE + PEDESTRIAN1_AGE2 +
                BICYCLIST1_AGE + BICYCLIST1_AGE2 +
                MOTORCYCLIST1_AGE + MOTORCYCLIST1_AGE2 +
                C_CONF + C_RCFG + C_WTHR + C_RSUR + C_RALN + C_TRAF, 
              random = C_CASE, 
              data = filter(crash_data.df, C_MNTH == "June"), 
              Hess = TRUE,
              method = "nlminb")
```

Summarize the results:
```{r eval=FALSE}
summary(mod0)
```

Notice that the variance of the random effect is effectively zero (I tested this for Jan-June), which explains the NaN in the estimates. When the variance cannot be reliable estimated as different from zero, dropping the mixed effect makes sense [see @Lenguerrand2006modelling, p. 47, for a discussion of convergence issues in models with mixed effects].
-->

Concluding remarks {#sec:concluding-remarks}
============

The study of crash severity is an important component of accident research, as seen from a large and vibrant literature and numerous applications. Part of this literature covers different modelling strategies that can be used to model complex hierarchical, multievent outcomes such as the severity of injuries following a collision. In this paper, our objective has been to assess the performance of different strategies to model opponent effects in two-vehicle crashes. In broad terms, three strategies were considered: 1) incorporating opponent-level variables in the model; 2) single- versus multi-level model specifications; and 3) sample subsetting and estimation of separate models for different types of individual-opponent interactions. The empirical evaluation was based on data from Canada's National Crash Database and the application of ordered probit models. A suite of models that implemented the various strategies considered was estimated using data from 2017. We then assessed the performance of the models using one information criterion (AIC). Furthermore, the predictive performance of the models was assessed in terms of both nowcasting (in-sample predictions) and backcasting (out-of-sample predictions), the latter using data from 2016.

The results of the empirical assessment strongly suggest that incorporating opponent effects can greatly improve the goodness-of-fit and predictive performance of a model. Two modelling strategies appear to outperform the rest: a relatively simple single-level modelling approach that incorporates opponent effects, and a hierarchical modelling approach with nested opponent effects. There was some evidence that subsetting the sample can improve the results in some cases (e.g., when modelling the severity of crashes involving active travelers or motorcyclists), but possibly at the risk of overfitting the process. It is well known that overfitting can increase the accuracy of in-sample predictions at the expense of bias in out-of-sample predictions. Alas, since the true data generating process is unknowable in this empirical research, it is not possible to assess the extent of estimator bias. It is also worthwhile noting that in this paper we did not compare individual models in our ensemble approach, but we suggest that this is an avenue for future research.

The results of this research should be informative to analysts interested in crashes involving two parties, since it provides some useful guidelines regarding the specification of opponent effects. Not only do opponent effects improve the goodness of fit and performance of models, they also add rich insights into their effects. The focus on this paper was on performance, and for space reasons it is not possible to include an examination of the best model without failing to do it justice. We plan to report the results of the best-fitting model in a future paper.

The analysis also opens up a few avenues for future research. First, for reasons discussed in Section \ref{sec:further-considerations}, we did not consider more sophisticated modelling approaches, such as models with random components, partial proportional odds, ranked ordered models, or multinomial models, to mention just a few possibilities. Secondly, we only considered the performance of the models when making predictions for the full sample. That is, the submodels in the ensembles were not compared in detail, just their aggregate results when predicting the full sample. However, the goodness-of-fit was not uniformly better for any one modelling strategy when the data were subset, and it is possible that individual models perform better for a certain subset than competitors that are part of a better ensemble, overall. For this reason, we suggest that additional work with ensemble approaches is warranted. Finally, it is clear that the models do not generally do well when predicting the least frequent class of outcome, namely Fatality. It would be worthwhile to further investigate approaches for so-called imbalanced learning, a task that has received attention in the machine learning community [e.g., @Haixiang2017learning; @He2009learning], and where Torrao et al. [-@Torrao2014modeling] have already made some headway in crash severity analysis.

Finally, as an aside, this paper is, to the best of our knowledge, the first example of reproducible research in crash severity analysis. By providing the data _and_ code for the analysis, it is our hope that this will allow other researchers to easily verify the results, and to extend them. A common practice in the machine learning community is to use canonical data set to demonstrate the performance of new techniques. Sharing code and data has remained relatively rare in transportation research, and we would like to suggest that the data sets used in this research could constitute one such canonical data set for future methodological developments.

Acknowledgments {#acknowledgments .unnumbered}
==========

This research was supported by a Research Excellence grant from McMaster University. The authors wish to express their gratitude to the Office of the Provost, the Faculty of Science, and the Faculty of Engineering for their generous support. The comments of four anonymous reviewers are also duly acknowledged: their feedback helped to improve the quality and clarity of presentation of this paper.

Appendix {#appendix .unnumbered}
==========

Variable definitions in Canada's National Collision Database.

```{r ncdb-descriptives-collision, echo=FALSE, cache=TRUE}
data.frame(Variable = c("C_CASE",
                        "C_YEAR",
                        "C_MNTH",
                        "C_WDAY",
                        "C_HOUR",
                        "C_SEV",
                        "C_VEHS",
                        "C_CONF",
                        "C_RCFG",
                        "C_WTHR",
                        "C_RSUR",
                        "C_RALN",
                        "C_TRAF"),
           Description = c("Unique collision identifier",
                           "Year",
                           "Month",
                           "Day of week",
                           "Collision hour",
                           "Collision severity",
                           "Number of vehicles involved in collision",
                           "Collision configuration",
                           "Roadway configuration",
                           "Weather condition",
                           "Road surface",
                           "Road alignment",
                           "Traffic control"),
           Notes = c("Unique identifier for collisions",
                     "Last two digits of year.",
                     "14 levels: January - December; unknown; not reported by jurisdiction.",
                     "9 levels: Monday - Sunday; unknown; not reported by jurisdiction.",
                     "25 levels: hourly intervals; unknown; not reported by jurisdiction.",
                     "4 levels: collision producing at least one fatality; collision producing non-fatal injury; unknown; not reported by jurisdiction.",
                     "Number of vehicles: 1-98 vehicles involved; 99 or more vehicles involved; unknown; not reported by jurisdiction.",
                     "21 levels: SINGLE VEHICLE: Hit a moving object (e.g. a person or an animal); Hit a stationary object (e.g. a tree); Ran off left shoulder; Ran off right shoulder; Rollover on roadway; Any other single vehicle collision configuration; TWO-VEHICLES SAME DIRECTION OF TRAVEL: Rear-end collision; Side swipe; One vehicle passing to the left of the other, or left turn conflict; One vehicle passing to the right of the other, or right turn conflict; Any other two vehicle - same direction of travel configuration; TWO-VEHICLES DIFFERENT DIRECTION OF TRAVEL: Head-on collision; Approaching side-swipe; Left turn across opposing traffic; Right turn, including turning conflicts; Right angle collision; Any other two-vehicle - different direction of travel configuration; TWO-VEHICLES, HIT A PARKED VEHICLE: Hit a parked motor vehicle; Choice is other than the preceding values; unknown;not reported by jurisdiction.",
                     "15 levels: Non-intersection; At an intersection of at least two public roadways; Intersection with parking lot entrance/exit, private driveway or laneway; Railroad level crossing; Bridge, overpass, viaduct; Tunnel or underpass; Passing or climbing lane; Ramp; Traffic circle; Express lane of a freeway system; Collector lane of a freeway system; Transfer lane of a freeway system; Choice is other than the preceding values; unknown;not reported by jurisdiction.",
                     "10 levels: Clear and sunny; Overcast, cloudy but no precipitation; Raining; Snowing, not including drifting snow; Freezing rain, sleet, hail; Visibility limitation; Strong wind; Choice is other than the preceding values; unknown;not reported by jurisdiction.",
                     "12 levels: Dry, normal; Wet; Snow (fresh, loose snow); Slush, wet snow; Icy, packed snow; Debris on road (e.g., sand/gravel/dirt); Muddy; Oil; Flooded; Choice is other than the preceding values; unknown;not reported by jurisdiction.",
                     "9 levels: Straight and level; Straight with gradient; Curved and level; Curved with gradient; Top of hill or gradient; Bottom of hill or gradient; Choice is other than the preceding values; unknown;not reported by jurisdiction.",
                     "21 levels: Traffic signals fully operational; Traffic signals in flashing mode; Stop sign; Yield sign; Warning sign; Pedestrian crosswalk; Police officer; School guard, flagman; School crossing; Reduced speed zone; No passing zone sign; Markings on the road; School bus stopped with school bus signal lights flashing; School bus stopped with school bus signal lights not flashing; Railway crossing with signals, or signals and gates; Railway crossing with signs only; Control device not specified; No control present; Choice is other than the preceding values; unknown; not reported by jurisdiction.")) %>%
  kable(booktabs = TRUE,
        longtable = TRUE,
        caption = "\\label{tab:ncdb-descriptives-collision}Contents of National Collision Database: Collision-level variables") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "repeat_header")) %>%
  column_spec(3, width = "32em") %>%
  footnote(general = c("Source NCDB available from https://open.canada.ca/data/en/data set/1eb9eba7-71d1-4b30-9fb1-30cbdab7e63a",
                       "Source data files for analysis also available from https://drive.google.com/open?id=12aJtVBaQ4Zj0xa7mtfqxh0E48hKCb_XV"))
```

```{r ncdb-descriptives-vehicle, echo=FALSE, cache=TRUE}
data.frame(Variable = c("V_ID",
                        "V_TYPE",
                        "V_YEAR"),
           Description = c("Vehicle sequence number",
                           "Vehicle type",
                           "Vehicle model year"),
           Notes = c("Number of vehicles: 1-98; Pedestrian sequence number: 99; unknown.",
                     "21 levels: Light Duty Vehicle (Passenger car, Passenger van, Light utility vehicles and light duty pick up trucks); Panel/cargo van (<= 4536 KG GVWR	Panel or window type of van designed primarily for carrying goods); Other trucks and vans (<= 4536 KG GVWR); Unit trucks (> 4536 KG GVWR); Road tractor; School bus; Smaller school bus (< 25 passengers); Urban and Intercity Bus; Motorcycle and moped; Off road vehicles; Bicycle; Purpose-built motorhome; Farm equipment; Construction equipment; Fire engine; Snowmobile; Street car; Data element is not applicable	(e.g. dummy vehicle record created for pedestrian); Choice is other than the preceding values; unknown; not reported by jurisdiction.",
                     "Model year; dummy for pedestrians; unknown; not reported by jurisdiction.")) %>%
  kable(booktabs = TRUE,
        longtable = TRUE,
        caption = "\\label{tab:ncdb-descriptives-vehicle}Contents of National Collision Database: Traffic unit-level variables") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "repeat_header")) %>%
  column_spec(3, width = "32em") %>%
  footnote(general = c("Source NCDB available from https://open.canada.ca/data/en/data set/1eb9eba7-71d1-4b30-9fb1-30cbdab7e63a",
                       "Source data files for analysis also available from https://drive.google.com/open?id=12aJtVBaQ4Zj0xa7mtfqxh0E48hKCb_XV"))
```

```{r ncdb-descriptives-person, echo=FALSE, cache=TRUE}
data.frame(Variable = c("P_ID",
                        "P_SEX",
                        "P_AGE",
                        "P_PSN",
                        "P_ISEV",
                        "P_SAFE",
                        "P_USER"),
           Description = c("Person sequence number",
                           "Person sex",
                           "Person age",
                           "Person position",
                           "Medical treatment required",
                           "Safety device used",
                           "Road user class"),
           Notes = c("Sequence number: 1-99; Not applicable (dummy for parked vehicles); not reported by jurisdiction.",
                     "5 levels: Male; Female; Not applicable (dummy for parked vehicles); unknown (runaway vehicle); not reported by jurisdiction.",
                     "Age: less than 1 year; 1-98 years old; 99 years or older; Not applicable (dummy for parked vehicles); unknown (runaway vehicle); not reported by jurisdiction.",
                     "Person position: Driver; Passenger front row, center; Passenger front row, right outboard (including motorcycle passenger in sidecar); Passenger second row, left outboard, including motorcycle passenger; Passenger second row, center; Passenger second row, right outboard; Passenger third row, left outboard;...; Position unknown, but the person was definitely an occupant; Sitting on someone’s lap; Outside passenger compartment; Pedestrian; Not applicable (dummy for parked vehicles); Choice is other than the preceding values; unknown (runaway vehicle); not reported by jurisdiction.",
                     "6 levels: No Injury; Injury; Fatality; Not applicable (dummy for parked vehicles); Choice is other than the preceding values; unknown (runaway vehicle); not reported by jurisdiction.",
                     "11 levels: No safety device used; Safety device used; Helmet worn; Reflective clothing worn; Both helmet and reflective clothing used; Other safety device used; No safety device equipped	(e.g. buses); Not applicable (dummy for parked vehicles); Choice is other than the preceding values; unknown (runaway vehicle); not reported by jurisdiction.",
                     "6 levels: Motor Vehicle Driver; Motor Vehicle Passenger; Pedestrian; Bicyclist; Motorcyclist; Not stated/Other/Unknown.")) %>%
  kable(booktabs = TRUE,
        longtable = TRUE,
        caption = "\\label{tab:ncdb-descriptives-person}Contents of National Collision Database: Personal-level variables") %>%
  kable_styling(font_size = 7, latex_options = c("striped", "repeat_header")) %>%
  column_spec(3, width = "32em") %>%
  footnote(general = c("Source NCDB available from https://open.canada.ca/data/en/data set/1eb9eba7-71d1-4b30-9fb1-30cbdab7e63a",
                       "Source data files for analysis also available from https://drive.google.com/open?id=12aJtVBaQ4Zj0xa7mtfqxh0E48hKCb_XV"))
```

References {#references .unnumbered}
==========
